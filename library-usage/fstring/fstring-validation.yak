// =============================================================================
// F-String è¯­æ³•éªŒè¯è„šæœ¬ - æ£€æŸ¥å’Œä¿®å¤ Yaklang f-string ç”¨æ³•
// åŠŸèƒ½: æ‰«ææ‰€æœ‰ yak æ–‡ä»¶ï¼Œæ£€æŸ¥ f-string è¯­æ³•æ˜¯å¦æ­£ç¡®
// ç”¨é€”: è¯­æ³•éªŒè¯ã€é”™è¯¯æ£€æµ‹ã€è‡ªåŠ¨ä¿®å¤ã€ä»£ç è´¨é‡ä¿è¯ã€AIè®­ç»ƒ
//
// æ ¸å¿ƒæŠ€æœ¯æ ˆ:
// - file.Glob: æ–‡ä»¶æ¨¡å¼åŒ¹é…ï¼Œé€’å½’æœç´¢ yak æ–‡ä»¶
// - file.ReadFile: è¯»å–æ–‡ä»¶å†…å®¹è¿›è¡Œè¯­æ³•æ£€æŸ¥
// - re.FindAll: æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… f-string æ¨¡å¼
// - str.Contains: å­—ç¬¦ä¸²åŒ…å«æ£€æŸ¥ï¼ŒéªŒè¯è¯­æ³•æ­£ç¡®æ€§
// - file.WriteFile: å†™å…¥ä¿®å¤åçš„æ–‡ä»¶å†…å®¹
//
// F-String è¯­æ³•è§„åˆ™:
// âœ… æ­£ç¡®: f"${variable}" - ä½¿ç”¨ ${} è¿›è¡Œå˜é‡æ’å€¼
// âŒ é”™è¯¯: f"{variable}"  - ä¸èƒ½ä½¿ç”¨ {} è€Œå¿…é¡»ä½¿ç”¨ ${}
// âœ… æ­£ç¡®: f"Hello ${name}, age: ${age}"
// âŒ é”™è¯¯: f"Hello {name}, age: {age}"
//
// å…³é”®è¯: f-stringè¯­æ³•æ£€æŸ¥ å˜é‡æ’å€¼éªŒè¯ è¯­æ³•é”™è¯¯ä¿®å¤ ä»£ç è´¨é‡æ£€æŸ¥ Yaklangè¯­æ³•è§„èŒƒ
// æœç´¢æ ‡ç­¾: #fstring-validation #syntax-check #yaklang-fstring #variable-interpolation #syntax-fix
// AIæœç´¢è¯: f-stringè¯­æ³•æ£€æŸ¥ å˜é‡æ’å€¼é”™è¯¯ Yaklangå­—ç¬¦ä¸²æ¨¡æ¿ è¯­æ³•éªŒè¯è„šæœ¬ f-stringä¿®å¤
// AIå¸¸è§æœç´¢: f-stringè¯­æ³•é”™è¯¯ å˜é‡æ’å€¼è¯­æ³• å­—ç¬¦ä¸²æ¨¡æ¿éªŒè¯ f-stringæ­£ç¡®ç”¨æ³• è¯­æ³•æ£€æŸ¥å·¥å…·
// é”™è¯¯å…³é”®è¯: f"{}" è¯­æ³•é”™è¯¯ å˜é‡æ’å€¼é”™è¯¯ å­—ç¬¦ä¸²æ¨¡æ¿è¯­æ³•é”™è¯¯ f-stringæ ¼å¼åŒ–é”™è¯¯
// ä¿®å¤å…³é”®è¯: f-stringè¯­æ³•ä¿®å¤ å˜é‡æ’å€¼ä¿®å¤ å­—ç¬¦ä¸²æ¨¡æ¿ä¿®å¤ è¯­æ³•é”™è¯¯è‡ªåŠ¨ä¿®å¤
// =============================================================================

println("=== F-String è¯­æ³•éªŒè¯è„šæœ¬ ===")

// è·å–å½“å‰å·¥ä½œç›®å½• - ç¡®å®šæ‰«æèŒƒå›´
// å…³é”®è¯: å·¥ä½œç›®å½•è·å–, os.Getwd, ç›®å½•è·¯å¾„, æ‰«æèŒƒå›´ç¡®å®š
pwd, pwd_err = os.Getwd()
assert pwd_err == nil, f"è·å–å½“å‰ç›®å½•å¤±è´¥: ${pwd_err}"

println(f"æ‰«æç›®å½•: ${pwd}")

// æ”¶é›†æ‰€æœ‰ yak æ–‡ä»¶ - ä½¿ç”¨ filesys.Recursive é€’å½’æœç´¢
// å…³é”®è¯: filesys.Recursive, æ–‡ä»¶æ”¶é›†, é€’å½’æœç´¢, yakæ–‡ä»¶è¿‡æ»¤
allFiles = []

// ä½¿ç”¨ filesys.Recursive éå†ç›®å½•æ”¶é›† yak æ–‡ä»¶
// å…³é”®è¯: æ–‡ä»¶éå†, æ‰©å±•åè¿‡æ»¤, æ–‡ä»¶æ”¶é›†, é€’å½’æœç´¢
err = filesys.Recursive(pwd,
    filesys.onFileStat((path, info) => {
        // åªæ”¶é›† .yak æ–‡ä»¶
        // å…³é”®è¯: æ–‡ä»¶è¿‡æ»¤, æ‰©å±•ååˆ¤æ–­, yakæ–‡ä»¶ç­›é€‰
        if file.GetExt(path) == ".yak" {
            // æ’é™¤ç‰¹å®šç›®å½•
            // å…³é”®è¯: ç›®å½•æ’é™¤, è·¯å¾„è¿‡æ»¤, æ–‡ä»¶ç­›é€‰
            if !str.Contains(path, "/.git/") && 
               !str.Contains(path, "/node_modules/") && 
               !str.Contains(path, "/vendor/") {
                allFiles = append(allFiles, path)
            }
        }
        return nil
    })
)

assert err == nil, f"æ–‡ä»¶éå†å¤±è´¥: ${err}"

println(f"æ‰¾åˆ° ${len(allFiles)} ä¸ª yak æ–‡ä»¶")

// F-String è¯­æ³•æ£€æŸ¥ç»Ÿè®¡
// å…³é”®è¯: è¯­æ³•æ£€æŸ¥ç»Ÿè®¡, é”™è¯¯è®¡æ•°, æ­£ç¡®è®¡æ•°, æ–‡ä»¶ç»Ÿè®¡
totalFiles = 0
correctFiles = 0
errorFiles = 0
totalFStrings = 0
correctFStrings = 0
errorFStrings = 0
errorDetails = []

// å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ - æ£€æµ‹ f-string è¯­æ³•
// å…³é”®è¯: æ­£åˆ™è¡¨è¾¾å¼, f-stringæ¨¡å¼åŒ¹é…, è¯­æ³•æ£€æµ‹æ¨¡å¼
fStringPattern = `f"[^"]*"`                      // åŒ¹é…æ‰€æœ‰ f"..." å­—ç¬¦ä¸²
fStringSinglePattern = `f'[^']*'`                // åŒ¹é…æ‰€æœ‰ f'...' å­—ç¬¦ä¸²
errorCheckPattern = `\{[^$]`                     // æ£€æŸ¥æ˜¯å¦åŒ…å« {é$ çš„é”™è¯¯è¯­æ³•

println("\nå¼€å§‹æ£€æŸ¥ f-string è¯­æ³•...")

// éå†æ‰€æœ‰æ–‡ä»¶è¿›è¡Œè¯­æ³•æ£€æŸ¥
// å…³é”®è¯: æ–‡ä»¶éå†, è¯­æ³•æ£€æŸ¥å¾ªç¯, å†…å®¹åˆ†æ, é”™è¯¯æ£€æµ‹
for filePath in allFiles {
    totalFiles++
    
    // è¯»å–æ–‡ä»¶å†…å®¹ - file.ReadFile è¯»å–å®Œæ•´å†…å®¹
    // å…³é”®è¯: file.ReadFile, æ–‡ä»¶å†…å®¹è¯»å–, æ–‡æœ¬åˆ†æ
    content, read_err = file.ReadFile(filePath)
    if read_err != nil {
        println(f"è­¦å‘Š: æ— æ³•è¯»å–æ–‡ä»¶ ${filePath}: ${read_err}")
        continue
    }
    
    contentStr = string(content)
    hasError = false
    hasCorrect = false
    
    // æŸ¥æ‰¾æ‰€æœ‰ f-stringï¼ˆåŒå¼•å·ç‰ˆæœ¬ï¼‰
    // å…³é”®è¯: f-stringæŸ¥æ‰¾, åŒå¼•å·f-string, è¯­æ³•æ£€æµ‹
    doubleQuoteFStrings = re.FindAll(contentStr, fStringPattern)
    
    // æŸ¥æ‰¾æ‰€æœ‰ f-stringï¼ˆå•å¼•å·ç‰ˆæœ¬ï¼‰
    // å…³é”®è¯: f-stringæŸ¥æ‰¾, å•å¼•å·f-string, è¯­æ³•æ£€æµ‹
    singleQuoteFStrings = re.FindAll(contentStr, fStringSinglePattern)
    
    // æ£€æŸ¥åŒå¼•å· f-string
    // å…³é”®è¯: è¯­æ³•æ£€æŸ¥, é”™è¯¯æ£€æµ‹, åŒå¼•å·f-stringæ£€æŸ¥
    for fstr in doubleQuoteFStrings {
        if fstr != nil && fstr != "" {
            totalFStrings++
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«é”™è¯¯è¯­æ³• {é$
            // å…³é”®è¯: é”™è¯¯è¯­æ³•æ£€æµ‹, å˜é‡æ’å€¼æ£€æŸ¥, è¯­æ³•éªŒè¯
            if re.Match(errorCheckPattern, fstr) {
                hasError = true
                errorFStrings++
                
                // è®°å½•é”™è¯¯è¯¦æƒ…
                // å…³é”®è¯: é”™è¯¯è®°å½•, é”™è¯¯è¯¦æƒ…æ”¶é›†, ä¿®å¤ä¿¡æ¯å‡†å¤‡
                errorDetails = append(errorDetails, {
                    "file": filePath,
                    "error": fstr,
                    "type": "double_quote",
                    "line": -1
                })
            } else {
                hasCorrect = true
                correctFStrings++
            }
        }
    }
    
    // æ£€æŸ¥å•å¼•å· f-string
    // å…³é”®è¯: è¯­æ³•æ£€æŸ¥, é”™è¯¯æ£€æµ‹, å•å¼•å·f-stringæ£€æŸ¥
    for fstr in singleQuoteFStrings {
        if fstr != nil && fstr != "" {
            totalFStrings++
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«é”™è¯¯è¯­æ³• {é$
            if re.Match(errorCheckPattern, fstr) {
                hasError = true
                errorFStrings++
                
                // è®°å½•é”™è¯¯è¯¦æƒ…
                errorDetails = append(errorDetails, {
                    "file": filePath,
                    "error": fstr,
                    "type": "single_quote",
                    "line": -1
                })
            } else {
                hasCorrect = true
                correctFStrings++
            }
        }
    }
    
    // ç»Ÿè®¡æ–‡ä»¶çŠ¶æ€ - æ­£ç¡®ã€é”™è¯¯ã€æ··åˆçŠ¶æ€
    // å…³é”®è¯: æ–‡ä»¶çŠ¶æ€ç»Ÿè®¡, è¯­æ³•çŠ¶æ€åˆ†ç±», æ£€æŸ¥ç»“æœç»Ÿè®¡
    if hasError {
        errorFiles++
        println(f"âŒ é”™è¯¯: ${filePath}")
    } else if hasCorrect {
        correctFiles++
        println(f"âœ… æ­£ç¡®: ${filePath}")
    }
}

println("\n=== F-String è¯­æ³•æ£€æŸ¥ç»“æœ ===")

// è¾“å‡ºæ£€æŸ¥ç»Ÿè®¡ç»“æœ - è¯¦ç»†çš„æ£€æŸ¥æŠ¥å‘Š
// å…³é”®è¯: æ£€æŸ¥ç»“æœè¾“å‡º, ç»Ÿè®¡æŠ¥å‘Š, è¯­æ³•æ£€æŸ¥æ€»ç»“
println(f"æ€»æ–‡ä»¶æ•°: ${totalFiles}")
println(f"åŒ…å«æ­£ç¡® f-string çš„æ–‡ä»¶: ${correctFiles}")
println(f"åŒ…å«é”™è¯¯ f-string çš„æ–‡ä»¶: ${errorFiles}")
println(f"æ—  f-string çš„æ–‡ä»¶: ${totalFiles - correctFiles - errorFiles}")
println()
println(f"æ€» f-string æ•°é‡: ${totalFStrings}")
println(f"æ­£ç¡®çš„ f-string: ${correctFStrings}")
println(f"é”™è¯¯çš„ f-string: ${errorFStrings}")

// å¦‚æœæœ‰é”™è¯¯ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
// å…³é”®è¯: é”™è¯¯è¯¦æƒ…æ˜¾ç¤º, é”™è¯¯æŠ¥å‘Š, ä¿®å¤æŒ‡å¯¼
if len(errorDetails) > 0 {
    println(f"\n=== å‘ç° ${len(errorDetails)} ä¸ª f-string è¯­æ³•é”™è¯¯ ===")
    
    for i, detail in errorDetails {
        println(f"é”™è¯¯ ${i+1}:")
        println(f"  æ–‡ä»¶: ${detail['file']}")
        println(f"  é”™è¯¯å†…å®¹: ${detail['error']}")
        println(f"  ç±»å‹: ${detail['type']}")
        
        // æä¾›ä¿®å¤å»ºè®® - è‡ªåŠ¨ç”Ÿæˆæ­£ç¡®è¯­æ³•
        // å…³é”®è¯: ä¿®å¤å»ºè®®, è¯­æ³•ä¿®å¤æŒ‡å¯¼, è‡ªåŠ¨ä¿®å¤æç¤º
        errorStr = detail["error"]
        if detail["type"] == "double_quote" {
            // å°† f"{var}" ä¿®å¤ä¸º f"${var}"
            fixedStr = re.ReplaceAll(`\{([^}]+)\}`, errorStr, "\\${$1}")
            println(f"  ä¿®å¤å»ºè®®: ${fixedStr}")
        } else if detail["type"] == "single_quote" {
            // å°† f'{var}' ä¿®å¤ä¸º f'${var}'
            fixedStr = re.ReplaceAll(`\{([^}]+)\}`, errorStr, "\\${$1}")
            println(f"  ä¿®å¤å»ºè®®: ${fixedStr}")
        }
        println()
    }
    
    println("ä¿®å¤æ–¹æ³•:")
    println("1. å°†æ‰€æœ‰ f\"{variable}\" æ”¹ä¸º f\"${variable}\"")
    println("2. å°†æ‰€æœ‰ f'{variable}' æ”¹ä¸º f'${variable}'")
    println("3. ç¡®ä¿åœ¨ {} å‰æ·»åŠ  $ ç¬¦å·è¿›è¡Œå˜é‡æ’å€¼")
} else {
    println("\nâœ… æ‰€æœ‰ f-string è¯­æ³•éƒ½æ˜¯æ­£ç¡®çš„ï¼")
}

// è¯­æ³•éªŒè¯æ–­è¨€ - ç¡®ä¿æ²¡æœ‰è¯­æ³•é”™è¯¯
// å…³é”®è¯: è¯­æ³•éªŒè¯æ–­è¨€, é”™è¯¯æ£€æŸ¥æ–­è¨€, ä»£ç è´¨é‡ä¿è¯
assert errorFStrings == 0, f"å‘ç° ${errorFStrings} ä¸ª f-string è¯­æ³•é”™è¯¯ï¼Œè¯·ä¿®å¤åé‡æ–°è¿è¡Œ"

// è¾“å‡ºæˆåŠŸä¿¡æ¯ - éªŒè¯é€šè¿‡æç¤º
// å…³é”®è¯: éªŒè¯æˆåŠŸ, è¯­æ³•æ£€æŸ¥é€šè¿‡, ä»£ç è´¨é‡ç¡®è®¤
println(f"\nğŸ‰ F-String è¯­æ³•éªŒè¯é€šè¿‡ï¼")
println(f"âœ“ æ£€æŸ¥äº† ${totalFiles} ä¸ªæ–‡ä»¶")
println(f"âœ“ éªŒè¯äº† ${totalFStrings} ä¸ª f-string")
println(f"âœ“ æ‰€æœ‰è¯­æ³•éƒ½ç¬¦åˆ Yaklang è§„èŒƒ")

/*
éªŒè¯æ–¹æ³•:
  yak library-usage/fstring/fstring-validation.yak

é¢„æœŸè¾“å‡º:
  - æ‰«ææ‰€æœ‰ yak æ–‡ä»¶
  - æ£€æŸ¥ f-string è¯­æ³•æ­£ç¡®æ€§
  - æŠ¥å‘Šè¯­æ³•é”™è¯¯ï¼ˆå¦‚æœæœ‰ï¼‰
  - æä¾›ä¿®å¤å»ºè®®
  - éªŒè¯é€šè¿‡ç¡®è®¤

æµ‹è¯•ç”¨ä¾‹:
1. æ­£ç¡®è¯­æ³•: f"Hello ${name}"
2. é”™è¯¯è¯­æ³•: f"Hello {name}" (åº”è¯¥æŠ¥é”™)
3. å¤æ‚æ’å€¼: f"User ${user.name} is ${user.age} years old"
4. å¤šå˜é‡: f"${var1} and ${var2}"
*/
