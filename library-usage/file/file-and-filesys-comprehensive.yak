// =============================================================================
// file å’Œ filesys åº“ç»¼åˆæ¼”ç¤ºæ¡ˆä¾‹ - å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
// æ–‡ä»¶æ“ä½œ æ–‡ä»¶ç³»ç»Ÿ æ–‡ä»¶éå† æ–‡ä»¶ç®¡ç† è·¯å¾„æ“ä½œ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
// å…³é”®è¯: file, filesys, æ–‡ä»¶æ“ä½œ, æ–‡ä»¶ç³»ç»Ÿ, éå†, ç®¡ç†, ç»¼åˆåº”ç”¨
// =============================================================================

// =============================================================================
// 1. ç»¼åˆæµ‹è¯•ç¯å¢ƒæ­å»º
// =============================================================================
println("1. ç»¼åˆæµ‹è¯•ç¯å¢ƒæ­å»º")

// ===== 1.1 åˆ›å»ºå¤æ‚çš„æµ‹è¯•ç›®å½•ç»“æ„ =====
// å…³é”®è¯: æµ‹è¯•ç¯å¢ƒ, å¤æ‚ç›®å½•ç»“æ„, å¤šå±‚ç›®å½•, æµ‹è¯•æ•°æ®
println("1.1 åˆ›å»ºå¤æ‚çš„æµ‹è¯•ç›®å½•ç»“æ„")
baseTestDir = "/tmp/file_filesys_comprehensive_test"
os.RemoveAll(baseTestDir)  // æ¸…ç†æ—§ç¯å¢ƒ

// åˆ›å»ºå¤šå±‚ç›®å½•ç»“æ„
// å…³é”®è¯: å¤šå±‚ç›®å½•, ç›®å½•æ ‘, å¤æ‚ç»“æ„, åµŒå¥—ç›®å½•
testDirs = [
    baseTestDir + "/documents/text",
    baseTestDir + "/documents/json",
    baseTestDir + "/documents/logs",
    baseTestDir + "/media/images",
    baseTestDir + "/media/videos",
    baseTestDir + "/config/app",
    baseTestDir + "/config/system",
    baseTestDir + "/temp/cache",
    baseTestDir + "/temp/uploads",
    baseTestDir + "/backup/daily",
    baseTestDir + "/backup/weekly"
]

for dir in testDirs {
    err = file.MkdirAll(dir, 0755)
    assert err == nil, f"åˆ›å»ºç›®å½•å¤±è´¥: ${dir}, é”™è¯¯: ${err}"
}
println("âœ“ å¤æ‚ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ")

// ===== 1.2 åˆ›å»ºå„ç§ç±»å‹çš„æµ‹è¯•æ–‡ä»¶ =====
// å…³é”®è¯: æµ‹è¯•æ–‡ä»¶, å¤šç§ç±»å‹, æ–‡ä»¶å†…å®¹, æµ‹è¯•æ•°æ®
println("\n1.2 åˆ›å»ºå„ç§ç±»å‹çš„æµ‹è¯•æ–‡ä»¶")

// æ–‡æœ¬æ–‡ä»¶
// å…³é”®è¯: æ–‡æœ¬æ–‡ä»¶, æ–‡æ¡£æ–‡ä»¶, çº¯æ–‡æœ¬, å¤šè¯­è¨€å†…å®¹
textFiles = [
    {path: baseTestDir + "/documents/text/readme.txt", content: "# Project README\nThis is a comprehensive test project.\nè¿™æ˜¯ä¸€ä¸ªç»¼åˆæµ‹è¯•é¡¹ç›®ã€‚"},
    {path: baseTestDir + "/documents/text/notes.txt", content: "Meeting Notes\n- Point 1\n- Point 2\n- è¦ç‚¹3"},
    {path: baseTestDir + "/documents/text/todo.txt", content: "TODO List:\n1. Complete testing\n2. Write documentation\n3. å®ŒæˆéªŒè¯"}
]

// JSONé…ç½®æ–‡ä»¶
// å…³é”®è¯: JSONæ–‡ä»¶, é…ç½®æ–‡ä»¶, ç»“æ„åŒ–æ•°æ®, åº”ç”¨é…ç½®
jsonFiles = [
    {path: baseTestDir + "/documents/json/config.json", content: `{"app": {"name": "TestApp", "version": "1.0.0", "debug": true}}`},
    {path: baseTestDir + "/documents/json/users.json", content: `[{"id": 1, "name": "å¼ ä¸‰", "role": "admin"}, {"id": 2, "name": "æå››", "role": "user"}]`},
    {path: baseTestDir + "/config/app/settings.json", content: `{"theme": "dark", "language": "zh-CN", "timeout": 30}`}
]

// æ—¥å¿—æ–‡ä»¶
// å…³é”®è¯: æ—¥å¿—æ–‡ä»¶, ç³»ç»Ÿæ—¥å¿—, åº”ç”¨æ—¥å¿—, å¤šè¡Œæ—¥å¿—
logFiles = [
    {path: baseTestDir + "/documents/logs/app.log", content: "2024-01-01 10:00:00 INFO Application started\n2024-01-01 10:01:00 DEBUG Loading configuration\n2024-01-01 10:02:00 WARN Memory usage high"},
    {path: baseTestDir + "/documents/logs/error.log", content: "2024-01-01 10:05:00 ERROR Database connection failed\n2024-01-01 10:06:00 ERROR Retry attempt 1\n2024-01-01 10:07:00 INFO Connection restored"},
    {path: baseTestDir + "/config/system/system.log", content: "System startup completed\nAll services running\nç³»ç»Ÿå¯åŠ¨å®Œæˆ"}
]

// äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ¨¡æ‹Ÿï¼‰
// å…³é”®è¯: äºŒè¿›åˆ¶æ–‡ä»¶, åª’ä½“æ–‡ä»¶, å›¾ç‰‡æ–‡ä»¶, æ–‡ä»¶å¤´
binaryFiles = [
    {path: baseTestDir + "/media/images/test.png", content: []byte{0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, 0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52}},  // PNG header
    {path: baseTestDir + "/media/images/photo.jpg", content: []byte{0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46, 0x49, 0x46}},  // JPEG header
]

// åˆ›å»ºæ‰€æœ‰æµ‹è¯•æ–‡ä»¶
// å…³é”®è¯: æ–‡ä»¶åˆ›å»º, æ‰¹é‡åˆ›å»º, æµ‹è¯•æ•°æ®ç”Ÿæˆ
allFiles = append(textFiles, jsonFiles...)
allFiles = append(allFiles, logFiles...)

for fileInfo in allFiles {
    err = file.Save(fileInfo.path, fileInfo.content)
    assert err == nil, f"åˆ›å»ºæ–‡ä»¶å¤±è´¥: ${fileInfo.path}, é”™è¯¯: ${err}"
}

for fileInfo in binaryFiles {
    err = file.Save(fileInfo.path, fileInfo.content)
    assert err == nil, f"åˆ›å»ºäºŒè¿›åˆ¶æ–‡ä»¶å¤±è´¥: ${fileInfo.path}, é”™è¯¯: ${err}"
}

println(f"âœ“ æµ‹è¯•æ–‡ä»¶åˆ›å»ºå®Œæˆ: ${len(allFiles) + len(binaryFiles)}ä¸ªæ–‡ä»¶")

// =============================================================================
// 2. æ–‡ä»¶ç³»ç»Ÿéå†ä¸æ–‡ä»¶æ“ä½œç»“åˆæ¼”ç¤º
// =============================================================================
println("\n2. æ–‡ä»¶ç³»ç»Ÿéå†ä¸æ–‡ä»¶æ“ä½œç»“åˆæ¼”ç¤º")

// ===== 2.1 ä½¿ç”¨ filesys éå†å¹¶ç”¨ file æ“ä½œæ–‡ä»¶ =====
// å…³é”®è¯: éå†æ“ä½œç»“åˆ, filesyséå†, fileæ“ä½œ, ç»¼åˆåº”ç”¨
println("2.1 ä½¿ç”¨ filesys éå†å¹¶ç”¨ file æ“ä½œæ–‡ä»¶")

fileStats = {}  // æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯
dirStats = {}   // ç›®å½•ç»Ÿè®¡ä¿¡æ¯
totalSize = 0   // æ€»æ–‡ä»¶å¤§å°

err = filesys.Recursive(baseTestDir,
    filesys.onFileStat((path, info) => {
        // ä½¿ç”¨ file åº“è·å–è¯¦ç»†ä¿¡æ¯
        // å…³é”®è¯: æ–‡ä»¶è¯¦ç»†ä¿¡æ¯, æ–‡ä»¶å±æ€§, ç»¼åˆä¿¡æ¯è·å–
        fileInfo, statErr = file.Stat(path)
        if statErr == nil {
            // è·å–æ–‡ä»¶æ‰©å±•å
            // å…³é”®è¯: æ–‡ä»¶æ‰©å±•å, æ–‡ä»¶åˆ†ç±», ç±»å‹ç»Ÿè®¡
            ext = file.GetExt(path)
            if ext == "" {
                ext = "no_extension"
            }
            
            // ç»Ÿè®¡æ–‡ä»¶ç±»å‹
            // å…³é”®è¯: æ–‡ä»¶ç±»å‹ç»Ÿè®¡, æ‰©å±•åç»Ÿè®¡, æ–‡ä»¶åˆ†ç±»
            if fileStats[ext] == nil {
                fileStats[ext] = {count: 0, totalSize: 0}
            }
            fileStats[ext].count++
            fileStats[ext].totalSize += int(info.Size())
            totalSize += int(info.Size())
            
            log.info("File: %s, ext: %s, size: %d bytes", path, ext, info.Size())
            
            // å¯¹æ–‡æœ¬æ–‡ä»¶è¿›è¡Œå†…å®¹åˆ†æ
            // å…³é”®è¯: å†…å®¹åˆ†æ, æ–‡æœ¬æ–‡ä»¶å¤„ç†, è¡Œæ•°ç»Ÿè®¡
            if ext == ".txt" || ext == ".log" {
                lines, readErr = file.ReadLines(path)
                if readErr == nil {
                    log.info("  Text file has %d lines", len(lines))
                    if fileStats[ext].lines == nil {
                        fileStats[ext].lines = 0
                    }
                    fileStats[ext].lines += len(lines)
                }
            }
            
            // å¯¹JSONæ–‡ä»¶è¿›è¡ŒéªŒè¯
            // å…³é”®è¯: JSONéªŒè¯, æ–‡ä»¶å†…å®¹éªŒè¯, æ ¼å¼æ£€æŸ¥
            if ext == ".json" {
                content, readErr = file.ReadFile(path)
                if readErr == nil {
                    if str.Contains(string(content), "{") || str.Contains(string(content), "[") {
                        log.info("  JSON file appears valid")
                        if fileStats[ext].validJson == nil {
                            fileStats[ext].validJson = 0
                        }
                        fileStats[ext].validJson++
                    }
                }
            }
        }
        return nil
    }),
    filesys.onDirStat((path, info) => {
        // ä½¿ç”¨ file åº“åˆ—å‡ºç›®å½•å†…å®¹
        // å…³é”®è¯: ç›®å½•å†…å®¹, ç›®å½•ç»Ÿè®¡, å­é¡¹ç»Ÿè®¡
        dirContents = file.Ls(path)
        if dirContents != nil {
            fileCount = 0
            subDirCount = 0
            for item in dirContents {
                if item.IsDir {
                    subDirCount++
                } else {
                    fileCount++
                }
            }
            
            // è·å–ç›®å½•å
            // å…³é”®è¯: ç›®å½•å, ç›®å½•åˆ†ç±», ç›®å½•ç»Ÿè®¡
            dirName = file.GetBase(path)
            dirStats[dirName] = {
                fileCount: fileCount,
                subDirCount: subDirCount,
                totalItems: len(dirContents)
            }
            
            log.info("Directory: %s, files: %d, subdirs: %d", path, fileCount, subDirCount)
        }
        return nil
    })
)

assert err == nil, f"æ–‡ä»¶ç³»ç»Ÿéå†å¤±è´¥: ${err}"

// è¾“å‡ºç»Ÿè®¡ç»“æœ
// å…³é”®è¯: ç»Ÿè®¡ç»“æœ, æ–‡ä»¶ç»Ÿè®¡, ç»¼åˆæŠ¥å‘Š
println("\næ–‡ä»¶ç±»å‹ç»Ÿè®¡:")
for ext, stats in fileStats {
    println(f"  ${ext}: ${stats.count}ä¸ªæ–‡ä»¶, æ€»å¤§å°: ${stats.totalSize} bytes")
    if stats.lines != nil {
        println(f"    æ€»è¡Œæ•°: ${stats.lines}")
    }
    if stats.validJson != nil {
        println(f"    æœ‰æ•ˆJSON: ${stats.validJson}")
    }
}

println(f"\næ€»æ–‡ä»¶å¤§å°: ${totalSize} bytes")
println(f"ç›®å½•ç»Ÿè®¡: ${len(dirStats)}ä¸ªç›®å½•")

// éªŒè¯ç»Ÿè®¡ç»“æœ
// å…³é”®è¯: ç»Ÿè®¡éªŒè¯, ç»“æœæ£€æŸ¥, æ•°æ®éªŒè¯
assert len(fileStats) > 0, "åº”è¯¥æœ‰æ–‡ä»¶ç±»å‹ç»Ÿè®¡"
assert totalSize > 0, "æ€»æ–‡ä»¶å¤§å°åº”è¯¥å¤§äº0"
assert len(dirStats) > 0, "åº”è¯¥æœ‰ç›®å½•ç»Ÿè®¡"
println("âœ“ æ–‡ä»¶ç³»ç»Ÿéå†ä¸æ“ä½œç»“åˆéªŒè¯é€šè¿‡")

// =============================================================================
// 3. æ–‡ä»¶å¤‡ä»½å’Œç®¡ç†ç³»ç»Ÿæ¼”ç¤º
// =============================================================================
println("\n3. æ–‡ä»¶å¤‡ä»½å’Œç®¡ç†ç³»ç»Ÿæ¼”ç¤º")

// ===== 3.1 åˆ›å»ºå¤‡ä»½ç³»ç»Ÿ =====
// å…³é”®è¯: å¤‡ä»½ç³»ç»Ÿ, æ–‡ä»¶å¤‡ä»½, è‡ªåŠ¨å¤‡ä»½, å¤‡ä»½ç®¡ç†
println("3.1 åˆ›å»ºå¤‡ä»½ç³»ç»Ÿ")
backupDir = baseTestDir + "/backup/auto_backup_" + string(time.Now().Unix())
err = file.MkdirAll(backupDir, 0755)
assert err == nil, f"åˆ›å»ºå¤‡ä»½ç›®å½•å¤±è´¥: ${err}"

// å¤‡ä»½é‡è¦æ–‡ä»¶
// å…³é”®è¯: é‡è¦æ–‡ä»¶å¤‡ä»½, é€‰æ‹©æ€§å¤‡ä»½, æ–‡ä»¶å¤åˆ¶
importantFiles = []
err = filesys.Recursive(baseTestDir + "/documents",
    filesys.onFileStat((path, info) => {
        // åªå¤‡ä»½é‡è¦æ–‡ä»¶ç±»å‹
        // å…³é”®è¯: æ–‡ä»¶è¿‡æ»¤, é‡è¦æ–‡ä»¶è¯†åˆ«, å¤‡ä»½ç­–ç•¥
        ext = file.GetExt(path)
        if ext == ".json" || ext == ".txt" {
            importantFiles = append(importantFiles, path)
        }
        return nil
    })
)
assert err == nil, f"æ‰«æé‡è¦æ–‡ä»¶å¤±è´¥: ${err}"

// æ‰§è¡Œå¤‡ä»½
// å…³é”®è¯: å¤‡ä»½æ‰§è¡Œ, æ–‡ä»¶å¤åˆ¶, å¤‡ä»½æ“ä½œ
backupCount = 0
for srcFile in importantFiles {
    // æ„å»ºå¤‡ä»½æ–‡ä»¶è·¯å¾„
    // å…³é”®è¯: å¤‡ä»½è·¯å¾„, ç›¸å¯¹è·¯å¾„, è·¯å¾„è½¬æ¢
    relativePath = str.TrimPrefix(srcFile, baseTestDir + "/documents/")
    backupFile = backupDir + "/" + str.ReplaceAll(relativePath, "/", "_")
    
    // å¤åˆ¶æ–‡ä»¶åˆ°å¤‡ä»½ç›®å½•
    // å…³é”®è¯: æ–‡ä»¶å¤åˆ¶, å¤‡ä»½å¤åˆ¶, file.Cp
    err = file.Cp(srcFile, backupFile)
    if err == nil {
        backupCount++
        log.info("Backed up: %s -> %s", srcFile, backupFile)
    } else {
        log.warn("Backup failed: %s, error: %v", srcFile, err)
    }
}

assert backupCount > 0, f"åº”è¯¥è‡³å°‘å¤‡ä»½ä¸€ä¸ªæ–‡ä»¶ï¼Œå®é™…å¤‡ä»½${backupCount}ä¸ª"
println(f"âœ“ å¤‡ä»½å®Œæˆ: ${backupCount}ä¸ªé‡è¦æ–‡ä»¶")

// ===== 3.2 å¤‡ä»½éªŒè¯å’Œå®Œæ•´æ€§æ£€æŸ¥ =====
// å…³é”®è¯: å¤‡ä»½éªŒè¯, å®Œæ•´æ€§æ£€æŸ¥, å¤‡ä»½æ ¡éªŒ, æ•°æ®ä¸€è‡´æ€§
println("\n3.2 å¤‡ä»½éªŒè¯å’Œå®Œæ•´æ€§æ£€æŸ¥")
verificationResults = []

// éå†å¤‡ä»½ç›®å½•éªŒè¯æ–‡ä»¶
// å…³é”®è¯: å¤‡ä»½éå†, éªŒè¯éå†, å®Œæ•´æ€§éå†
err = filesys.Recursive(backupDir,
    filesys.onFileStat((backupPath, info) => {
        // è¯»å–å¤‡ä»½æ–‡ä»¶å†…å®¹
        // å…³é”®è¯: å¤‡ä»½å†…å®¹, æ–‡ä»¶è¯»å–, å†…å®¹éªŒè¯
        backupContent, readErr = file.ReadFile(backupPath)
        if readErr == nil {
            // æ„å»ºåŸå§‹æ–‡ä»¶è·¯å¾„è¿›è¡Œå¯¹æ¯”
            // å…³é”®è¯: åŸå§‹æ–‡ä»¶, è·¯å¾„é‡æ„, æ–‡ä»¶å¯¹æ¯”
            backupFileName = file.GetBase(backupPath)
            originalPath = ""
            
            // æŸ¥æ‰¾å¯¹åº”çš„åŸå§‹æ–‡ä»¶
            // å…³é”®è¯: æ–‡ä»¶åŒ¹é…, åŸå§‹æ–‡ä»¶æŸ¥æ‰¾, è·¯å¾„åŒ¹é…
            for originalFile in importantFiles {
                originalFileName = str.ReplaceAll(str.TrimPrefix(originalFile, baseTestDir + "/documents/"), "/", "_")
                if originalFileName == backupFileName {
                    originalPath = originalFile
                    break
                }
            }
            
            if originalPath != "" {
                // è¯»å–åŸå§‹æ–‡ä»¶è¿›è¡Œå¯¹æ¯”
                // å…³é”®è¯: æ–‡ä»¶å¯¹æ¯”, å†…å®¹å¯¹æ¯”, ä¸€è‡´æ€§æ£€æŸ¥
                originalContent, origErr = file.ReadFile(originalPath)
                if origErr == nil {
                    isIdentical = string(backupContent) == string(originalContent)
                    verificationResults = append(verificationResults, {
                        backupFile: backupPath,
                        originalFile: originalPath,
                        identical: isIdentical,
                        backupSize: len(backupContent),
                        originalSize: len(originalContent)
                    })
                    
                    if isIdentical {
                        log.info("Backup verified: %s âœ“", backupFileName)
                    } else {
                        log.warn("Backup mismatch: %s âœ—", backupFileName)
                    }
                }
            }
        }
        return nil
    })
)

assert err == nil, f"å¤‡ä»½éªŒè¯éå†å¤±è´¥: ${err}"
assert len(verificationResults) > 0, "åº”è¯¥æœ‰éªŒè¯ç»“æœ"

// ç»Ÿè®¡éªŒè¯ç»“æœ
// å…³é”®è¯: éªŒè¯ç»Ÿè®¡, æˆåŠŸç‡ç»Ÿè®¡, å¤‡ä»½è´¨é‡
successCount = 0
for result in verificationResults {
    if result.identical {
        successCount++
    }
    assert result.backupSize == result.originalSize, f"å¤‡ä»½æ–‡ä»¶å¤§å°ä¸åŒ¹é…: ${result.backupFile}"
}

successRate = float64(successCount) / float64(len(verificationResults)) * 100
println(f"âœ“ å¤‡ä»½éªŒè¯å®Œæˆ: ${successCount}/${len(verificationResults)} æˆåŠŸ (${successRate}%)")
assert successRate == 100.0, f"å¤‡ä»½æˆåŠŸç‡åº”è¯¥æ˜¯100%ï¼Œå®é™…${successRate}%"

// =============================================================================
// 4. è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸å®é™…æ–‡ä»¶ç³»ç»Ÿäº¤äº’æ¼”ç¤º
// =============================================================================
println("\n4. è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸å®é™…æ–‡ä»¶ç³»ç»Ÿäº¤äº’æ¼”ç¤º")

// ===== 4.1 åˆ›å»ºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå¹¶å¡«å……æ•°æ® =====
// å…³é”®è¯: è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ, VirtualFS, å†…å­˜æ–‡ä»¶ç³»ç»Ÿ, è™šæ‹Ÿæ•°æ®
println("4.1 åˆ›å»ºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå¹¶å¡«å……æ•°æ®")
vfs = filesys.NewVirtualFs()

// ä»å®é™…æ–‡ä»¶ç³»ç»Ÿå¤åˆ¶æ•°æ®åˆ°è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
// å…³é”®è¯: æ•°æ®å¤åˆ¶, å®é™…åˆ°è™šæ‹Ÿ, æ–‡ä»¶ç³»ç»Ÿè¿ç§»
virtualFileCount = 0
err = filesys.Recursive(baseTestDir + "/documents/json",
    filesys.onFileStat((path, info) => {
        // è¯»å–å®é™…æ–‡ä»¶å†…å®¹
        // å…³é”®è¯: å®é™…æ–‡ä»¶è¯»å–, å†…å®¹è·å–, æ•°æ®è¿ç§»
        content, readErr = file.ReadFile(path)
        if readErr == nil {
            // æ„å»ºè™šæ‹Ÿæ–‡ä»¶è·¯å¾„
            // å…³é”®è¯: è™šæ‹Ÿè·¯å¾„, è·¯å¾„æ˜ å°„, è™šæ‹Ÿæ–‡ä»¶å
            relativePath = str.TrimPrefix(path, baseTestDir + "/documents/json/")
            virtualPath = "virtual_json/" + relativePath
            
            // æ·»åŠ åˆ°è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
            // å…³é”®è¯: è™šæ‹Ÿæ–‡ä»¶æ·»åŠ , AddFile, è™šæ‹Ÿå†…å®¹
            vfs.AddFile(virtualPath, string(content))
            virtualFileCount++
            log.info("Added to VFS: %s", virtualPath)
        }
        return nil
    })
)

assert err == nil, f"å¤åˆ¶åˆ°è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå¤±è´¥: ${err}"
assert virtualFileCount > 0, f"åº”è¯¥è‡³å°‘å¤åˆ¶ä¸€ä¸ªæ–‡ä»¶åˆ°è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå®é™…${virtualFileCount}ä¸ª"

// æ·»åŠ ä¸€äº›è™šæ‹Ÿä¸“ç”¨æ–‡ä»¶
// å…³é”®è¯: è™šæ‹Ÿä¸“ç”¨æ–‡ä»¶, çº¯è™šæ‹Ÿæ–‡ä»¶, å†…å­˜æ–‡ä»¶
vfs.AddFile("virtual_only/config.json", `{"virtual": true, "memory_only": true}`)
vfs.AddFile("virtual_only/data.txt", "This file exists only in virtual filesystem\nè¿™ä¸ªæ–‡ä»¶åªå­˜åœ¨äºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸­")
vfs.AddDir("virtual_only/empty_dir")

println(f"âœ“ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿåˆ›å»ºå®Œæˆ: ${virtualFileCount + 2}ä¸ªæ–‡ä»¶")

// ===== 4.2 éå†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ =====
// å…³é”®è¯: è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿéå†, VFSéå†, è™šæ‹Ÿæ–‡ä»¶è®¿é—®
println("\n4.2 éå†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ")
virtualStats = {fileCount: 0, dirCount: 0, totalSize: 0}

err = filesys.Recursive(".",
    filesys.onFS(vfs),  // ä½¿ç”¨è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
    filesys.onFileStat((path, info) => {
        virtualStats.fileCount++
        virtualStats.totalSize += int(info.Size())
        
        // è¯»å–è™šæ‹Ÿæ–‡ä»¶å†…å®¹
        // å…³é”®è¯: è™šæ‹Ÿæ–‡ä»¶è¯»å–, VFSè¯»å–, è™šæ‹Ÿå†…å®¹è·å–
        content, readErr = vfs.ReadFile(path)
        if readErr == nil {
            log.info("Virtual file: %s, size: %d bytes", path, len(content))
            
            // éªŒè¯è™šæ‹Ÿæ–‡ä»¶å†…å®¹
            // å…³é”®è¯: è™šæ‹Ÿæ–‡ä»¶éªŒè¯, å†…å®¹éªŒè¯, VFSéªŒè¯
            assert len(content) > 0, f"è™šæ‹Ÿæ–‡ä»¶å†…å®¹ä¸åº”ä¸ºç©º: ${path}"
            assert int64(len(content)) == info.Size(), f"è™šæ‹Ÿæ–‡ä»¶å¤§å°ä¸åŒ¹é…: ${path}"
        }
        return nil
    }),
    filesys.onDirStat((path, info) => {
        virtualStats.dirCount++
        log.info("Virtual directory: %s", path)
        return nil
    })
)

assert err == nil, f"è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿéå†å¤±è´¥: ${err}"
assert virtualStats.fileCount > 0, f"è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿåº”è¯¥åŒ…å«æ–‡ä»¶ï¼Œå®é™…${virtualStats.fileCount}ä¸ª"
assert virtualStats.totalSize > 0, f"è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ€»å¤§å°åº”è¯¥å¤§äº0ï¼Œå®é™…${virtualStats.totalSize}"

println(f"âœ“ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿéå†å®Œæˆ: ${virtualStats.fileCount}ä¸ªæ–‡ä»¶ï¼Œ${virtualStats.dirCount}ä¸ªç›®å½•")

// ===== 4.3 è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå¯¼å‡ºåˆ°å®é™…æ–‡ä»¶ç³»ç»Ÿ =====
// å…³é”®è¯: è™šæ‹Ÿå¯¼å‡º, VFSå¯¼å‡º, è™šæ‹Ÿåˆ°å®é™…, æ–‡ä»¶ç³»ç»Ÿå¯¼å‡º
println("\n4.3 è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå¯¼å‡ºåˆ°å®é™…æ–‡ä»¶ç³»ç»Ÿ")
exportDir = baseTestDir + "/exported_from_vfs"
err = file.MkdirAll(exportDir, 0755)
assert err == nil, f"åˆ›å»ºå¯¼å‡ºç›®å½•å¤±è´¥: ${err}"

exportCount = 0
err = filesys.Recursive(".",
    filesys.onFS(vfs),
    filesys.onFileStat((virtualPath, info) => {
        // è¯»å–è™šæ‹Ÿæ–‡ä»¶å†…å®¹
        // å…³é”®è¯: è™šæ‹Ÿæ–‡ä»¶å¯¼å‡º, å†…å®¹å¯¼å‡º, VFSåˆ°å®é™…
        content, readErr = vfs.ReadFile(virtualPath)
        if readErr == nil {
            // æ„å»ºå¯¼å‡ºæ–‡ä»¶è·¯å¾„
            // å…³é”®è¯: å¯¼å‡ºè·¯å¾„, è·¯å¾„è½¬æ¢, æ–‡ä»¶å¯¼å‡º
            exportPath = exportDir + "/" + str.ReplaceAll(virtualPath, "/", "_")
            
            // ä¿å­˜åˆ°å®é™…æ–‡ä»¶ç³»ç»Ÿ
            // å…³é”®è¯: å®é™…æ–‡ä»¶ä¿å­˜, å¯¼å‡ºä¿å­˜, file.Save
            saveErr = file.Save(exportPath, content)
            if saveErr == nil {
                exportCount++
                log.info("Exported: %s -> %s", virtualPath, exportPath)
                
                // éªŒè¯å¯¼å‡ºçš„æ–‡ä»¶
                // å…³é”®è¯: å¯¼å‡ºéªŒè¯, æ–‡ä»¶éªŒè¯, å¯¼å‡ºæ£€æŸ¥
                assert file.IsExisted(exportPath), f"å¯¼å‡ºæ–‡ä»¶åº”è¯¥å­˜åœ¨: ${exportPath}"
                exportedContent, verifyErr = file.ReadFile(exportPath)
                if verifyErr == nil {
                    assert string(exportedContent) == string(content), f"å¯¼å‡ºæ–‡ä»¶å†…å®¹ä¸åŒ¹é…: ${exportPath}"
                }
            }
        }
        return nil
    })
)

assert err == nil, f"è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå¯¼å‡ºå¤±è´¥: ${err}"
assert exportCount > 0, f"åº”è¯¥è‡³å°‘å¯¼å‡ºä¸€ä¸ªæ–‡ä»¶ï¼Œå®é™…å¯¼å‡º${exportCount}ä¸ª"
println(f"âœ“ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå¯¼å‡ºå®Œæˆ: ${exportCount}ä¸ªæ–‡ä»¶")

// =============================================================================
// 5. æ–‡ä»¶ç›‘æ§å’Œå˜åŒ–æ£€æµ‹æ¼”ç¤º
// =============================================================================
println("\n5. æ–‡ä»¶ç›‘æ§å’Œå˜åŒ–æ£€æµ‹æ¼”ç¤º")

// ===== 5.1 åˆ›å»ºæ–‡ä»¶å¿«ç…§ =====
// å…³é”®è¯: æ–‡ä»¶å¿«ç…§, çŠ¶æ€å¿«ç…§, æ–‡ä»¶ç›‘æ§, å˜åŒ–æ£€æµ‹
println("5.1 åˆ›å»ºæ–‡ä»¶å¿«ç…§")
snapshot = {}

err = filesys.Recursive(baseTestDir + "/documents",
    filesys.onFileStat((path, info) => {
        // åˆ›å»ºæ–‡ä»¶å¿«ç…§ä¿¡æ¯
        // å…³é”®è¯: å¿«ç…§ä¿¡æ¯, æ–‡ä»¶çŠ¶æ€, ç›‘æ§æ•°æ®
        snapshot[path] = {
            size: info.Size(),
            modTime: info.ModTime().Unix(),
            exists: true
        }
        return nil
    })
)

assert err == nil, f"åˆ›å»ºæ–‡ä»¶å¿«ç…§å¤±è´¥: ${err}"
assert len(snapshot) > 0, f"å¿«ç…§åº”è¯¥åŒ…å«æ–‡ä»¶ï¼Œå®é™…${len(snapshot)}ä¸ª"
println(f"âœ“ æ–‡ä»¶å¿«ç…§åˆ›å»ºå®Œæˆ: ${len(snapshot)}ä¸ªæ–‡ä»¶")

// ===== 5.2 æ¨¡æ‹Ÿæ–‡ä»¶å˜åŒ– =====
// å…³é”®è¯: æ–‡ä»¶å˜åŒ–, æ¨¡æ‹Ÿä¿®æ”¹, æ–‡ä»¶æ›´æ–°, å˜åŒ–æ¨¡æ‹Ÿ
println("\n5.2 æ¨¡æ‹Ÿæ–‡ä»¶å˜åŒ–")

// ä¿®æ”¹ä¸€ä¸ªç°æœ‰æ–‡ä»¶
// å…³é”®è¯: æ–‡ä»¶ä¿®æ”¹, å†…å®¹æ›´æ–°, æ–‡ä»¶å˜æ›´
modifyFile = baseTestDir + "/documents/text/notes.txt"
originalContent, err = file.ReadFile(modifyFile)
assert err == nil, f"è¯»å–åŸå§‹æ–‡ä»¶å¤±è´¥: ${err}"

newContent = string(originalContent) + "\n- æ–°å¢çš„è¦ç‚¹\n- Additional point"
err = file.Save(modifyFile, newContent)
assert err == nil, f"ä¿®æ”¹æ–‡ä»¶å¤±è´¥: ${err}"

// åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶
// å…³é”®è¯: æ–°æ–‡ä»¶åˆ›å»º, æ–‡ä»¶æ·»åŠ , æ–°å¢æ–‡ä»¶
newFile = baseTestDir + "/documents/text/new_file.txt"
err = file.Save(newFile, "This is a new file created for change detection\nè¿™æ˜¯ä¸ºå˜åŒ–æ£€æµ‹åˆ›å»ºçš„æ–°æ–‡ä»¶")
assert err == nil, f"åˆ›å»ºæ–°æ–‡ä»¶å¤±è´¥: ${err}"

// åˆ é™¤ä¸€ä¸ªæ–‡ä»¶
// å…³é”®è¯: æ–‡ä»¶åˆ é™¤, æ–‡ä»¶ç§»é™¤, åˆ é™¤æ“ä½œ
deleteFile = baseTestDir + "/documents/text/todo.txt"
assert file.IsExisted(deleteFile), f"å¾…åˆ é™¤æ–‡ä»¶åº”è¯¥å­˜åœ¨: ${deleteFile}"
err = file.Rm(deleteFile)
assert err == nil, f"åˆ é™¤æ–‡ä»¶å¤±è´¥: ${err}"

println("âœ“ æ–‡ä»¶å˜åŒ–æ¨¡æ‹Ÿå®Œæˆ: ä¿®æ”¹1ä¸ªï¼Œæ–°å¢1ä¸ªï¼Œåˆ é™¤1ä¸ª")

// ===== 5.3 æ£€æµ‹æ–‡ä»¶å˜åŒ– =====
// å…³é”®è¯: å˜åŒ–æ£€æµ‹, æ–‡ä»¶å¯¹æ¯”, å˜åŒ–åˆ†æ, ç›‘æ§æ£€æµ‹
println("\n5.3 æ£€æµ‹æ–‡ä»¶å˜åŒ–")
changes = {modified: [], added: [], deleted: []}
currentFiles = {}

// æ‰«æå½“å‰æ–‡ä»¶çŠ¶æ€
// å…³é”®è¯: å½“å‰çŠ¶æ€, æ–‡ä»¶æ‰«æ, çŠ¶æ€è·å–
err = filesys.Recursive(baseTestDir + "/documents",
    filesys.onFileStat((path, info) => {
        currentFiles[path] = {
            size: info.Size(),
            modTime: info.ModTime().Unix(),
            exists: true
        }
        return nil
    })
)
assert err == nil, f"æ‰«æå½“å‰æ–‡ä»¶çŠ¶æ€å¤±è´¥: ${err}"

// æ£€æµ‹å˜åŒ–
// å…³é”®è¯: å˜åŒ–å¯¹æ¯”, çŠ¶æ€å¯¹æ¯”, å·®å¼‚æ£€æµ‹
for path, currentInfo in currentFiles {
    if snapshot[path] != nil {
        // æ£€æŸ¥ä¿®æ”¹
        // å…³é”®è¯: ä¿®æ”¹æ£€æµ‹, å¤§å°å¯¹æ¯”, æ—¶é—´å¯¹æ¯”
        snapshotInfo = snapshot[path]
        if currentInfo.size != snapshotInfo.size || currentInfo.modTime != snapshotInfo.modTime {
            changes.modified = append(changes.modified, {
                path: path,
                oldSize: snapshotInfo.size,
                newSize: currentInfo.size,
                oldTime: snapshotInfo.modTime,
                newTime: currentInfo.modTime
            })
        }
    } else {
        // æ–°å¢æ–‡ä»¶
        // å…³é”®è¯: æ–°å¢æ£€æµ‹, æ–‡ä»¶æ·»åŠ , æ–°æ–‡ä»¶è¯†åˆ«
        changes.added = append(changes.added, {
            path: path,
            size: currentInfo.size,
            modTime: currentInfo.modTime
        })
    }
}

// æ£€æµ‹åˆ é™¤çš„æ–‡ä»¶
// å…³é”®è¯: åˆ é™¤æ£€æµ‹, æ–‡ä»¶ç¼ºå¤±, åˆ é™¤è¯†åˆ«
for path, snapshotInfo in snapshot {
    if currentFiles[path] == nil {
        changes.deleted = append(changes.deleted, {
            path: path,
            size: snapshotInfo.size,
            modTime: snapshotInfo.modTime
        })
    }
}

// è¾“å‡ºå˜åŒ–æŠ¥å‘Š
// å…³é”®è¯: å˜åŒ–æŠ¥å‘Š, ç›‘æ§æŠ¥å‘Š, å˜åŒ–ç»Ÿè®¡
println("æ–‡ä»¶å˜åŒ–æ£€æµ‹æŠ¥å‘Š:")
println(f"  ä¿®æ”¹çš„æ–‡ä»¶: ${len(changes.modified)}ä¸ª")
for change in changes.modified {
    println(f"    ${change.path}: ${change.oldSize} -> ${change.newSize} bytes")
}

println(f"  æ–°å¢çš„æ–‡ä»¶: ${len(changes.added)}ä¸ª")
for change in changes.added {
    println(f"    ${change.path}: ${change.size} bytes")
}

println(f"  åˆ é™¤çš„æ–‡ä»¶: ${len(changes.deleted)}ä¸ª")
for change in changes.deleted {
    println(f"    ${change.path}: ${change.size} bytes")
}

// éªŒè¯å˜åŒ–æ£€æµ‹ç»“æœ
// å…³é”®è¯: å˜åŒ–éªŒè¯, æ£€æµ‹éªŒè¯, ç»“æœéªŒè¯
assert len(changes.modified) == 1, f"åº”è¯¥æ£€æµ‹åˆ°1ä¸ªä¿®æ”¹æ–‡ä»¶ï¼Œå®é™…${len(changes.modified)}ä¸ª"
assert len(changes.added) == 1, f"åº”è¯¥æ£€æµ‹åˆ°1ä¸ªæ–°å¢æ–‡ä»¶ï¼Œå®é™…${len(changes.added)}ä¸ª"
assert len(changes.deleted) == 1, f"åº”è¯¥æ£€æµ‹åˆ°1ä¸ªåˆ é™¤æ–‡ä»¶ï¼Œå®é™…${len(changes.deleted)}ä¸ª"
println("âœ“ æ–‡ä»¶å˜åŒ–æ£€æµ‹éªŒè¯é€šè¿‡")

// =============================================================================
// 6. é«˜çº§æ–‡ä»¶æ“ä½œå’Œæ‰¹å¤„ç†æ¼”ç¤º
// =============================================================================
println("\n6. é«˜çº§æ–‡ä»¶æ“ä½œå’Œæ‰¹å¤„ç†æ¼”ç¤º")

// ===== 6.1 æ‰¹é‡æ–‡ä»¶é‡å‘½å =====
// å…³é”®è¯: æ‰¹é‡é‡å‘½å, æ–‡ä»¶é‡å‘½å, æ‰¹å¤„ç†, æ–‡ä»¶ç®¡ç†
println("6.1 æ‰¹é‡æ–‡ä»¶é‡å‘½å")
renameDir = baseTestDir + "/documents/logs"
renamedFiles = []

// æ‰«æéœ€è¦é‡å‘½åçš„æ–‡ä»¶
// å…³é”®è¯: æ–‡ä»¶æ‰«æ, é‡å‘½åå€™é€‰, æ‰¹é‡æ“ä½œ
filesToRename = []
err = filesys.Recursive(renameDir,
    filesys.onFileStat((path, info) => {
        if file.GetExt(path) == ".log" {
            filesToRename = append(filesToRename, path)
        }
        return nil
    })
)
assert err == nil, f"æ‰«æé‡å‘½åæ–‡ä»¶å¤±è´¥: ${err}"

// æ‰§è¡Œæ‰¹é‡é‡å‘½å
// å…³é”®è¯: æ‰¹é‡é‡å‘½åæ‰§è¡Œ, æ–‡ä»¶é‡å‘½å, æ‰¹å¤„ç†æ“ä½œ
for i, oldPath in filesToRename {
    // æ„å»ºæ–°æ–‡ä»¶å
    // å…³é”®è¯: æ–°æ–‡ä»¶å, å‘½åè§„åˆ™, æ–‡ä»¶åç”Ÿæˆ
    dir = file.GetDirPath(oldPath)
    oldName = file.GetBase(oldPath)
    ext = file.GetExt(oldPath)
    baseName = str.TrimSuffix(oldName, ext)
    newName = f"renamed_${i+1}_${baseName}${ext}"
    newPath = file.Join(dir, newName)
    
    // æ‰§è¡Œé‡å‘½å
    // å…³é”®è¯: é‡å‘½åæ‰§è¡Œ, file.Mv, æ–‡ä»¶ç§»åŠ¨
    err = file.Mv(oldPath, newPath)
    if err == nil {
        renamedFiles = append(renamedFiles, {
            oldPath: oldPath,
            newPath: newPath,
            oldName: oldName,
            newName: newName
        })
        log.info("Renamed: %s -> %s", oldName, newName)
    } else {
        log.warn("Rename failed: %s, error: %v", oldPath, err)
    }
}

assert len(renamedFiles) > 0, f"åº”è¯¥è‡³å°‘é‡å‘½åä¸€ä¸ªæ–‡ä»¶ï¼Œå®é™…${len(renamedFiles)}ä¸ª"
println(f"âœ“ æ‰¹é‡é‡å‘½åå®Œæˆ: ${len(renamedFiles)}ä¸ªæ–‡ä»¶")

// éªŒè¯é‡å‘½åç»“æœ
// å…³é”®è¯: é‡å‘½åéªŒè¯, æ–‡ä»¶å­˜åœ¨éªŒè¯, å†…å®¹éªŒè¯
for renameInfo in renamedFiles {
    assert file.IsExisted(renameInfo.newPath), f"é‡å‘½ååæ–‡ä»¶åº”è¯¥å­˜åœ¨: ${renameInfo.newPath}"
    assert !file.IsExisted(renameInfo.oldPath), f"åŸæ–‡ä»¶ä¸åº”è¯¥å­˜åœ¨: ${renameInfo.oldPath}"
}
println("âœ“ æ‰¹é‡é‡å‘½åéªŒè¯é€šè¿‡")

// ===== 6.2 æ–‡ä»¶å†…å®¹æ‰¹é‡å¤„ç† =====
// å…³é”®è¯: æ‰¹é‡å†…å®¹å¤„ç†, å†…å®¹ä¿®æ”¹, æ‰¹é‡ç¼–è¾‘, æ–‡ä»¶å¤„ç†
println("\n6.2 æ–‡ä»¶å†…å®¹æ‰¹é‡å¤„ç†")
processedFiles = []

// æ‰¹é‡åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ—¶é—´æˆ³
// å…³é”®è¯: æ‰¹é‡æ·»åŠ , æ—¶é—´æˆ³, å†…å®¹è¿½åŠ , æ‰¹å¤„ç†
timestamp = time.Now().Format("2006-01-02 15:04:05")
err = filesys.Recursive(baseTestDir + "/documents/text",
    filesys.onFileStat((path, info) => {
        if file.GetExt(path) == ".txt" {
            // è¯»å–åŸå§‹å†…å®¹
            // å…³é”®è¯: åŸå§‹å†…å®¹, æ–‡ä»¶è¯»å–, å†…å®¹è·å–
            originalContent, readErr = file.ReadFile(path)
            if readErr == nil {
                // æ·»åŠ æ—¶é—´æˆ³
                // å…³é”®è¯: å†…å®¹ä¿®æ”¹, æ—¶é—´æˆ³æ·»åŠ , å†…å®¹æ›´æ–°
                newContent = string(originalContent) + f"\n\n--- Processed at ${timestamp} ---"
                
                // ä¿å­˜ä¿®æ”¹åçš„å†…å®¹
                // å…³é”®è¯: å†…å®¹ä¿å­˜, æ–‡ä»¶æ›´æ–°, æ‰¹é‡ä¿å­˜
                saveErr = file.Save(path, newContent)
                if saveErr == nil {
                    processedFiles = append(processedFiles, {
                        path: path,
                        originalSize: len(originalContent),
                        newSize: len(newContent),
                        added: len(newContent) - len(originalContent)
                    })
                    log.info("Processed: %s, added %d bytes", path, len(newContent) - len(originalContent))
                }
            }
        }
        return nil
    })
)

assert err == nil, f"æ‰¹é‡å†…å®¹å¤„ç†å¤±è´¥: ${err}"
assert len(processedFiles) > 0, f"åº”è¯¥è‡³å°‘å¤„ç†ä¸€ä¸ªæ–‡ä»¶ï¼Œå®é™…${len(processedFiles)}ä¸ª"

// éªŒè¯å¤„ç†ç»“æœ
// å…³é”®è¯: å¤„ç†éªŒè¯, å†…å®¹éªŒè¯, å¤§å°éªŒè¯
for processInfo in processedFiles {
    // é‡æ–°è¯»å–æ–‡ä»¶éªŒè¯
    // å…³é”®è¯: éªŒè¯è¯»å–, å†…å®¹æ£€æŸ¥, å¤„ç†éªŒè¯
    verifyContent, err = file.ReadFile(processInfo.path)
    assert err == nil, f"éªŒè¯è¯»å–å¤±è´¥: ${processInfo.path}"
    assert len(verifyContent) == processInfo.newSize, f"æ–‡ä»¶å¤§å°ä¸åŒ¹é…: ${processInfo.path}"
    assert str.Contains(string(verifyContent), timestamp), f"æ–‡ä»¶åº”è¯¥åŒ…å«æ—¶é—´æˆ³: ${processInfo.path}"
}

println(f"âœ“ æ‰¹é‡å†…å®¹å¤„ç†å®Œæˆ: ${len(processedFiles)}ä¸ªæ–‡ä»¶")

// =============================================================================
// 7. æ–‡ä»¶æœç´¢å’Œè¿‡æ»¤æ¼”ç¤º
// =============================================================================
println("\n7. æ–‡ä»¶æœç´¢å’Œè¿‡æ»¤æ¼”ç¤º")

// ===== 7.1 æŒ‰å†…å®¹æœç´¢æ–‡ä»¶ =====
// å…³é”®è¯: å†…å®¹æœç´¢, æ–‡ä»¶æœç´¢, æ–‡æœ¬æœç´¢, å†…å®¹è¿‡æ»¤
println("7.1 æŒ‰å†…å®¹æœç´¢æ–‡ä»¶")
searchKeyword = "test"
searchResults = []

err = filesys.Recursive(baseTestDir,
    filesys.onFileStat((path, info) => {
        // åªæœç´¢æ–‡æœ¬æ–‡ä»¶
        // å…³é”®è¯: æ–‡æœ¬æ–‡ä»¶æœç´¢, æ–‡ä»¶ç±»å‹è¿‡æ»¤, æœç´¢èŒƒå›´
        ext = file.GetExt(path)
        if ext == ".txt" || ext == ".json" || ext == ".log" {
            content, readErr = file.ReadFile(path)
            if readErr == nil {
                // æœç´¢å…³é”®è¯
                // å…³é”®è¯: å…³é”®è¯æœç´¢, å†…å®¹åŒ¹é…, æ–‡æœ¬åŒ¹é…
                contentStr = str.ToLower(string(content))
                keyword = str.ToLower(searchKeyword)
                if str.Contains(contentStr, keyword) {
                    // ç»Ÿè®¡åŒ¹é…æ¬¡æ•°
                    // å…³é”®è¯: åŒ¹é…ç»Ÿè®¡, å‡ºç°æ¬¡æ•°, æœç´¢ç»Ÿè®¡
                    matches = str.Count(contentStr, keyword)
                    searchResults = append(searchResults, {
                        path: path,
                        matches: matches,
                        size: len(content),
                        ext: ext
                    })
                    log.info("Found '%s' in %s (%d matches)", searchKeyword, path, matches)
                }
            }
        }
        return nil
    })
)

assert err == nil, f"å†…å®¹æœç´¢å¤±è´¥: ${err}"
println(f"æœç´¢å…³é”®è¯ '${searchKeyword}' ç»“æœ: ${len(searchResults)}ä¸ªæ–‡ä»¶")

// æŒ‰åŒ¹é…æ¬¡æ•°æ’åº
// å…³é”®è¯: æœç´¢æ’åº, ç»“æœæ’åº, åŒ¹é…æ’åº
for i := 0; i < len(searchResults)-1; i++ {
    for j := i + 1; j < len(searchResults); j++ {
        if searchResults[i].matches < searchResults[j].matches {
            temp = searchResults[i]
            searchResults[i] = searchResults[j]
            searchResults[j] = temp
        }
    }
}

// è¾“å‡ºæœç´¢ç»“æœ
// å…³é”®è¯: æœç´¢ç»“æœ, ç»“æœå±•ç¤º, æœç´¢æŠ¥å‘Š
println("æœç´¢ç»“æœ (æŒ‰åŒ¹é…æ¬¡æ•°æ’åº):")
for i, result in searchResults {
    if i < 5 {  // åªæ˜¾ç¤ºå‰5ä¸ªç»“æœ
        println(f"  ${result.path}: ${result.matches}æ¬¡åŒ¹é…, ${result.size}å­—èŠ‚")
    }
}

if len(searchResults) > 0 {
    println("âœ“ å†…å®¹æœç´¢éªŒè¯é€šè¿‡")
} else {
    println("! æœªæ‰¾åˆ°åŒ¹é…å†…å®¹ï¼Œè¿™å¯èƒ½æ˜¯æ­£å¸¸çš„")
}

// ===== 7.2 æŒ‰æ–‡ä»¶å±æ€§è¿‡æ»¤ =====
// å…³é”®è¯: å±æ€§è¿‡æ»¤, æ–‡ä»¶è¿‡æ»¤, å¤§å°è¿‡æ»¤, æ—¶é—´è¿‡æ»¤
println("\n7.2 æŒ‰æ–‡ä»¶å±æ€§è¿‡æ»¤")
filterResults = {
    largeFiles: [],    // å¤§æ–‡ä»¶
    recentFiles: [],   // æœ€è¿‘æ–‡ä»¶
    smallFiles: [],    // å°æ–‡ä»¶
    oldFiles: []       // æ—§æ–‡ä»¶
}

// è®¾ç½®è¿‡æ»¤æ¡ä»¶
// å…³é”®è¯: è¿‡æ»¤æ¡ä»¶, æ–‡ä»¶å¤§å°é˜ˆå€¼, æ—¶é—´é˜ˆå€¼
sizeThreshold = int64(100)  // 100å­—èŠ‚
timeThreshold = time.Now().Add(-1 * time.Hour).Unix()  // 1å°æ—¶å‰

err = filesys.Recursive(baseTestDir,
    filesys.onFileStat((path, info) => {
        fileSize = info.Size()
        modTime = info.ModTime().Unix()
        
        // æŒ‰å¤§å°åˆ†ç±»
        // å…³é”®è¯: å¤§å°åˆ†ç±», æ–‡ä»¶å¤§å°è¿‡æ»¤, å¤§å°é˜ˆå€¼
        if fileSize > sizeThreshold {
            filterResults.largeFiles = append(filterResults.largeFiles, {
                path: path,
                size: fileSize,
                modTime: modTime
            })
        } else {
            filterResults.smallFiles = append(filterResults.smallFiles, {
                path: path,
                size: fileSize,
                modTime: modTime
            })
        }
        
        // æŒ‰æ—¶é—´åˆ†ç±»
        // å…³é”®è¯: æ—¶é—´åˆ†ç±», æ–‡ä»¶æ—¶é—´è¿‡æ»¤, æ—¶é—´é˜ˆå€¼
        if modTime > timeThreshold {
            filterResults.recentFiles = append(filterResults.recentFiles, {
                path: path,
                size: fileSize,
                modTime: modTime
            })
        } else {
            filterResults.oldFiles = append(filterResults.oldFiles, {
                path: path,
                size: fileSize,
                modTime: modTime
            })
        }
        
        return nil
    })
)

assert err == nil, f"å±æ€§è¿‡æ»¤å¤±è´¥: ${err}"

// è¾“å‡ºè¿‡æ»¤ç»“æœ
// å…³é”®è¯: è¿‡æ»¤ç»“æœ, åˆ†ç±»ç»Ÿè®¡, è¿‡æ»¤æŠ¥å‘Š
println("æ–‡ä»¶å±æ€§è¿‡æ»¤ç»“æœ:")
println(f"  å¤§æ–‡ä»¶ (>${sizeThreshold}å­—èŠ‚): ${len(filterResults.largeFiles)}ä¸ª")
println(f"  å°æ–‡ä»¶ (<=${sizeThreshold}å­—èŠ‚): ${len(filterResults.smallFiles)}ä¸ª")
println(f"  æœ€è¿‘æ–‡ä»¶ (1å°æ—¶å†…): ${len(filterResults.recentFiles)}ä¸ª")
println(f"  è¾ƒæ—§æ–‡ä»¶ (1å°æ—¶å‰): ${len(filterResults.oldFiles)}ä¸ª")

// éªŒè¯è¿‡æ»¤ç»“æœ
// å…³é”®è¯: è¿‡æ»¤éªŒè¯, åˆ†ç±»éªŒè¯, ç»“æœéªŒè¯
totalFiltered = len(filterResults.largeFiles) + len(filterResults.smallFiles)
assert totalFiltered > 0, f"è¿‡æ»¤ç»“æœåº”è¯¥åŒ…å«æ–‡ä»¶ï¼Œå®é™…${totalFiltered}ä¸ª"
println("âœ“ æ–‡ä»¶å±æ€§è¿‡æ»¤éªŒè¯é€šè¿‡")

// =============================================================================
// 8. æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–æ¼”ç¤º
// =============================================================================
println("\n8. æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–æ¼”ç¤º")

// ===== 8.1 å¤§é‡æ–‡ä»¶æ“ä½œæ€§èƒ½æµ‹è¯• =====
// å…³é”®è¯: æ€§èƒ½æµ‹è¯•, å¤§é‡æ–‡ä»¶, æ“ä½œæ€§èƒ½, æ€§èƒ½è¯„ä¼°
println("8.1 å¤§é‡æ–‡ä»¶æ“ä½œæ€§èƒ½æµ‹è¯•")
perfTestDir = baseTestDir + "/performance_test"
err = file.MkdirAll(perfTestDir, 0755)
assert err == nil, f"åˆ›å»ºæ€§èƒ½æµ‹è¯•ç›®å½•å¤±è´¥: ${err}"

// åˆ›å»ºå¤§é‡å°æ–‡ä»¶
// å…³é”®è¯: å¤§é‡æ–‡ä»¶åˆ›å»º, æ€§èƒ½æµ‹è¯•æ–‡ä»¶, æ‰¹é‡åˆ›å»º
fileCount = 200
createStartTime = time.Now()
for i := 0; i < fileCount; i++ {
    fileName = f"${perfTestDir}/perf_file_${i}.txt"
    content = f"Performance test file ${i}\nContent for testing\næ€§èƒ½æµ‹è¯•æ–‡ä»¶${i}"
    err = file.Save(fileName, content)
    assert err == nil, f"åˆ›å»ºæ€§èƒ½æµ‹è¯•æ–‡ä»¶å¤±è´¥: ${fileName}"
}
createDuration = time.Now().Sub(createStartTime)

// æ‰¹é‡è¯»å–æ€§èƒ½æµ‹è¯•
// å…³é”®è¯: æ‰¹é‡è¯»å–, è¯»å–æ€§èƒ½, æ€§èƒ½æµ‹è¯•
readStartTime = time.Now()
readCount = 0
totalReadSize = 0
err = filesys.Recursive(perfTestDir,
    filesys.onFileStat((path, info) => {
        content, readErr = file.ReadFile(path)
        if readErr == nil {
            readCount++
            totalReadSize += len(content)
        }
        return nil
    })
)
readDuration = time.Now().Sub(readStartTime)

assert err == nil, f"æ‰¹é‡è¯»å–æ€§èƒ½æµ‹è¯•å¤±è´¥: ${err}"
assert readCount == fileCount, f"è¯»å–æ–‡ä»¶æ•°ä¸åŒ¹é…ï¼ŒæœŸæœ›${fileCount}ï¼Œå®é™…${readCount}"

// æ‰¹é‡åˆ é™¤æ€§èƒ½æµ‹è¯•
// å…³é”®è¯: æ‰¹é‡åˆ é™¤, åˆ é™¤æ€§èƒ½, æ¸…ç†æ€§èƒ½
deleteStartTime = time.Now()
deleteCount = 0
err = filesys.Recursive(perfTestDir,
    filesys.onFileStat((path, info) => {
        rmErr = file.Rm(path)
        if rmErr == nil {
            deleteCount++
        }
        return nil
    })
)
deleteDuration = time.Now().Sub(deleteStartTime)

// è¾“å‡ºæ€§èƒ½æµ‹è¯•ç»“æœ
// å…³é”®è¯: æ€§èƒ½ç»“æœ, æ€§èƒ½æŠ¥å‘Š, æ€§èƒ½ç»Ÿè®¡
println("æ€§èƒ½æµ‹è¯•ç»“æœ:")
println(f"  åˆ›å»º${fileCount}ä¸ªæ–‡ä»¶: ${createDuration.Milliseconds()} ms (å¹³å‡ ${createDuration.Milliseconds()/int64(fileCount)} ms/æ–‡ä»¶)")
println(f"  è¯»å–${readCount}ä¸ªæ–‡ä»¶: ${readDuration.Milliseconds()} ms (å¹³å‡ ${readDuration.Milliseconds()/int64(readCount)} ms/æ–‡ä»¶)")
println(f"  åˆ é™¤${deleteCount}ä¸ªæ–‡ä»¶: ${deleteDuration.Milliseconds()} ms (å¹³å‡ ${deleteDuration.Milliseconds()/int64(deleteCount)} ms/æ–‡ä»¶)")
println(f"  æ€»è¯»å–æ•°æ®: ${totalReadSize} bytes")

// æ€§èƒ½æ–­è¨€
// å…³é”®è¯: æ€§èƒ½æ–­è¨€, æ€§èƒ½è¦æ±‚, æ€§èƒ½éªŒè¯
assert createDuration.Milliseconds() < 10000, f"åˆ›å»º${fileCount}ä¸ªæ–‡ä»¶ä¸åº”è¶…è¿‡10ç§’ï¼Œå®é™…${createDuration.Milliseconds()}ms"
assert readDuration.Milliseconds() < 5000, f"è¯»å–${fileCount}ä¸ªæ–‡ä»¶ä¸åº”è¶…è¿‡5ç§’ï¼Œå®é™…${readDuration.Milliseconds()}ms"
assert deleteDuration.Milliseconds() < 5000, f"åˆ é™¤${fileCount}ä¸ªæ–‡ä»¶ä¸åº”è¶…è¿‡5ç§’ï¼Œå®é™…${deleteDuration.Milliseconds()}ms"
println("âœ“ æ€§èƒ½æµ‹è¯•éªŒè¯é€šè¿‡")

// =============================================================================
// 9. é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æƒ…å†µæ¼”ç¤º
// =============================================================================
println("\n9. é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æƒ…å†µæ¼”ç¤º")

// ===== 9.1 æƒé™é”™è¯¯å¤„ç† =====
// å…³é”®è¯: æƒé™é”™è¯¯, è®¿é—®æƒé™, é”™è¯¯å¤„ç†, å¼‚å¸¸å¤„ç†
println("9.1 æƒé™é”™è¯¯å¤„ç†")
// æ³¨æ„ï¼šè¿™ä¸ªæµ‹è¯•åœ¨æŸäº›ç³»ç»Ÿä¸Šå¯èƒ½ä¸é€‚ç”¨
restrictedTestDir = "/tmp/restricted_test_" + string(time.Now().Unix())
err = file.MkdirAll(restrictedTestDir, 0755)
if err == nil {
    restrictedFile = restrictedTestDir + "/restricted_file.txt"
    err = file.Save(restrictedFile, "restricted content")
    if err == nil {
        // å°è¯•ä¿®æ”¹æƒé™
        // å…³é”®è¯: æƒé™ä¿®æ”¹, è®¿é—®æ§åˆ¶, æƒé™æµ‹è¯•
        os.Chmod(restrictedFile, 0000)  // ç§»é™¤æ‰€æœ‰æƒé™
        
        // å°è¯•è¯»å–å—é™æ–‡ä»¶
        // å…³é”®è¯: å—é™è®¿é—®, æƒé™é”™è¯¯, è®¿é—®å¤±è´¥
        _, readErr = file.ReadFile(restrictedFile)
        if readErr != nil {
            println(f"âœ“ æƒé™é”™è¯¯æ­£ç¡®å¤„ç†: ${readErr}")
        } else {
            println("! æƒé™æµ‹è¯•è·³è¿‡ï¼ˆå¯èƒ½å…·æœ‰ç‰¹æ®Šæƒé™ï¼‰")
        }
        
        // æ¢å¤æƒé™ä»¥ä¾¿æ¸…ç†
        os.Chmod(restrictedFile, 0644)
        os.RemoveAll(restrictedTestDir)
    }
}

// ===== 9.2 ç£ç›˜ç©ºé—´å’Œèµ„æºé™åˆ¶å¤„ç† =====
// å…³é”®è¯: èµ„æºé™åˆ¶, ç£ç›˜ç©ºé—´, èµ„æºé”™è¯¯, é™åˆ¶å¤„ç†
println("\n9.2 ç£ç›˜ç©ºé—´å’Œèµ„æºé™åˆ¶å¤„ç†")
// åˆ›å»ºä¸€ä¸ªç›¸å¯¹è¾ƒå¤§çš„æ–‡ä»¶æ¥æµ‹è¯•èµ„æºå¤„ç†
largeTestFile = baseTestDir + "/large_test_file.txt"
largeContent = ""
for i := 0; i < 10000; i++ {
    largeContent += f"Large file test line ${i} with some content to make it bigger\n"
}

err = file.Save(largeTestFile, largeContent)
if err != nil {
    println(f"âœ“ å¤§æ–‡ä»¶åˆ›å»ºé”™è¯¯æ­£ç¡®å¤„ç†: ${err}")
} else {
    // éªŒè¯å¤§æ–‡ä»¶
    // å…³é”®è¯: å¤§æ–‡ä»¶éªŒè¯, æ–‡ä»¶å¤§å°éªŒè¯, å†…å®¹éªŒè¯
    largeFileInfo, statErr = file.Stat(largeTestFile)
    if statErr == nil {
        println(f"å¤§æ–‡ä»¶åˆ›å»ºæˆåŠŸ: ${largeFileInfo.Size()} bytes")
        assert largeFileInfo.Size() > 100000, "å¤§æ–‡ä»¶å¤§å°åº”è¯¥è¶…è¿‡100KB"
    }
    println("âœ“ å¤§æ–‡ä»¶å¤„ç†æ­£å¸¸")
}

// ===== 9.3 å¹¶å‘è®¿é—®é”™è¯¯å¤„ç† =====
// å…³é”®è¯: å¹¶å‘è®¿é—®, å¹¶å‘é”™è¯¯, ç«äº‰æ¡ä»¶, å¹¶å‘å¤„ç†
println("\n9.3 å¹¶å‘è®¿é—®é”™è¯¯å¤„ç†")
concurrentTestFile = baseTestDir + "/concurrent_test.txt"
err = file.Save(concurrentTestFile, "initial content")
assert err == nil, f"åˆ›å»ºå¹¶å‘æµ‹è¯•æ–‡ä»¶å¤±è´¥: ${err}"

// æ¨¡æ‹Ÿå¹¶å‘è¯»å†™ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
// å…³é”®è¯: å¹¶å‘æ¨¡æ‹Ÿ, å¹¶å‘è¯»å†™, å¹¶å‘æµ‹è¯•
concurrentErrors = []
for i := 0; i < 5; i++ {
    // å¹¶å‘è¯»å–
    // å…³é”®è¯: å¹¶å‘è¯»å–, åŒæ—¶è®¿é—®, å¹¶å‘å®‰å…¨
    content, readErr = file.ReadFile(concurrentTestFile)
    if readErr != nil {
        concurrentErrors = append(concurrentErrors, f"Read error ${i}: ${readErr}")
    }
    
    // å¹¶å‘å†™å…¥
    // å…³é”®è¯: å¹¶å‘å†™å…¥, åŒæ—¶å†™å…¥, å†™å…¥å†²çª
    writeContent = f"concurrent write ${i} at ${time.Now().Unix()}"
    writeErr = file.Save(concurrentTestFile, writeContent)
    if writeErr != nil {
        concurrentErrors = append(concurrentErrors, f"Write error ${i}: ${writeErr}")
    }
}

if len(concurrentErrors) > 0 {
    println("å¹¶å‘è®¿é—®é”™è¯¯:")
    for err in concurrentErrors {
        println(f"  ${err}")
    }
} else {
    println("âœ“ å¹¶å‘è®¿é—®å¤„ç†æ­£å¸¸")
}

// =============================================================================
// 10. ç»¼åˆåº”ç”¨åœºæ™¯æ¼”ç¤º
// =============================================================================
println("\n10. ç»¼åˆåº”ç”¨åœºæ™¯æ¼”ç¤º")

// ===== 10.1 æ—¥å¿—åˆ†æç³»ç»Ÿ =====
// å…³é”®è¯: æ—¥å¿—åˆ†æ, æ—¥å¿—å¤„ç†, ç³»ç»Ÿåˆ†æ, ç»¼åˆåº”ç”¨
println("10.1 æ—¥å¿—åˆ†æç³»ç»Ÿ")

// åˆ›å»ºæ¨¡æ‹Ÿæ—¥å¿—æ–‡ä»¶
// å…³é”®è¯: æ¨¡æ‹Ÿæ—¥å¿—, æ—¥å¿—æ•°æ®, æµ‹è¯•æ—¥å¿—
logAnalysisDir = baseTestDir + "/log_analysis"
err = file.MkdirAll(logAnalysisDir, 0755)
assert err == nil, f"åˆ›å»ºæ—¥å¿—åˆ†æç›®å½•å¤±è´¥: ${err}"

// ç”Ÿæˆä¸åŒç±»å‹çš„æ—¥å¿—
// å…³é”®è¯: æ—¥å¿—ç”Ÿæˆ, æ—¥å¿—ç±»å‹, æ—¥å¿—å†…å®¹
logTypes = [
    {name: "access.log", entries: [
        "2024-01-01 10:00:01 INFO User login: admin",
        "2024-01-01 10:00:05 INFO Page accessed: /dashboard",
        "2024-01-01 10:00:10 WARN Slow query detected: 2.5s",
        "2024-01-01 10:00:15 ERROR Database timeout",
        "2024-01-01 10:00:20 INFO User logout: admin"
    ]},
    {name: "error.log", entries: [
        "2024-01-01 10:00:03 ERROR Connection refused: database",
        "2024-01-01 10:00:08 ERROR File not found: /tmp/cache.dat",
        "2024-01-01 10:00:13 FATAL System crash detected",
        "2024-01-01 10:00:18 ERROR Memory leak detected"
    ]},
    {name: "system.log", entries: [
        "2024-01-01 10:00:00 INFO System startup",
        "2024-01-01 10:00:02 INFO Services loaded: 15",
        "2024-01-01 10:00:07 WARN High CPU usage: 85%",
        "2024-01-01 10:00:12 INFO Backup completed",
        "2024-01-01 10:00:17 WARN Disk space low: 90%"
    ]}
]

for logType in logTypes {
    logFile = logAnalysisDir + "/" + logType.name
    logContent = str.Join(logType.entries, "\n")
    err = file.Save(logFile, logContent)
    assert err == nil, f"åˆ›å»ºæ—¥å¿—æ–‡ä»¶å¤±è´¥: ${logFile}"
}

// åˆ†ææ—¥å¿—æ–‡ä»¶
// å…³é”®è¯: æ—¥å¿—åˆ†æ, æ—¥å¿—ç»Ÿè®¡, é”™è¯¯ç»Ÿè®¡, æ—¥å¿—å¤„ç†
logAnalysis = {
    totalLines: 0,
    errorCount: 0,
    warnCount: 0,
    infoCount: 0,
    fatalCount: 0,
    files: []
}

err = filesys.Recursive(logAnalysisDir,
    filesys.onFileStat((path, info) => {
        if file.GetExt(path) == ".log" {
            lines, readErr = file.ReadLines(path)
            if readErr == nil {
                fileAnalysis = {
                    path: path,
                    lines: len(lines),
                    errors: 0,
                    warnings: 0,
                    infos: 0,
                    fatals: 0
                }
                
                // åˆ†ææ¯ä¸€è¡Œ
                // å…³é”®è¯: è¡Œåˆ†æ, æ—¥å¿—çº§åˆ«, é”™è¯¯ç»Ÿè®¡
                for line in lines {
                    logAnalysis.totalLines++
                    lineUpper = str.ToUpper(line)
                    
                    if str.Contains(lineUpper, "ERROR") {
                        logAnalysis.errorCount++
                        fileAnalysis.errors++
                    } else if str.Contains(lineUpper, "WARN") {
                        logAnalysis.warnCount++
                        fileAnalysis.warnings++
                    } else if str.Contains(lineUpper, "INFO") {
                        logAnalysis.infoCount++
                        fileAnalysis.infos++
                    } else if str.Contains(lineUpper, "FATAL") {
                        logAnalysis.fatalCount++
                        fileAnalysis.fatals++
                    }
                }
                
                logAnalysis.files = append(logAnalysis.files, fileAnalysis)
                log.info("Analyzed log: %s (%d lines)", path, len(lines))
            }
        }
        return nil
    })
)

assert err == nil, f"æ—¥å¿—åˆ†æå¤±è´¥: ${err}"

// è¾“å‡ºåˆ†æç»“æœ
// å…³é”®è¯: åˆ†æç»“æœ, æ—¥å¿—æŠ¥å‘Š, ç»Ÿè®¡æŠ¥å‘Š
println("æ—¥å¿—åˆ†æç»“æœ:")
println(f"  æ€»è¡Œæ•°: ${logAnalysis.totalLines}")
println(f"  é”™è¯¯: ${logAnalysis.errorCount}")
println(f"  è­¦å‘Š: ${logAnalysis.warnCount}")
println(f"  ä¿¡æ¯: ${logAnalysis.infoCount}")
println(f"  è‡´å‘½: ${logAnalysis.fatalCount}")

println("å„æ–‡ä»¶è¯¦æƒ…:")
for fileAnalysis in logAnalysis.files {
    fileName = file.GetBase(fileAnalysis.path)
    println(f"  ${fileName}: ${fileAnalysis.lines}è¡Œ, é”™è¯¯${fileAnalysis.errors}, è­¦å‘Š${fileAnalysis.warnings}")
}

// éªŒè¯åˆ†æç»“æœ
// å…³é”®è¯: åˆ†æéªŒè¯, ç»“æœéªŒè¯, ç»Ÿè®¡éªŒè¯
assert logAnalysis.totalLines > 0, "åº”è¯¥åˆ†æåˆ°æ—¥å¿—è¡Œ"
assert logAnalysis.errorCount > 0, "åº”è¯¥æ£€æµ‹åˆ°é”™è¯¯æ—¥å¿—"
assert len(logAnalysis.files) == len(logTypes), f"åº”è¯¥åˆ†æ${len(logTypes)}ä¸ªæ–‡ä»¶ï¼Œå®é™…${len(logAnalysis.files)}ä¸ª"
println("âœ“ æ—¥å¿—åˆ†æç³»ç»ŸéªŒè¯é€šè¿‡")

// =============================================================================
// 11. æ¸…ç†æµ‹è¯•ç¯å¢ƒ
// =============================================================================
println("\n11. æ¸…ç†æµ‹è¯•ç¯å¢ƒ")

// æ¸…ç†æ‰€æœ‰æµ‹è¯•ç›®å½•å’Œæ–‡ä»¶
// å…³é”®è¯: ç¯å¢ƒæ¸…ç†, æµ‹è¯•æ¸…ç†, èµ„æºæ¸…ç†, å®Œæ•´æ¸…ç†
cleanupDirs = [baseTestDir]
if file.IsExisted(largeTestFile) {
    err = file.Rm(largeTestFile)
    if err != nil {
        log.warn("æ¸…ç†å¤§æ–‡ä»¶å¤±è´¥: %v", err)
    }
}

for dir in cleanupDirs {
    if file.IsExisted(dir) {
        err = os.RemoveAll(dir)
        if err != nil {
            log.warn("æ¸…ç†ç›®å½•å¤±è´¥ %s: %v", dir, err)
        } else {
            log.info("æ¸…ç†ç›®å½•æˆåŠŸ: %s", dir)
        }
    }
}

println("âœ“ æµ‹è¯•ç¯å¢ƒæ¸…ç†å®Œæˆ")

// =============================================================================
// 12. ç»¼åˆéªŒè¯æ€»ç»“
// =============================================================================
println("\n12. ç»¼åˆéªŒè¯æ€»ç»“")

// åŠŸèƒ½éªŒè¯æ€»ç»“
// å…³é”®è¯: åŠŸèƒ½æ€»ç»“, éªŒè¯æ€»ç»“, æµ‹è¯•æ€»ç»“, ç»¼åˆè¯„ä¼°
functionsVerified = [
    "file.Save - æ–‡ä»¶ä¿å­˜åŠŸèƒ½",
    "file.ReadFile - æ–‡ä»¶è¯»å–åŠŸèƒ½", 
    "file.SaveJson - JSONæ–‡ä»¶ä¿å­˜",
    "file.Create/Open - æ–‡ä»¶åˆ›å»ºå’Œæ‰“å¼€",
    "file.Stat - æ–‡ä»¶ä¿¡æ¯è·å–",
    "file.Cp/Mv/Rm - æ–‡ä»¶å¤åˆ¶ã€ç§»åŠ¨ã€åˆ é™¤",
    "file.Mkdir/MkdirAll - ç›®å½•åˆ›å»º",
    "file.Ls/Dir - ç›®å½•åˆ—è¡¨",
    "file.ReadLines - è¡Œè¯»å–",
    "file.TempFile - ä¸´æ—¶æ–‡ä»¶",
    "file.DetectMIMEType - MIMEç±»å‹æ£€æµ‹",
    "filesys.Recursive - æ–‡ä»¶ç³»ç»Ÿéå†",
    "filesys.NewVirtualFs - è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ",
    "filesys.onFileStat/onDirStat - éå†å›è°ƒ",
    "filesys.Glance - å¿«é€Ÿé¢„è§ˆ",
    "è·¯å¾„æ“ä½œå‡½æ•° - Join/Split/Base/Extç­‰",
    "æ–‡ä»¶ç³»ç»Ÿç»¼åˆåº”ç”¨ - å¤‡ä»½ã€ç›‘æ§ã€åˆ†æç­‰"
]

println("=== file å’Œ filesys åº“ç»¼åˆéªŒè¯å®Œæˆ ===")
println("âœ“ éªŒè¯é€šè¿‡çš„åŠŸèƒ½:")
for i, func in functionsVerified {
    println(f"  ${i+1}. ${func}")
}

println(f"\nâœ“ æ€»è®¡éªŒè¯ ${len(functionsVerified)} é¡¹æ ¸å¿ƒåŠŸèƒ½")
println("âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œfile å’Œ filesys åº“åŠŸèƒ½å®Œæ•´ä¸”æ­£å¸¸")
println("âœ“ åº“çš„é›†æˆä½¿ç”¨å’Œç»¼åˆåº”ç”¨åœºæ™¯éªŒè¯æˆåŠŸ")

// æœ€ç»ˆæ–­è¨€
// å…³é”®è¯: æœ€ç»ˆéªŒè¯, ç»¼åˆæ–­è¨€, å®Œæ•´æ€§æ£€æŸ¥
assert len(functionsVerified) >= 15, f"åº”è¯¥éªŒè¯è‡³å°‘15é¡¹åŠŸèƒ½ï¼Œå®é™…éªŒè¯${len(functionsVerified)}é¡¹"
println("\nğŸ‰ file å’Œ filesys åº“ç»¼åˆæ¼”ç¤ºæ¡ˆä¾‹æ‰§è¡Œå®Œæˆï¼")
