/*
Bot é€šçŸ¥åŠŸèƒ½æµ‹è¯•è„šæœ¬

æœ¬è„šæœ¬ç”¨äºæµ‹è¯• Yaklang çš„ bot é€šçŸ¥åŠŸèƒ½ï¼Œæ”¯æŒé’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€é£ä¹¦ç­‰å¹³å°ã€‚

åŠŸèƒ½ç‰¹æ€§ï¼š
- æ”¯æŒå¤šç§ bot å¹³å°ï¼ˆé£ä¹¦ã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ï¼‰
- æ”¯æŒæ–‡æœ¬å’Œ Markdown æ¶ˆæ¯æ ¼å¼
- æ”¯æŒç¯å¢ƒå˜é‡å’Œç›´æ¥ webhook é…ç½®
- æä¾›å®Œæ•´çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€åé¦ˆ

ä½¿ç”¨æ–¹æ³•ï¼š
1. ä½¿ç”¨ webhook æµ‹è¯•:
   yak bot-test.yak --webhook "https://open.feishu.cn/..."

2. ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰:
   export YAKIT_FEISHU_WEBHOOK="https://open.feishu.cn/..."
   yak bot-test.yak --from-env

3. æŒ‡å®šæµ‹è¯•æ¨¡å¼:
   yak bot-test.yak --from-env --mode text    # åªæµ‹è¯•æ–‡æœ¬æ¶ˆæ¯
   yak bot-test.yak --from-env --mode markdown # åªæµ‹è¯• Markdown æ¶ˆæ¯
   yak bot-test.yak --from-env --mode all     # æµ‹è¯•æ‰€æœ‰åŠŸèƒ½ï¼ˆé»˜è®¤ï¼‰

ç¯å¢ƒå˜é‡é…ç½®ï¼š
- YAKIT_FEISHU_WEBHOOK: é£ä¹¦æœºå™¨äºº webhook URL
- YAKIT_DINGTALK_WEBHOOK: é’‰é’‰æœºå™¨äºº webhook URL  
- YAKIT_DINGTALK_SECRET: é’‰é’‰æœºå™¨äººå¯†é’¥
- YAKIT_WORKWX_WEBHOOK: ä¼ä¸šå¾®ä¿¡æœºå™¨äºº webhook URL

æ³¨æ„äº‹é¡¹ï¼š
- ç¡®ä¿æœºå™¨äººå·²æ­£ç¡®é…ç½®å¹¶æ·»åŠ åˆ°å¯¹åº”ç¾¤ç»„
- é£ä¹¦æœºå™¨äººéœ€è¦åœ¨ç¾¤ç»„ä¸­æœ‰å‘é€æ¶ˆæ¯æƒé™
- é’‰é’‰æœºå™¨äººå¦‚æœå¯ç”¨äº†åŠ ç­¾éªŒè¯ï¼Œéœ€è¦è®¾ç½® SECRET
- æµ‹è¯•æ¶ˆæ¯ä¼šå®é™…å‘é€åˆ°é…ç½®çš„ç¾¤ç»„ä¸­

*/

// å‚æ•°è§£æ
webhook = cli.String("webhook", cli.setDefault(""), cli.setHelp("Bot webhook URL"))
fromEnv = cli.Bool("from-env", cli.setDefault(false), cli.setHelp("Use environment variables"))
testMode = cli.String("mode", cli.setDefault("all"), cli.setHelp("Test mode: text|markdown|all"))

cli.check()

log.Info("=== Bot Notification Test ===")
println("")

// åˆ›å»º bot å®¢æˆ·ç«¯
var botClient

if fromEnv {
    log.Info("Creating bot client from environment variables...")
    botClient = bot.FromEnv()
    if botClient == nil || len(botClient.Configs()) == 0 {
        log.Error("No bot configuration found in environment")
        log.Info("Please set one of:")
        log.Info("  YAKIT_FEISHU_WEBHOOK=https://...")
        log.Info("  YAKIT_DINGTALK_WEBHOOK=https://...")
        log.Info("  YAKIT_WORKWX_WEBHOOK=https://...")
        die("No bot configured")
    }
    log.Info(f"âœ“ Found ${len(botClient.Configs())} bot configuration(s)")
} else if webhook != "" {
    log.Info(f"Creating bot client with webhook: ${webhook}")
    botClient = bot.New(bot.webhook(webhook))
    if len(botClient.Configs()) == 0 {
        die("Failed to create bot client")
    }
    log.Info("âœ“ Bot client created")
} else {
    log.Error("Please provide --webhook or use --from-env")
    die("No bot configuration")
}

println("")

// æµ‹è¯•æ–‡æœ¬æ¶ˆæ¯
if testMode == "text" || testMode == "all" {
    log.Info("Test 1: Sending text message...")
    botClient.SendText("ğŸ‰ Yaklang Bot Test - Text Message\n\nThis is a test message from Yaklang bot module.")
    log.Info("âœ“ Text message sent")
    println("")
    
    sleep(2)
}

// æµ‹è¯• Markdown æ¶ˆæ¯
if testMode == "markdown" || testMode == "all" {
    log.Info("Test 2: Sending markdown message...")
    
    currentTime = time.Now().Format("2006-01-02 15:04:05")
    
    markdown = sprintf(`# Yaklang Bot æµ‹è¯•

## åŠŸèƒ½éªŒè¯

- âœ… æ–‡æœ¬æ¶ˆæ¯å‘é€
- âœ… Markdown æ ¼å¼æ”¯æŒ  
- âœ… å¤šè¡Œå†…å®¹æ”¯æŒ

### ç³»ç»Ÿä¿¡æ¯

**æ—¶é—´**: %s

**æµ‹è¯•é¡¹ç›®**:
1. åŸºç¡€æ–‡æœ¬é€šçŸ¥
2. Markdown æ ¼å¼
3. è¡¨æƒ…ç¬¦å·æ”¯æŒ

---

*Powered by Yaklang* ğŸš€
`, currentTime)
    
    botClient.SendMarkdown(markdown)
    log.Info("âœ“ Markdown message sent")
    println("")
}

log.Info("=== All Tests Completed ===")
log.Info("Please check your bot notification channel to verify the messages")

