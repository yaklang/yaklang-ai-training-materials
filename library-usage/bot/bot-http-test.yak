/*
Bot HTTP ç›´æ¥æµ‹è¯•è„šæœ¬

æœ¬è„šæœ¬ç›´æ¥ä½¿ç”¨ HTTP è¯·æ±‚æµ‹è¯•å„ç§ bot å¹³å°çš„é€šçŸ¥åŠŸèƒ½ï¼Œç»•è¿‡å¯èƒ½å­˜åœ¨é—®é¢˜çš„å°è£…åº“ã€‚
é€‚ç”¨äºè°ƒè¯•å’ŒéªŒè¯ bot webhook çš„åŸºæœ¬åŠŸèƒ½ã€‚

åŠŸèƒ½ç‰¹æ€§ï¼š
- ç›´æ¥ HTTP è°ƒç”¨ï¼Œæ— ä¸­é—´å±‚å°è£…
- æ”¯æŒé£ä¹¦ã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡çš„æ ‡å‡†æ¶ˆæ¯æ ¼å¼
- æä¾›è¯¦ç»†çš„å“åº”ä¿¡æ¯ç”¨äºè°ƒè¯•
- æ”¯æŒæ–‡æœ¬å’Œå¯Œæ–‡æœ¬æ¶ˆæ¯æµ‹è¯•

ä½¿ç”¨æ–¹æ³•ï¼š
1. é£ä¹¦æµ‹è¯•:
   yak bot-http-test.yak --webhook "https://open.feishu.cn/..." --platform feishu

2. é’‰é’‰æµ‹è¯•:
   yak bot-http-test.yak --webhook "https://oapi.dingtalk.com/..." --platform dingtalk

3. ä¼ä¸šå¾®ä¿¡æµ‹è¯•:
   yak bot-http-test.yak --webhook "https://qyapi.weixin.qq.com/..." --platform workwx

4. ä»ç¯å¢ƒå˜é‡æµ‹è¯•:
   export YAKIT_FEISHU_WEBHOOK="https://..."
   yak bot-http-test.yak --from-env --platform feishu

æ”¯æŒçš„å¹³å°ï¼š
- feishu: é£ä¹¦/Lark
- dingtalk: é’‰é’‰  
- workwx: ä¼ä¸šå¾®ä¿¡

æ¶ˆæ¯ç±»å‹ï¼š
- text: çº¯æ–‡æœ¬æ¶ˆæ¯
- markdown: Markdown æ ¼å¼æ¶ˆæ¯ï¼ˆé’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ï¼‰
- rich: å¯Œæ–‡æœ¬æ¶ˆæ¯ï¼ˆé£ä¹¦ï¼‰

*/

// ============================================
// å‚æ•°è§£æ
// ============================================

webhook = cli.String("webhook", cli.setDefault(""), cli.setHelp("Bot webhook URL"))
platform = cli.String("platform", cli.setDefault("feishu"), cli.setHelp("Platform: feishu|dingtalk|workwx"))
fromEnv = cli.Bool("from-env", cli.setDefault(false), cli.setHelp("Use environment variables"))
messageType = cli.String("type", cli.setDefault("text"), cli.setHelp("Message type: text|markdown|rich"))

cli.check()

// ============================================
// è¾…åŠ©å‡½æ•°
// ============================================

// ä»ç¯å¢ƒå˜é‡è·å– webhook
getWebhookFromEnv = func(platform) {
    switch platform {
        case "feishu":
            return os.Getenv("YAKIT_FEISHU_WEBHOOK")
        case "dingtalk":
            return os.Getenv("YAKIT_DINGTALK_WEBHOOK")
        case "workwx":
            return os.Getenv("YAKIT_WORKWX_WEBHOOK")
        default:
            return ""
    }
}

// å‘é€ HTTP è¯·æ±‚
sendHttpMessage = func(webhook, body) {
    log.Info(f"Sending to: ${webhook}")
    log.Info(f"Request body: ${body}")
    
    rsp, err = http.Post(webhook, 
        http.body(body), 
        http.header("Content-Type", "application/json"))
    
    if err != nil {
        log.Error(f"HTTP request failed: ${err}")
        return false
    }
    
    log.Info("Response:")
    responseBody = string(rsp.Raw())
    println(responseBody)
    
    // æ£€æŸ¥å“åº”çŠ¶æ€
    if str.Contains(responseBody, "200 OK") {
        if str.Contains(responseBody, `"code":0`) || str.Contains(responseBody, `"StatusCode":0`) {
            log.Info("âœ… Message sent successfully")
            return true
        }
    }
    
    log.Warn("âš ï¸ Response may indicate an error")
    return false
}

// ç”Ÿæˆé£ä¹¦æ¶ˆæ¯
generateFeishuMessage = func(msgType) {
    currentTime = time.Now().Format("2006-01-02 15:04:05")
    
    if msgType == "text" {
        return sprintf(`{
  "msg_type": "text",
  "content": {
    "text": "ğŸ‰ Yaklang Bot HTTP æµ‹è¯•\n\nâœ… å¹³å°: é£ä¹¦\nğŸ“ æ¶ˆæ¯ç±»å‹: æ–‡æœ¬\nâ° æ—¶é—´: %s\n\nè¿™æ˜¯é€šè¿‡ HTTP ç›´æ¥å‘é€çš„æµ‹è¯•æ¶ˆæ¯ã€‚"
  }
}`, currentTime)
    } else if msgType == "rich" {
        return sprintf(`{
  "msg_type": "post",
  "content": {
    "post": {
      "zh_cn": {
        "title": "Yaklang Bot æµ‹è¯•æŠ¥å‘Š",
        "content": [
          [
            {
              "tag": "text",
              "text": "ğŸ‰ æµ‹è¯•çŠ¶æ€: "
            },
            {
              "tag": "text", 
              "text": "æˆåŠŸ",
              "style": ["bold"]
            }
          ],
          [
            {
              "tag": "text",
              "text": "ğŸ“Š æµ‹è¯•ä¿¡æ¯:\\nâ€¢ å¹³å°: é£ä¹¦\\nâ€¢ ç±»å‹: å¯Œæ–‡æœ¬\\nâ€¢ æ–¹æ³•: HTTP ç›´æ¥è°ƒç”¨"
            }
          ],
          [
            {
              "tag": "text",
              "text": "â° æµ‹è¯•æ—¶é—´: %s"
            }
          ]
        ]
      }
    }
  }
}`, currentTime)
    }
    return ""
}

// ç”Ÿæˆé’‰é’‰æ¶ˆæ¯
generateDingtalkMessage = func(msgType) {
    currentTime = time.Now().Format("2006-01-02 15:04:05")
    
    if msgType == "text" {
        return sprintf(`{
  "msgtype": "text",
  "text": {
    "content": "ğŸ‰ Yaklang Bot HTTP æµ‹è¯•\\n\\nâœ… å¹³å°: é’‰é’‰\\nğŸ“ æ¶ˆæ¯ç±»å‹: æ–‡æœ¬\\nâ° æ—¶é—´: %s\\n\\nè¿™æ˜¯é€šè¿‡ HTTP ç›´æ¥å‘é€çš„æµ‹è¯•æ¶ˆæ¯ã€‚"
  }
}`, currentTime)
    } else if msgType == "markdown" {
        return sprintf(`{
  "msgtype": "markdown",
  "markdown": {
    "title": "Yaklang Bot æµ‹è¯•",
    "text": "# Yaklang Bot æµ‹è¯•æŠ¥å‘Š\\n\\n## æµ‹è¯•ä¿¡æ¯\\n\\n- **å¹³å°**: é’‰é’‰\\n- **ç±»å‹**: Markdown\\n- **æ–¹æ³•**: HTTP ç›´æ¥è°ƒç”¨\\n- **æ—¶é—´**: %s\\n\\n---\\n\\nâœ… **æµ‹è¯•æˆåŠŸï¼**"
  }
}`, currentTime)
    }
    return ""
}

// ç”Ÿæˆä¼ä¸šå¾®ä¿¡æ¶ˆæ¯
generateWorkwxMessage = func(msgType) {
    currentTime = time.Now().Format("2006-01-02 15:04:05")
    
    if msgType == "text" {
        return sprintf(`{
  "msgtype": "text",
  "text": {
    "content": "ğŸ‰ Yaklang Bot HTTP æµ‹è¯•\\n\\nâœ… å¹³å°: ä¼ä¸šå¾®ä¿¡\\nğŸ“ æ¶ˆæ¯ç±»å‹: æ–‡æœ¬\\nâ° æ—¶é—´: %s\\n\\nè¿™æ˜¯é€šè¿‡ HTTP ç›´æ¥å‘é€çš„æµ‹è¯•æ¶ˆæ¯ã€‚"
  }
}`, currentTime)
    } else if msgType == "markdown" {
        return sprintf(`{
  "msgtype": "markdown",
  "markdown": {
    "content": "# Yaklang Bot æµ‹è¯•æŠ¥å‘Š\\n\\n## æµ‹è¯•ä¿¡æ¯\\n\\n- **å¹³å°**: ä¼ä¸šå¾®ä¿¡\\n- **ç±»å‹**: Markdown\\n- **æ–¹æ³•**: HTTP ç›´æ¥è°ƒç”¨\\n- **æ—¶é—´**: %s\\n\\n---\\n\\nâœ… **æµ‹è¯•æˆåŠŸï¼**"
  }
}`, currentTime)
    }
    return ""
}

// ============================================
// ä¸»ç¨‹åº
// ============================================

main = func() {
    log.Info("=== Bot HTTP Direct Test ===")
    log.Info(f"Platform: ${platform}")
    log.Info(f"Message Type: ${messageType}")
    println("")
    
    // è·å– webhook URL
    targetWebhook = webhook
    if fromEnv {
        targetWebhook = getWebhookFromEnv(platform)
        if targetWebhook == "" {
            log.Error(f"No webhook found in environment for platform: ${platform}")
            log.Info("Please set one of:")
            log.Info("  YAKIT_FEISHU_WEBHOOK")
            log.Info("  YAKIT_DINGTALK_WEBHOOK") 
            log.Info("  YAKIT_WORKWX_WEBHOOK")
            die("No webhook configured")
        }
        log.Info(f"Using webhook from environment: ${targetWebhook}")
    } else if targetWebhook == "" {
        log.Error("Please provide --webhook or use --from-env")
        die("No webhook specified")
    }
    
    // ç”Ÿæˆæ¶ˆæ¯ä½“
    var messageBody
    switch platform {
        case "feishu":
            messageBody = generateFeishuMessage(messageType)
        case "dingtalk":
            messageBody = generateDingtalkMessage(messageType)
        case "workwx":
            messageBody = generateWorkwxMessage(messageType)
        default:
            log.Error(f"Unsupported platform: ${platform}")
            die("Invalid platform")
    }
    
    if messageBody == "" {
        log.Error(f"Unsupported message type '${messageType}' for platform '${platform}'")
        die("Invalid message type")
    }
    
    // å‘é€æ¶ˆæ¯
    log.Info(f"Sending ${messageType} message to ${platform}...")
    success = sendHttpMessage(targetWebhook, messageBody)
    
    println("")
    if success {
        log.Info("ğŸ‰ Test completed successfully!")
        log.Info("Please check your bot channel to verify the message was received.")
    } else {
        log.Warn("âš ï¸ Test completed with warnings. Please check the response above.")
    }
}

// æ‰§è¡Œä¸»ç¨‹åº
main()
