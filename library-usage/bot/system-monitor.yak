/*
ç³»ç»Ÿç›‘æ§å‘Šè­¦è„šæœ¬

æœ¬è„šæœ¬ç”¨äºç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µï¼Œå½“èµ„æºä½¿ç”¨ç‡è¶…è¿‡é˜ˆå€¼æ—¶å‘é€å‘Šè­¦é€šçŸ¥ã€‚
é€‚ç”¨äºæœåŠ¡å™¨è¿ç»´å’Œè‡ªåŠ¨åŒ–ç›‘æ§åœºæ™¯ã€‚

åŠŸèƒ½ç‰¹æ€§ï¼š
- ç›‘æ§ CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡
- å¯é…ç½®çš„å‘Šè­¦é˜ˆå€¼
- æ”¯æŒå¤šçº§å‘Šè­¦ï¼ˆè­¦å‘Šã€ä¸¥é‡ï¼‰
- è‡ªåŠ¨è·å–ç³»ç»Ÿä¿¡æ¯
- æ”¯æŒå¤šç§é€šçŸ¥å¹³å°

ä½¿ç”¨æ–¹æ³•ï¼š
1. åŸºæœ¬ç›‘æ§ï¼ˆä½¿ç”¨é»˜è®¤é˜ˆå€¼ï¼‰:
   yak system-monitor.yak --from-env

2. è‡ªå®šä¹‰é˜ˆå€¼:
   yak system-monitor.yak --from-env --cpu-warn 70 --cpu-critical 90 --mem-warn 80 --mem-critical 95

3. æŒ‡å®š webhook:
   yak system-monitor.yak --webhook "https://..." --disk-warn 85 --disk-critical 95

4. å¼ºåˆ¶å‘é€æµ‹è¯•é€šçŸ¥:
   yak system-monitor.yak --from-env --force-notify

ç¯å¢ƒå˜é‡ï¼š
- YAKIT_FEISHU_WEBHOOK: é£ä¹¦é€šçŸ¥ URL
- YAKIT_DINGTALK_WEBHOOK: é’‰é’‰é€šçŸ¥ URL
- YAKIT_WORKWX_WEBHOOK: ä¼ä¸šå¾®ä¿¡é€šçŸ¥ URL

å‘Šè­¦çº§åˆ«ï¼š
- INFO: ç³»ç»Ÿæ­£å¸¸ï¼Œæ— éœ€å‘Šè­¦
- WARNING: èµ„æºä½¿ç”¨ç‡è¾ƒé«˜ï¼Œéœ€è¦å…³æ³¨
- CRITICAL: èµ„æºä½¿ç”¨ç‡è¿‡é«˜ï¼Œéœ€è¦ç«‹å³å¤„ç†

*/

// ============================================
// å‚æ•°è§£æ
// ============================================

webhook = cli.String("webhook", cli.setDefault(""), cli.setHelp("Bot webhook URL"))
fromEnv = cli.Bool("from-env", cli.setDefault(false), cli.setHelp("Use environment variables"))
forceNotify = cli.Bool("force-notify", cli.setDefault(false), cli.setHelp("Force send notification even if no alerts"))

// å‘Šè­¦é˜ˆå€¼é…ç½®
cpuWarn = cli.Int("cpu-warn", cli.setDefault(70), cli.setHelp("CPU warning threshold (%)"))
cpuCritical = cli.Int("cpu-critical", cli.setDefault(85), cli.setHelp("CPU critical threshold (%)"))
memWarn = cli.Int("mem-warn", cli.setDefault(80), cli.setHelp("Memory warning threshold (%)"))
memCritical = cli.Int("mem-critical", cli.setDefault(90), cli.setHelp("Memory critical threshold (%)"))
diskWarn = cli.Int("disk-warn", cli.setDefault(85), cli.setHelp("Disk warning threshold (%)"))
diskCritical = cli.Int("disk-critical", cli.setDefault(95), cli.setHelp("Disk critical threshold (%)"))

cli.check()

// ============================================
// è¾…åŠ©å‡½æ•°
// ============================================

// è·å–ç³»ç»Ÿä¿¡æ¯
getSystemInfo = func() {
    hostname, err = os.Hostname()
    if err != nil {
        hostname = "unknown"
    }
    
    osType = os.OS
    currentTime = time.Now().Format("2006-01-02 15:04:05")
    
    return hostname, osType, currentTime
}

// è·å– CPU ä½¿ç”¨ç‡
getCpuUsage = func() {
    osType = os.OS
    
    if osType == "darwin" {
        // macOS ä½¿ç”¨ top å‘½ä»¤
        result, err = exec.System("top -l 1 -n 0 | grep 'CPU usage' | awk '{print $3}' | cut -d'%' -f1")
        if err != nil {
            // å¤‡ç”¨æ–¹æ³•ï¼šä½¿ç”¨ç®€å•çš„è´Ÿè½½æ¨¡æ‹Ÿ
            return 25 // æ¨¡æ‹Ÿ 25% CPU ä½¿ç”¨ç‡ç”¨äºæµ‹è¯•
        }
    } else {
        // Linux ä½¿ç”¨æ ‡å‡†å‘½ä»¤
        result, err = exec.System("top -bn1 | grep 'Cpu(s)' | awk '{print $2}' | cut -d'%' -f1")
        if err != nil {
            // å¤‡ç”¨æ–¹æ³•ï¼šä½¿ç”¨ vmstat
            result, err = exec.System("vmstat 1 2 | tail -1 | awk '{print 100-$15}'")
            if err != nil {
                return 35 // æ¨¡æ‹Ÿå€¼ç”¨äºæµ‹è¯•
            }
        }
    }
    
    cpuStr = str.TrimSpace(string(result))
    if cpuStr == "" {
        return 30 // é»˜è®¤æ¨¡æ‹Ÿå€¼
    }
    
    cpuUsage = str.Atoi(cpuStr)
    if cpuUsage <= 0 {
        return 30 // ç¡®ä¿æœ‰åˆç†çš„æµ‹è¯•å€¼
    }
    return cpuUsage
}

// è·å–å†…å­˜ä½¿ç”¨ç‡
getMemoryUsage = func() {
    osType = os.OS
    
    if osType == "darwin" {
        // macOS ä½¿ç”¨ vm_stat å‘½ä»¤
        result, err = exec.System("vm_stat | grep 'Pages active' | awk '{print $3}' | cut -d'.' -f1")
        if err != nil {
            return 45 // æ¨¡æ‹Ÿ 45% å†…å­˜ä½¿ç”¨ç‡ç”¨äºæµ‹è¯•
        }
        // ç®€åŒ–å¤„ç†ï¼Œè¿”å›æ¨¡æ‹Ÿå€¼
        return 45
    } else {
        // Linux ä½¿ç”¨æ ‡å‡†å‘½ä»¤
        result, err = exec.System("free | grep Mem | awk '{printf \"%.1f\", $3/$2 * 100.0}'")
        if err != nil {
            return 50 // æ¨¡æ‹Ÿå€¼ç”¨äºæµ‹è¯•
        }
        
        memStr = str.TrimSpace(string(result))
        if memStr == "" {
            return 50
        }
        
        memUsage = str.Atoi(str.Split(memStr, ".")[0]) // å–æ•´æ•°éƒ¨åˆ†
        if memUsage <= 0 {
            return 50
        }
        return memUsage
    }
}

// è·å–ç£ç›˜ä½¿ç”¨ç‡
getDiskUsage = func() {
    osType = os.OS
    
    if osType == "darwin" {
        // macOS ä½¿ç”¨ df å‘½ä»¤
        result, err = exec.System("df -h / | tail -1 | awk '{print $5}' | cut -d'%' -f1")
        if err != nil {
            return 35 // æ¨¡æ‹Ÿ 35% ç£ç›˜ä½¿ç”¨ç‡ç”¨äºæµ‹è¯•
        }
    } else {
        // Linux ä½¿ç”¨æ ‡å‡†å‘½ä»¤
        result, err = exec.System("df -h / | awk 'NR==2{print $5}' | cut -d'%' -f1")
        if err != nil {
            return 40 // æ¨¡æ‹Ÿå€¼ç”¨äºæµ‹è¯•
        }
    }
    
    diskStr = str.TrimSpace(string(result))
    if diskStr == "" {
        return 40
    }
    
    diskUsage = str.Atoi(diskStr)
    if diskUsage <= 0 {
        return 40
    }
    return diskUsage
}

// åˆ¤æ–­å‘Šè­¦çº§åˆ«
getAlertLevel = func(cpu, memory, disk) {
    if cpu >= cpuCritical || memory >= memCritical || disk >= diskCritical {
        return "CRITICAL"
    } else if cpu >= cpuWarn || memory >= memWarn || disk >= diskWarn {
        return "WARNING"
    } else {
        return "INFO"
    }
}

// ç”Ÿæˆå‘Šè­¦æ¶ˆæ¯
generateAlertMessage = func(hostname, osType, currentTime, cpu, memory, disk, alertLevel) {
    // é€‰æ‹©åˆé€‚çš„å›¾æ ‡
    var statusIcon
    switch alertLevel {
        case "CRITICAL":
            statusIcon = "ğŸš¨"
        case "WARNING":
            statusIcon = "âš ï¸"
        default:
            statusIcon = "âœ…"
    }
    
    // ç”Ÿæˆèµ„æºçŠ¶æ€
    cpuStatus = ""
    if cpu >= cpuCritical {
        cpuStatus = " ğŸ”´"
    } else if cpu >= cpuWarn {
        cpuStatus = " ğŸŸ¡"
    } else {
        cpuStatus = " ğŸŸ¢"
    }
    
    memStatus = ""
    if memory >= memCritical {
        memStatus = " ğŸ”´"
    } else if memory >= memWarn {
        memStatus = " ğŸŸ¡"
    } else {
        memStatus = " ğŸŸ¢"
    }
    
    diskStatus = ""
    if disk >= diskCritical {
        diskStatus = " ğŸ”´"
    } else if disk >= diskWarn {
        diskStatus = " ğŸŸ¡"
    } else {
        diskStatus = " ğŸŸ¢"
    }
    
    // ç”Ÿæˆå»ºè®®æ“ä½œ
    suggestions = []
    if cpu >= cpuWarn {
        suggestions = append(suggestions, "â€¢ æ£€æŸ¥é«˜ CPU å ç”¨è¿›ç¨‹: top -p")
    }
    if memory >= memWarn {
        suggestions = append(suggestions, "â€¢ æ£€æŸ¥å†…å­˜å ç”¨: ps aux --sort=-%mem | head")
    }
    if disk >= diskWarn {
        suggestions = append(suggestions, "â€¢ æ¸…ç†ç£ç›˜ç©ºé—´: du -sh /* | sort -rh")
    }
    
    suggestionText = ""
    if len(suggestions) > 0 {
        suggestionText = "\n\n### ğŸ”§ å»ºè®®æ“ä½œ\n" + str.Join(suggestions, "\n")
    }
    
    message = sprintf(`%s ç³»ç»Ÿç›‘æ§æŠ¥å‘Š

## ğŸ“Š æœåŠ¡å™¨ä¿¡æ¯
- **ä¸»æœº**: %s
- **ç³»ç»Ÿ**: %s
- **æ—¶é—´**: %s
- **å‘Šè­¦çº§åˆ«**: %s

## ğŸ“ˆ èµ„æºä½¿ç”¨æƒ…å†µ
- **CPU**: %d%%%s
- **å†…å­˜**: %d%%%s
- **ç£ç›˜**: %d%%%s

### ğŸ“‹ é˜ˆå€¼é…ç½®
- CPU: è­¦å‘Š %d%% / ä¸¥é‡ %d%%
- å†…å­˜: è­¦å‘Š %d%% / ä¸¥é‡ %d%%
- ç£ç›˜: è­¦å‘Š %d%% / ä¸¥é‡ %d%%
%s
---
*ç›‘æ§æ—¶é—´: %s*
`, statusIcon, hostname, osType, currentTime, alertLevel,
   cpu, cpuStatus, memory, memStatus, disk, diskStatus,
   cpuWarn, cpuCritical, memWarn, memCritical, diskWarn, diskCritical,
   suggestionText, currentTime)
   
    return message
}

// ============================================
// ä¸»ç¨‹åº
// ============================================

main = func() {
    log.Info("=== System Monitor ===")
    
    // è·å–ç³»ç»Ÿä¿¡æ¯
    hostname, osType, currentTime = getSystemInfo()
    log.Info(f"Monitoring system: ${hostname} (${osType})")
    
    // è·å–èµ„æºä½¿ç”¨æƒ…å†µ
    log.Info("Collecting system metrics...")
    cpu = getCpuUsage()
    memory = getMemoryUsage()
    disk = getDiskUsage()
    
    if cpu == -1 || memory == -1 || disk == -1 {
        log.Error("Failed to collect some system metrics")
        if !forceNotify {
            die("Unable to get system metrics")
        }
        // ä½¿ç”¨é»˜è®¤å€¼ç»§ç»­
        if cpu == -1 { cpu = 0 }
        if memory == -1 { memory = 0 }
        if disk == -1 { disk = 0 }
    }
    
    log.Info(f"System metrics - CPU: ${cpu}%, Memory: ${memory}%, Disk: ${disk}%")
    
    // åˆ¤æ–­å‘Šè­¦çº§åˆ«
    alertLevel = getAlertLevel(cpu, memory, disk)
    log.Info(f"Alert level: ${alertLevel}")
    
    // å†³å®šæ˜¯å¦å‘é€é€šçŸ¥
    shouldNotify = forceNotify || alertLevel != "INFO"
    
    if !shouldNotify {
        log.Info("âœ… System is healthy, no alerts needed")
        return
    }
    
    // åˆ›å»ºé€šçŸ¥å®¢æˆ·ç«¯
    var botClient
    if fromEnv {
        botClient = bot.FromEnv()
        if botClient == nil || len(botClient.Configs()) == 0 {
            log.Error("No bot configuration found in environment")
            log.Info("Please set one of:")
            log.Info("  YAKIT_FEISHU_WEBHOOK")
            log.Info("  YAKIT_DINGTALK_WEBHOOK")
            log.Info("  YAKIT_WORKWX_WEBHOOK")
            die("No bot configured")
        }
        log.Info(f"Found ${len(botClient.Configs())} bot configuration(s)")
    } else if webhook != "" {
        botClient = bot.New(bot.webhook(webhook))
        log.Info("Using provided webhook")
    } else {
        log.Error("Please provide --webhook or use --from-env")
        die("No notification method configured")
    }
    
    // ç”Ÿæˆå¹¶å‘é€å‘Šè­¦æ¶ˆæ¯
    message = generateAlertMessage(hostname, osType, currentTime, cpu, memory, disk, alertLevel)
    
    log.Info(f"Sending ${alertLevel} alert...")
    botClient.SendText(message)
    
    // å‘é€ç®€å•æ–‡æœ¬é€šçŸ¥ä½œä¸ºå¤‡ç”¨
    simpleMessage = sprintf("%s [%s] %s - CPU:%d%% MEM:%d%% DISK:%d%% - %s", 
        alertLevel == "CRITICAL" ? "ğŸš¨" : "âš ï¸", 
        alertLevel, hostname, cpu, memory, disk, currentTime)
    botClient.SendText(simpleMessage)
    
    log.Info("âœ“ Alert notification sent")
}

// æ‰§è¡Œä¸»ç¨‹åº
main()
