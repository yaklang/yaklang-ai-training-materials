/*
# éƒ¨ç½²é€šçŸ¥è„šæœ¬

ç”¨äº CI/CD æµç¨‹ä¸­å‘é€éƒ¨ç½²çŠ¶æ€é€šçŸ¥åˆ°é£ä¹¦/é’‰é’‰/ä¼ä¸šå¾®ä¿¡ã€‚

## ä½¿ç”¨æ–¹æ³•

```bash
# æˆåŠŸéƒ¨ç½²é€šçŸ¥
yak deploy-notify.yak --service my-app --status success --version v1.0.0

# å¤±è´¥éƒ¨ç½²é€šçŸ¥  
yak deploy-notify.yak --service my-app --status failed --error "Port 8080 already in use"

# æŒ‡å®šä¸»æœº
yak deploy-notify.yak --service my-app --status success --host production.example.com
```

## ç¯å¢ƒå˜é‡

éœ€è¦è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ä¹‹ä¸€ï¼š
- YAKIT_FEISHU_WEBHOOK
- YAKIT_DINGTALK_WEBHOOK  
- YAKIT_WORKWX_WEBHOOK

*/

// ============================================
// å‚æ•°è§£æ
// ============================================

serviceName = cli.String("service", cli.setRequired(true), cli.setHelp("Service name"))
status = cli.String("status", cli.setRequired(true), cli.setHelp("Deployment status: success/failed"))
version = cli.String("version", cli.setDefault("unknown"), cli.setHelp("Service version"))
host = cli.String("host", cli.setDefault("localhost"), cli.setHelp("Target host"))
port = cli.Int("port", cli.setDefault(8080), cli.setHelp("Service port"))
errorMsg = cli.String("error", cli.setDefault(""), cli.setHelp("Error message for failed deployments"))
environment = cli.String("env", cli.setDefault("production"), cli.setHelp("Environment: dev/staging/production"))

cli.check()

// ============================================
// è¾…åŠ©å‡½æ•°
// ============================================

getCurrentTime = func() {
    return time.Now().Format("2006-01-02 15:04:05")
}

getStatusIcon = func(status) {
    if status == "success" {
        return "âœ…"
    } else {
        return "âŒ"
    }
}

getEnvironmentIcon = func(env) {
    switch env {
        case "production":
            return "ğŸš€"
        case "staging":
            return "ğŸ§ª"
        case "dev":
            return "ğŸ”§"
        default:
            return "ğŸ“¦"
    }
}

// ============================================
// ä¸»ç¨‹åº
// ============================================

main = func() {
    log.Info("=== Deployment Notification ===")
    
    // åˆ›å»ºé€šçŸ¥å®¢æˆ·ç«¯
    client = bot.FromEnv()
    if client == nil || len(client.Configs()) == 0 {
        log.Error("No bot configuration found")
        log.Info("Please set one of the following environment variables:")
        log.Info("  YAKIT_FEISHU_WEBHOOK=https://...")
        log.Info("  YAKIT_DINGTALK_WEBHOOK=https://...")
        log.Info("  YAKIT_WORKWX_WEBHOOK=https://...")
        die("No bot configured")
    }
    
    log.Info(f"Found ${len(client.Configs())} bot configuration(s)")
    
    // ç”Ÿæˆé€šçŸ¥æ¶ˆæ¯
    statusIcon = getStatusIcon(status)
    envIcon = getEnvironmentIcon(environment)
    currentTime = getCurrentTime()
    
    if status == "success" {
        // æˆåŠŸéƒ¨ç½²é€šçŸ¥
        markdown = sprintf(`%s éƒ¨ç½²æˆåŠŸ

## %s æœåŠ¡ä¿¡æ¯
- **æœåŠ¡å**: %s
- **ç‰ˆæœ¬**: %s
- **ç¯å¢ƒ**: %s %s
- **ä¸»æœº**: %s
- **ç«¯å£**: %d
- **æ—¶é—´**: %s

### ğŸ”— å¿«é€Ÿé“¾æ¥
- [å¥åº·æ£€æŸ¥](http://%s:%d/health)
- [æœåŠ¡çŠ¶æ€](http://%s:%d/status)
- [API æ–‡æ¡£](http://%s:%d/docs)

### ğŸ“Š ç›‘æ§é¢æ¿
- [Grafana Dashboard](http://%s:3000)
- [æ—¥å¿—æŸ¥çœ‹](http://%s:5601)

---
ğŸ‰ **éƒ¨ç½²å®Œæˆï¼ŒæœåŠ¡æ­£å¸¸è¿è¡Œï¼**

*éƒ¨ç½²æ—¶é—´: %s*
`, statusIcon, envIcon, serviceName, version, environment, envIcon, host, port, currentTime, 
   host, port, host, port, host, port, host, host, currentTime)
        
        client.SendMarkdown(markdown)
        log.Info("âœ“ Success notification sent")
        
    } else {
        // å¤±è´¥éƒ¨ç½²é€šçŸ¥
        errorDetails = errorMsg
        if errorDetails == "" {
            errorDetails = "æœªçŸ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—"
        }
        
        markdown = sprintf(`%s éƒ¨ç½²å¤±è´¥

## %s æœåŠ¡ä¿¡æ¯
- **æœåŠ¡å**: %s
- **ç‰ˆæœ¬**: %s
- **ç¯å¢ƒ**: %s %s
- **ä¸»æœº**: %s
- **æ—¶é—´**: %s

### âŒ é”™è¯¯ä¿¡æ¯
%s

### ğŸ”§ å¤„ç†å»ºè®®
1. **æ£€æŸ¥æœåŠ¡æ—¥å¿—**: journalctl -u %s -f
2. **éªŒè¯é…ç½®æ–‡ä»¶**: æ£€æŸ¥ç¯å¢ƒå˜é‡å’Œä¾èµ–æœåŠ¡
3. **ç«¯å£æ£€æŸ¥**: netstat -tulpn | grep %d
4. **èµ„æºæ£€æŸ¥**: df -h && free -h
5. **å›æ»šæ“ä½œ**: systemctl stop %s && systemctl start %s

---
âš ï¸ **è¯·åŠæ—¶å¤„ç†éƒ¨ç½²é—®é¢˜ï¼**

*å¤±è´¥æ—¶é—´: %s*
`, statusIcon, envIcon, serviceName, version, environment, envIcon, host, currentTime,
   errorDetails, serviceName, port, serviceName, serviceName, currentTime)
        
        client.SendMarkdown(markdown)
        log.Error("âœ— Failure notification sent")
    }
    
    // å‘é€ç®€å•æ–‡æœ¬é€šçŸ¥ï¼ˆå¤‡ç”¨ï¼‰
    simpleMessage = sprintf("%s [%s] %s éƒ¨ç½²%s - %s (%s)", 
        statusIcon, environment, serviceName, 
        status == "success" ? "æˆåŠŸ" : "å¤±è´¥", 
        version, currentTime)
    
    client.SendText(simpleMessage)
    
    log.Info("=== Notification Complete ===")
}

// æ‰§è¡Œä¸»ç¨‹åº
main()
