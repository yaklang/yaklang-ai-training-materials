#!/usr/bin/env yak

// è¯Šæ–­ï¼šæ£€æŸ¥å¯¼å…¥åå‘é‡æ–‡æ¡£ä¸çŸ¥è¯†æ¡ç›®çš„å…³è”å…³ç³»

ragFile = "/tmp/caps_v1.rag"  // ä½¿ç”¨æ–°æ ¼å¼æ–‡ä»¶
collectionName = "test-diagnose"

log.info("=== Diagnose: Vector-Knowledge Association ===")
log.info("ğŸ“ RAG File: %s", ragFile)

// å¯¼å…¥
rag.DeleteCollection(collectionName)
err = rag.Import(ragFile, rag.importName(collectionName))
if err != nil {
    log.error("âŒ Import failed: %v", err)
    die(err)
}
log.info("âœ“ Import successful")

// è·å– RAG ç³»ç»Ÿ
ragSystem, err = rag.Get(collectionName)
if err != nil {
    die(err)
}

// ç»Ÿè®¡
vectorCount, _ = ragSystem.CountDocuments()
log.info("ğŸ“Š Vector documents: %d", vectorCount)

// è·å–æ‰€æœ‰çŸ¥è¯†æ¡ç›®
entries, err = rag.DBQueryKnowledge("", rag.dbQueryCollection(collectionName), rag.dbQueryLimit(1000))
if err != nil {
    log.error("Query knowledge failed: %v", err)
}
log.info("ğŸ“Š Knowledge entries: %d", len(entries))

// æ‰“å°å‰ 3 ä¸ªçŸ¥è¯†æ¡ç›®
log.info("")
log.info("=== Sample Knowledge Entries ===")
for i, entry := range entries {
    if i >= 3 {
        break
    }
    log.info("%d. Title: %s", i+1, entry.KnowledgeTitle)
    log.info("   HiddenIndex: %s", entry.HiddenIndex)
    log.info("   KnowledgeBaseID: %d", entry.KnowledgeBaseID)
    log.info("   ID: %d", entry.ID)
}

// è·å–å‘é‡æ–‡æ¡£å¹¶æ£€æŸ¥å…³è”
log.info("")
log.info("=== Sample Vector Documents ===")
vectorDocs, err = rag.DBQueryVectorDocument("", rag.dbQueryCollection(collectionName), rag.dbQueryLimit(10))
if err != nil {
    log.error("Query vector failed: %v", err)
}

for i, doc := range vectorDocs {
    if i >= 5 {
        break
    }
    log.info("%d. DocumentID: %s", i+1, doc.DocumentID)
    
    // è·å– META_Data_UUID
    metaUUID = ""
    if doc.Metadata != nil {
        for k, v := range doc.Metadata {
            if k == "uuid" || k == "data_uuid" {
                metaUUID = sprintf("%v", v)
            }
        }
    }
    log.info("   Metadata: %v", doc.Metadata)
    log.info("   META_Data_UUID: %s", metaUUID)
    
    // æ£€æŸ¥æ˜¯å¦èƒ½æ‰¾åˆ°å¯¹åº”çš„çŸ¥è¯†æ¡ç›®
    foundEntry = false
    for _, entry := range entries {
        if entry.HiddenIndex == metaUUID {
            foundEntry = true
            log.info("   âœ“ Found matching entry: %s", entry.KnowledgeTitle)
            break
        }
    }
    if !foundEntry && metaUUID != "" {
        log.warn("   âŒ No matching entry for UUID: %s", metaUUID)
    }
}

// æ¸…ç†
rag.DeleteCollection(collectionName)
log.info("")
log.info("=== Diagnose Complete ===")

