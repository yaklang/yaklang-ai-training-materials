// =============================================================================
// Embedding TOTP æœåŠ¡æµ‹è¯•è„šæœ¬
// åŠŸèƒ½: æµ‹è¯•æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ TOTP éªŒè¯å’Œè¿æ¥
// ç”¨é€”: éªŒè¯ embedding æœåŠ¡çš„ TOTP è®¤è¯åŠŸèƒ½
// =============================================================================

println("=== Embedding TOTP æœåŠ¡æµ‹è¯• ===\n")

// é…ç½®
testSecret = "test-secret-12345"
testPort = 18099

println("é…ç½®:")
println(f"  TOTP Secret: ${testSecret}")
println(f"  Port: ${testPort}")
println()

// =============================================================================
// æ­¥éª¤ 1: å¯åŠ¨ Mock Embedding æœåŠ¡
// =============================================================================

println("æ­¥éª¤ 1: å¯åŠ¨ Mock Embedding æœåŠ¡...")

// åœ¨åå°å¯åŠ¨æœåŠ¡å™¨
go fn {
    err = httpserver.Serve("127.0.0.1", testPort, httpserver.handler((rsp, req) => {
        log.info("Received request: %s %s from %s", req.Method, req.URL.Path, req.RemoteAddr)
        
        // æ£€æŸ¥è·¯å¾„
        if req.URL.Path != "/embeddings" {
            rsp.WriteHeader(404)
            rsp.Write(b`{"error": {"message": "Not Found"}}`)
            return
        }
        
        // åªæ¥å— POST è¯·æ±‚
        if req.Method != "POST" {
            rsp.WriteHeader(405)
            rsp.Write(b`{"error": {"message": "Method Not Allowed"}}`)
            return
        }
        
        // éªŒè¯ TOTP
        totpCode = req.Header.Get("X-TOTP-Code")
        if totpCode == "" {
            log.warn("Missing TOTP code")
            rsp.WriteHeader(401)
            rsp.Write(b`{"error": {"message": "Missing X-TOTP-Code header"}}`)
            return
        }
        
        // éªŒè¯ TOTP ç 
        if !twofa.VerifyUTCCode(testSecret, totpCode) {
            log.warn("Invalid TOTP code: %s", totpCode)
            rsp.WriteHeader(401)
            rsp.Write(b`{"error": {"message": "Invalid TOTP code"}}`)
            return
        }
        
        log.info("TOTP verification passed")
        
        // è¯»å–è¯·æ±‚ä½“
        body, _ = io.ReadAll(req.Body)
        
        // è¿”å› mock embedding å“åº”
        mockResponse = json.dumps({
            "object": "list",
            "data": [{
                "object": "embedding",
                "embedding": [0.1, 0.2, 0.3, 0.4, 0.5],
                "index": 0,
            }],
            "model": "test-embedding-model",
        })
        
        rsp.Header().Set("Content-Type", "application/json")
        rsp.WriteHeader(200)
        rsp.Write(mockResponse)
        
        log.info("Request completed successfully")
    }))
    
    if err != nil {
        log.error("Failed to start server: %v", err)
    }
}

// ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
sleep(2)
println("âœ“ Mock æœåŠ¡å™¨å·²å¯åŠ¨åœ¨ 127.0.0.1:${testPort}")
println()

// =============================================================================
// æ­¥éª¤ 2: æµ‹è¯•å®¢æˆ·ç«¯è¿æ¥
// =============================================================================

println("æ­¥éª¤ 2: æµ‹è¯•å®¢æˆ·ç«¯è¿æ¥...")

// ç”Ÿæˆ TOTP éªŒè¯ç 
totpCode = twofa.GetUTCCode(testSecret)
println(f"âœ“ ç”Ÿæˆ TOTP ç : ${totpCode}")

// æ„å»ºè¯·æ±‚ä½“
requestBody = json.dumps({
    "input": "test text for embedding",
    "model": "embedding",
})

// æ„å»ºæœåŠ¡å™¨åœ°å€
serverHost = "127.0.0.1"

// å‘é€è¯·æ±‚
println(f"âœ“ å‘é€è¯·æ±‚åˆ° http://${serverHost}:${testPort}/embeddings...")

rsp, _, err = poc.HTTP(
    f`POST /embeddings HTTP/1.1
Host: ${serverHost}
Content-Type: application/json
X-TOTP-Code: ${totpCode}
Content-Length: ${len(requestBody)}

${requestBody}`,
    poc.host(serverHost),
    poc.port(testPort),
    poc.timeout(10),
)

if err != nil {
    println(f"âœ— è¯·æ±‚å¤±è´¥: ${err}")
    die("Request failed")
}

// =============================================================================
// æ­¥éª¤ 3: éªŒè¯å“åº”
// =============================================================================

println()
println("æ­¥éª¤ 3: éªŒè¯å“åº”...")

// è·å–çŠ¶æ€ç 
statusCode = poc.GetStatusCodeFromResponse(rsp)~

// æå–å“åº”ä½“
_, body = poc.Split(rsp)
println(f"âœ“ çŠ¶æ€ç : ${statusCode}")

if statusCode != 200 {
    println(f"âœ— è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${statusCode}")
    println(f"å“åº”: ${string(body)}")
    die("Request failed with non-200 status")
}

// è§£æå“åº”
responseData = json.loads(body)

println(f"âœ“ å“åº”è§£ææˆåŠŸ")
println(f"  Model: ${responseData['model']}")
println(f"  Object: ${responseData['object']}")
println(f"  Embedding Length: ${len(responseData['data'][0]['embedding'])}")
println()

// =============================================================================
// æ­¥éª¤ 4: æµ‹è¯•é”™è¯¯æƒ…å†µ
// =============================================================================

println("æ­¥éª¤ 4: æµ‹è¯•é”™è¯¯çš„ TOTP ç ...")

invalidCode = "000000"

badRsp, _, _ = poc.HTTP(
    f`POST /embeddings HTTP/1.1
Host: ${serverHost}
Content-Type: application/json
X-TOTP-Code: ${invalidCode}
Content-Length: ${len(requestBody)}

${requestBody}`,
    poc.host(serverHost),
    poc.port(testPort),
    poc.timeout(10),
)

badStatusCode = poc.GetStatusCodeFromResponse(badRsp)~
println(f"âœ“ ä½¿ç”¨é”™è¯¯ TOTP ç  '${invalidCode}' çš„çŠ¶æ€ç : ${badStatusCode}")

if badStatusCode == 401 {
    println("âœ“ æœåŠ¡æ­£ç¡®æ‹’ç»äº†é”™è¯¯çš„ TOTP ç ")
} else {
    println(f"âœ— é¢„æœŸçŠ¶æ€ç  401ï¼Œå®é™…: ${badStatusCode}")
}

println()

// =============================================================================
// æµ‹è¯•å®Œæˆ
// =============================================================================

println("=== æµ‹è¯•ç»“æœ ===")
println("âœ“ æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ")
println("âœ“ TOTP éªŒè¯æˆåŠŸ")
println("âœ“ å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ")
println("âœ“ å“åº”æ ¼å¼æ­£ç¡®")
println("âœ“ é”™è¯¯å¤„ç†æ­£ç¡®")
println()
println("æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ ğŸ‰")
println()
println("æç¤º: çœŸå®çš„æœåŠ¡ç«¯è„šæœ¬éœ€è¦:")
println("1. å®‰è£… llama-server: toolbox.Install(\"llama-server\")")
println("2. å®‰è£…æ¨¡å‹: toolbox.Install(\"model-Qwen3-Embedding-0.6B-Q4\")")
println("3. ç¡®ä¿ llama-server åœ¨ 127.0.0.1:11435 è¿è¡Œ")

log.info("Test completed successfully")

