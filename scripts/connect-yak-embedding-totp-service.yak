// =============================================================================
// Yak Embedding TOTP Service Client - è¿æ¥å¸¦ TOTP éªŒè¯çš„ Embedding æœåŠ¡å®¢æˆ·ç«¯
// åŠŸèƒ½: è¿æ¥åˆ° Yak Embedding TOTP æœåŠ¡ï¼Œä½¿ç”¨ TOTP éªŒè¯ç è¿›è¡Œèº«ä»½éªŒè¯
// ç”¨é€”: å®‰å…¨åœ°è°ƒç”¨ embedding æœåŠ¡ã€ç”Ÿæˆæ–‡æœ¬å‘é‡ã€è¯­ä¹‰æœç´¢å®¢æˆ·ç«¯
//
// æ ¸å¿ƒæŠ€æœ¯æ ˆ:
// - twofa.GetUTCCode: ç”Ÿæˆ UTC æ—¶é—´çš„ TOTP éªŒè¯ç 
// - poc.HTTP: å‘é€ HTTP è¯·æ±‚
// - json.loads/json.dumps: JSON æ•°æ®å¤„ç†
//
// ä½¿ç”¨ç¤ºä¾‹:
// yak scripts/connect-yak-embedding-totp-service.yak --host 127.0.0.1 --port 9099 --totp-secret my-secret-key --text "Hello World"
//
// åº”ç”¨åœºæ™¯: embedding å®¢æˆ·ç«¯ã€å‘é‡åŒ–å®¢æˆ·ç«¯ã€è¯­ä¹‰æœç´¢ã€TOTP è®¤è¯
// å…³é”®è¯: embedding-client totp-client twofa vector-client semantic-search
// æœç´¢æ ‡ç­¾: #embedding-client #totp #security #vector #semantic-search
// =============================================================================

// =============================================================================
// CLI å‚æ•°é…ç½®æ¨¡å— - å‘½ä»¤è¡Œæ¥å£å®šä¹‰
// åŠŸèƒ½: å®šä¹‰è„šæœ¬çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œé…ç½®æœåŠ¡å™¨è¿æ¥å’ŒéªŒè¯ä¿¡æ¯
// æŠ€æœ¯: cli.String/Int å‚æ•°è§£æï¼Œcli.setDefault é»˜è®¤å€¼ï¼Œcli.setRequired å¿…å¡«é¡¹
//
// å‚æ•°è¯´æ˜:
// - host: æœåŠ¡å™¨åœ°å€ï¼Œé»˜è®¤ 127.0.0.1
// - port: æœåŠ¡å™¨ç«¯å£ï¼Œé»˜è®¤ 9099
// - totp-secret: TOTP éªŒè¯å¯†é’¥ï¼Œå¿…å¡«ï¼Œéœ€è¦ä¸æœåŠ¡ç«¯ä¸€è‡´
// - text: è¦ç”Ÿæˆ embedding çš„æ–‡æœ¬ï¼Œå¿…å¡«
//
// ä½¿ç”¨ç¤ºä¾‹:
// yak connect-yak-embedding-totp-service.yak --host 127.0.0.1 --port 9099 --totp-secret my-secret --text "Hello"
// =============================================================================

// æœåŠ¡å™¨åœ°å€é…ç½®
host = cli.String(
    "host",
    cli.setDefault("127.0.0.1"),
    cli.setHelp("æœåŠ¡å™¨åœ°å€")
)

// æœåŠ¡å™¨ç«¯å£é…ç½®
port = cli.Int(
    "port",
    cli.setDefault(9099),
    cli.setHelp("æœåŠ¡å™¨ç«¯å£")
)

// TOTP å¯†é’¥é…ç½®ï¼ˆå¿…å¡«ï¼Œéœ€è¦ä¸æœåŠ¡ç«¯ä¸€è‡´ï¼‰
totpSecret = cli.String(
    "totp-secret",
    cli.setRequired(true),
    cli.setHelp("TOTP éªŒè¯å¯†é’¥ï¼ˆUTC æ—¶é—´ï¼Œéœ€è¦ä¸æœåŠ¡ç«¯ä¸€è‡´ï¼‰")
)

// å¾…åµŒå…¥çš„æ–‡æœ¬ï¼ˆå¿…å¡«ï¼‰
text = cli.String(
    "text",
    cli.setRequired(true),
    cli.setHelp("è¦ç”Ÿæˆ embedding çš„æ–‡æœ¬")
)

// éªŒè¯å‚æ•°
cli.check()

log.info("Connecting to Yak Embedding TOTP Service...")
log.info("Configuration:")
log.info("  Server: %s:%d", host, port)
log.info("  TOTP Secret: %s", totpSecret)
log.info("  Text: %s", text)

// =============================================================================
// TOTP éªŒè¯ç ç”Ÿæˆæ¨¡å— - ç”Ÿæˆ UTC æ—¶é—´çš„ TOTP éªŒè¯ç 
// åŠŸèƒ½: ä½¿ç”¨ twofa åº“ç”Ÿæˆå½“å‰ UTC æ—¶é—´çš„ TOTP éªŒè¯ç 
// æŠ€æœ¯: twofa.GetUTCCode() ç”Ÿæˆ UTC TOTP ç 
//
// TOTP è¯´æ˜:
// - ä½¿ç”¨ UTC æ—¶é—´ç¡®ä¿æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ—¶é—´ä¸€è‡´
// - éªŒè¯ç æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡
// - éªŒè¯ç ä¸º 6 ä½æ•°å­—
// =============================================================================

println("\n=== Generating TOTP Code ===")

// ç”Ÿæˆ UTC æ—¶é—´çš„ TOTP éªŒè¯ç 
totpCode = twofa.GetUTCCode(totpSecret)
log.info("Generated TOTP code: %s", totpCode)
println(f"âœ“ TOTP Code: ${totpCode}")

// =============================================================================
// Embedding è¯·æ±‚æ¨¡å— - å‘é€ embedding è¯·æ±‚åˆ°æœåŠ¡å™¨
// åŠŸèƒ½: æ„å»º embedding è¯·æ±‚ï¼Œæ·»åŠ  TOTP éªŒè¯ç ï¼Œå‘é€åˆ°æœåŠ¡å™¨
// æŠ€æœ¯: json.dumps() åºåˆ—åŒ–è¯·æ±‚ï¼Œpoc.HTTP() å‘é€è¯·æ±‚
//
// è¯·æ±‚æ ¼å¼:
// POST /embeddings HTTP/1.1
// Host: {host}:{port}
// Content-Type: application/json
// X-TOTP-Code: {totp_code}
//
// {
//   "input": "è¦åµŒå…¥çš„æ–‡æœ¬",
//   "model": "embedding"
// }
//
// å“åº”æ ¼å¼:
// {
//   "object": "list",
//   "data": [
//     {
//       "object": "embedding",
//       "embedding": [0.1, 0.2, ...],
//       "index": 0
//     }
//   ],
//   "model": "embedding"
// }
// =============================================================================

println("\n=== Sending Embedding Request ===")

// æ„å»ºè¯·æ±‚ä½“
requestBody = json.dumps({
    "input": text,
    "model": "embedding",
})

log.info("Request body: %s", requestBody)

// æ„å»ºæœåŠ¡å™¨åœ°å€
log.info("Sending request to: http://%s:%d/embeddings", host, port)

// å‘é€ HTTP è¯·æ±‚
println(f"Sending request to http://${host}:${port}/embeddings...")

rsp, _, err = poc.HTTP(
    f`POST /embeddings HTTP/1.1
Host: ${host}
Content-Type: application/json
X-TOTP-Code: ${totpCode}
Content-Length: ${len(requestBody)}

${requestBody}`,
    poc.host(host),
    poc.port(port),
    poc.timeout(30),
)

if err != nil {
    log.error("Failed to send request: %v", err)
    die(f"Failed to send request: ${err}")
}

// =============================================================================
// å“åº”å¤„ç†æ¨¡å— - è§£æå’Œæ˜¾ç¤ºæœåŠ¡å™¨å“åº”
// åŠŸèƒ½: æå–å“åº”çŠ¶æ€ç å’Œå“åº”ä½“ï¼Œè§£æ JSON æ•°æ®ï¼Œæ˜¾ç¤ºç»“æœ
// æŠ€æœ¯: poc.Split() åˆ†ç¦»å“åº”ï¼Œpoc.GetStatusCodeFromResponse() è·å–çŠ¶æ€ç ï¼Œjson.loads() è§£æ JSON
//
// é”™è¯¯å¤„ç†:
// - 401: TOTP éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†é’¥æ˜¯å¦æ­£ç¡®
// - 404: è·¯å¾„é”™è¯¯
// - 500: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
// - 200: è¯·æ±‚æˆåŠŸ
// =============================================================================

println("\n=== Processing Response ===")

// è·å–çŠ¶æ€ç 
statusCode = poc.GetStatusCodeFromResponse(rsp)~

// æå–å“åº”ä½“
_, body = poc.Split(rsp)
log.info("Response status code: %d", statusCode)
println(f"Status Code: ${statusCode}")

// æ£€æŸ¥çŠ¶æ€ç 
if statusCode != 200 {
    log.error("Request failed with status code: %d", statusCode)
    println(f"\nâŒ Request Failed")
    println(f"Status: ${statusCode}")
    println(f"Response Body:\n${string(body)}")
    
    // å°è¯•è§£æé”™è¯¯ä¿¡æ¯
    errorData, parseErr = json.loads(body)
    if parseErr == nil && errorData != nil {
        if errorData["error"] != nil {
            errorMsg = errorData["error"]["message"]
            errorType = errorData["error"]["type"]
            println(f"\nError Type: ${errorType}")
            println(f"Error Message: ${errorMsg}")
            
            if statusCode == 401 {
                println("\nğŸ’¡ æç¤º: TOTP éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥:")
                println("   1. TOTP å¯†é’¥æ˜¯å¦ä¸æœåŠ¡ç«¯ä¸€è‡´")
                println("   2. å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ç³»ç»Ÿæ—¶é—´æ˜¯å¦åŒæ­¥ï¼ˆä½¿ç”¨ UTC æ—¶é—´ï¼‰")
            }
        }
    }
    
    die("Request failed")
}

// è§£æå“åº”ä½“
println("\nâœ“ Request Successful")
log.info("Parsing response body...")

responseData = json.loads(body)

// =============================================================================
// ç»“æœå±•ç¤ºæ¨¡å— - æ˜¾ç¤º embedding å‘é‡ä¿¡æ¯
// åŠŸèƒ½: æå–å’Œå±•ç¤º embedding å‘é‡çš„è¯¦ç»†ä¿¡æ¯
// æŠ€æœ¯: JSON æ•°æ®è®¿é—®ï¼Œæ•°ç»„/å­—å…¸æ“ä½œ
//
// å±•ç¤ºå†…å®¹:
// - æ¨¡å‹åç§°
// - å‘é‡ç»´åº¦
// - å‘é‡é¢„è§ˆï¼ˆå‰ 10 ä¸ªå€¼ï¼‰
// - å‘é‡ç»Ÿè®¡ï¼ˆæœ€å°å€¼ã€æœ€å¤§å€¼ã€å¹³å‡å€¼ï¼‰
// =============================================================================

println("\n=== Embedding Result ===")

// æå– embedding æ•°æ®
if responseData["data"] == nil || len(responseData["data"]) == 0 {
    log.error("No embedding data in response")
    die("No embedding data in response")
}

embeddingData = responseData["data"][0]
embedding = embeddingData["embedding"]

// æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
println(f"Model: ${responseData['model']}")
println(f"Object Type: ${responseData['object']}")
println(f"Embedding Dimension: ${len(embedding)}")

// æ˜¾ç¤ºå‘é‡é¢„è§ˆï¼ˆå‰ 10 ä¸ªå€¼ï¼‰
println("\nEmbedding Vector Preview (first 10 values):")
previewCount = 10
if len(embedding) < previewCount {
    previewCount = len(embedding)
}

for i = 0; i < previewCount; i++ {
    println(f"  [${i}] = ${embedding[i]}")
}

if len(embedding) > previewCount {
    println(f"  ... (${len(embedding) - previewCount} more values)")
}

// è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
println("\nVector Statistics:")

minVal = embedding[0]
maxVal = embedding[0]
sumVal = 0.0

for val in embedding {
    if val < minVal {
        minVal = val
    }
    if val > maxVal {
        maxVal = val
    }
    sumVal = sumVal + val
}

avgVal = sumVal / len(embedding)

println(f"  Min: ${minVal}")
println(f"  Max: ${maxVal}")
println(f"  Avg: ${avgVal}")

// =============================================================================
// æ€»ç»“è¾“å‡º
// =============================================================================

println("\n=== Summary ===")
println(f"âœ“ Successfully generated embedding for text: \"${text}\"")
println(f"âœ“ Vector dimension: ${len(embedding)}")
println(f"âœ“ TOTP authentication: Passed")

log.info("Client execution completed successfully")

