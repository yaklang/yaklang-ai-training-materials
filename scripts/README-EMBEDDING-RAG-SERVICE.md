# Yak Embedding RAG Service with TOTP Authentication

åŸºäº RAG ç³»ç»Ÿçš„å®‰å…¨ Embedding æœåŠ¡ï¼Œæ”¯æŒ TOTP èº«ä»½éªŒè¯å’Œå¹¶å‘æ§åˆ¶ã€‚

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [è„šæœ¬è¯´æ˜](#è„šæœ¬è¯´æ˜)
- [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)
- [æŠ€æœ¯ç»†èŠ‚](#æŠ€æœ¯ç»†èŠ‚)

## ğŸ¯ æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Embedding æœåŠ¡è§£å†³æ–¹æ¡ˆï¼Œä½¿ç”¨ Yaklang çš„ RAG ç³»ç»Ÿè‡ªåŠ¨ç®¡ç† embedder ç”Ÿå‘½å‘¨æœŸï¼Œæä¾›å¸¦ TOTP éªŒè¯çš„å®‰å…¨ API æ¥å£ï¼Œå¹¶æ”¯æŒå¹¶å‘æ§åˆ¶ä»¥ä¿æŠ¤æœåŠ¡ç¨³å®šæ€§ã€‚

### ä¸»è¦æ”¹è¿›

1. **ä½¿ç”¨ RAG ç³»ç»Ÿç®¡ç† embedder**
   - ä¸å†æ‰‹åŠ¨ç®¡ç† llama-server åœ°å€å’Œç«¯å£
   - RAG ç³»ç»Ÿè‡ªåŠ¨å¯åŠ¨å’Œç®¡ç† embedder æœåŠ¡
   - è‡ªåŠ¨å¤„ç†æ¨¡å‹åŠ è½½å’Œèµ„æºåˆ†é…

2. **å¹¶å‘æ§åˆ¶**
   - ä½¿ç”¨ `sync.NewSizedWaitGroup` é™åˆ¶å¹¶å‘ embedding è°ƒç”¨
   - é¿å…æœåŠ¡è¿‡è½½ï¼Œä¿æŠ¤ç¨³å®šæ€§
   - å¯é…ç½®çš„å¹¶å‘é™åˆ¶ï¼ˆé»˜è®¤ 5ï¼‰

3. **ä¾èµ–å®‰è£…æµç¨‹ä¼˜åŒ–**
   - è‡ªåŠ¨æ£€æŸ¥å¹¶å®‰è£… llama-server
   - è‡ªåŠ¨æ£€æŸ¥å¹¶å®‰è£… embedding æ¨¡å‹
   - åˆå§‹åŒ–å¹¶æµ‹è¯• embedder å¯ç”¨æ€§

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. è‡ªåŠ¨ä¾èµ–ç®¡ç†

```bash
# è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š
1. å®‰è£… llama-serverï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
2. å®‰è£… model-Qwen3-Embedding-0.6B-Q4ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
3. åˆå§‹åŒ– RAG ç³»ç»Ÿ
4. æµ‹è¯• embedder æ˜¯å¦å¯ç”¨
```

### 2. TOTP èº«ä»½éªŒè¯

- ä½¿ç”¨ UTC æ—¶é—´ç¡®ä¿å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ—¶é—´ä¸€è‡´
- 6 ä½æ•°å­—éªŒè¯ç ï¼Œæ¯ 30 ç§’æ›´æ–°
- é€šè¿‡ `X-TOTP-Code` è¯·æ±‚å¤´ä¼ é€’

### 3. å¹¶å‘æ§åˆ¶

- ä½¿ç”¨ `sync.NewSizedWaitGroup` é™åˆ¶å¹¶å‘æ•°é‡
- è¾¾åˆ°é™åˆ¶æ—¶è‡ªåŠ¨ç­‰å¾…ï¼Œä¸ä¼šæ‹’ç»è¯·æ±‚
- ä¿æŠ¤ embedder æœåŠ¡ä¸ä¼šè¿‡è½½

### 4. OpenAI API å…¼å®¹

å“åº”æ ¼å¼å…¼å®¹ OpenAI Embedding APIï¼š

```json
{
  "object": "list",
  "data": [
    {
      "object": "embedding",
      "embedding": [0.1, 0.2, ...],
      "index": 0
    }
  ],
  "model": "embedding",
  "usage": {
    "prompt_tokens": 13,
    "total_tokens": 13
  }
}
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Client (connect-yak-embedding)      â”‚
â”‚  - ç”Ÿæˆ TOTP éªŒè¯ç                       â”‚
â”‚  - å‘é€ embedding è¯·æ±‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTP + TOTP
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HTTP Server (start-yak-embedding)     â”‚
â”‚  - éªŒè¯ TOTP                             â”‚
â”‚  - å¹¶å‘æ§åˆ¶ (sync.NewSizedWaitGroup)    â”‚
â”‚  - è½¬å‘åˆ° embedder                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        RAG System (rag.GetCollection)   â”‚
â”‚  - è‡ªåŠ¨ç®¡ç† embedder ç”Ÿå‘½å‘¨æœŸ            â”‚
â”‚  - embedder.Embedding(text)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       llama-server (æœ¬åœ°æ¨¡å‹æœåŠ¡)        â”‚
â”‚  - Qwen3-Embedding-0.6B-Q4_K_M          â”‚
â”‚  - è‡ªåŠ¨å¯åŠ¨å’Œç®¡ç†                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨æ–°ç‰ˆæœ¬çš„ yakï¼ˆç¡®ä¿å·²é‡æ–°ç¼–è¯‘ï¼‰
yak scripts/start-yak-embedding-service.yak \
  --port 9099 \
  --totp-secret my-secret-key \
  --concurrent 5
```

**å‚æ•°è¯´æ˜ï¼š**
- `--port`: æœåŠ¡ç›‘å¬ç«¯å£ï¼ˆé»˜è®¤ 9099ï¼‰
- `--totp-secret`: TOTP éªŒè¯å¯†é’¥ï¼ˆå¿…å¡«ï¼Œéœ€ä¸å®¢æˆ·ç«¯ä¸€è‡´ï¼‰
- `--concurrent`: å¹¶å‘é™åˆ¶æ•°é‡ï¼ˆé»˜è®¤ 5ï¼‰

### 2. ä½¿ç”¨å®¢æˆ·ç«¯

```bash
yak scripts/connect-yak-embedding-totp-service.yak \
  --host 127.0.0.1 \
  --port 9099 \
  --totp-secret my-secret-key \
  --text "Hello, World!"
```

### 3. æ‰‹åŠ¨æµ‹è¯•

```bash
# ç”Ÿæˆ TOTP ç ï¼ˆå¯ä»¥ä½¿ç”¨ä»»ä½• TOTP å·¥å…·ï¼‰
# ç„¶åä½¿ç”¨ curl æµ‹è¯•
curl -X POST http://localhost:9099/embeddings \
  -H 'Content-Type: application/json' \
  -H 'X-TOTP-Code: 123456' \
  -d '{"input": "test text"}'
```

## ğŸ“œ è„šæœ¬è¯´æ˜

### 1. start-yak-embedding-service.yak

**ä¸»æœåŠ¡ç«¯è„šæœ¬**

- **åŠŸèƒ½**: å¯åŠ¨å¸¦ TOTP éªŒè¯å’Œå¹¶å‘æ§åˆ¶çš„ embedding æœåŠ¡
- **ä¾èµ–**: è‡ªåŠ¨å®‰è£… llama-server å’Œ embedding æ¨¡å‹
- **ç«¯ç‚¹**: `POST /embeddings`
- **å…³é”®æŠ€æœ¯**:
  - `rag.GetCollection("default")`: è·å– RAG ç³»ç»Ÿ
  - `ragSystem.Embedder`: è·å– embedder
  - `sync.NewSizedWaitGroup(concurrent)`: å¹¶å‘æ§åˆ¶
  - `twofa.VerifyUTCCode()`: TOTP éªŒè¯

### 2. connect-yak-embedding-totp-service.yak

**å®¢æˆ·ç«¯è„šæœ¬**

- **åŠŸèƒ½**: è¿æ¥ embedding æœåŠ¡å¹¶å‘é€è¯·æ±‚
- **å…³é”®æŠ€æœ¯**:
  - `twofa.GetUTCCode()`: ç”Ÿæˆ TOTP éªŒè¯ç 
  - `poc.HTTP()`: å‘é€ HTTP è¯·æ±‚
  - `json.loads/dumps()`: JSON å¤„ç†

### 3. test-yak-embedding-rag-service.yak

**å®Œæ•´åŠŸèƒ½æµ‹è¯•è„šæœ¬**

- **æµ‹è¯•è¦†ç›–**:
  - RAG ç³»ç»Ÿåˆå§‹åŒ–
  - Embedder å¯ç”¨æ€§
  - HTTP æœåŠ¡å™¨å¯åŠ¨
  - TOTP éªŒè¯ï¼ˆæœ‰æ•ˆ/æ— æ•ˆ/ç¼ºå¤±ï¼‰
  - Embedding è¯·æ±‚å¤„ç†
  - é”™è¯¯åœºæ™¯å¤„ç†

### 4. test-final-embedding-service.yak

**ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•**

- **æµ‹è¯•åœºæ™¯**:
  - å•ä¸ªè¯·æ±‚å¤„ç†
  - å¤šä¸ªé¡ºåºè¯·æ±‚
  - å¹¶å‘è¯·æ±‚ï¼ˆè¶…è¿‡å¹¶å‘é™åˆ¶ï¼‰
  - TOTP éªŒè¯
  - å“åº”æ ¼å¼éªŒè¯

## âœ… æµ‹è¯•éªŒè¯

æ‰€æœ‰è„šæœ¬éƒ½ç»è¿‡å®Œæ•´çš„æµ‹è¯•éªŒè¯ï¼š

### æµ‹è¯•ç»“æœ

```
=== Test Summary ===
âœ“ RAG ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ
âœ“ Embedding æœåŠ¡å¯åŠ¨æˆåŠŸ
âœ“ TOTP éªŒè¯å·¥ä½œæ­£å¸¸
âœ“ å•ä¸ªè¯·æ±‚å¤„ç†æ­£ç¡®
âœ“ å¹¶å‘æ§åˆ¶å·¥ä½œæ­£å¸¸

æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æœåŠ¡å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚
```

### è¿è¡Œæµ‹è¯•

```bash
# æµ‹è¯• RAG embedding æœåŠ¡çš„æ‰€æœ‰åŠŸèƒ½
yak scripts/test-yak-embedding-rag-service.yak

# æµ‹è¯•å®Œæ•´çš„ç«¯åˆ°ç«¯æµç¨‹ï¼ˆåŒ…æ‹¬å¹¶å‘ï¼‰
yak scripts/test-final-embedding-service.yak
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### RAG ç³»ç»Ÿé›†æˆ

```yak
// è·å– RAG é›†åˆ
ragSystem, err = rag.GetCollection("default")
if err != nil {
    die(f"Failed to get RAG collection: ${err}")
}

// è·å– embedder
embedder = ragSystem.Embedder

// ä½¿ç”¨ embedder
vectors, err = embedder.Embedding("text to embed")
```

### å¹¶å‘æ§åˆ¶å®ç°

```yak
// åˆ›å»ºå¤§å°å—é™çš„ WaitGroup
swg = sync.NewSizedWaitGroup(concurrent)

// åœ¨è¯·æ±‚å¤„ç†ä¸­ä½¿ç”¨
swg.Add()  // è·å–æ§½ä½ï¼ˆå¦‚æœæ»¡äº†ä¼šç­‰å¾…ï¼‰

// è°ƒç”¨ embedder
vectors, err = embedder.Embedding(inputText)

// ç«‹å³é‡Šæ”¾æ§½ä½
swg.Done()
```

### TOTP éªŒè¯æµç¨‹

**æœåŠ¡ç«¯éªŒè¯ï¼š**
```yak
// è·å– TOTP ç 
totpCode = req.Header.Get("X-TOTP-Code")

// éªŒè¯ï¼ˆä½¿ç”¨ UTC æ—¶é—´ï¼‰
if !twofa.VerifyUTCCode(totpSecret, totpCode) {
    // éªŒè¯å¤±è´¥
    rsp.WriteHeader(401)
    return
}
```

**å®¢æˆ·ç«¯ç”Ÿæˆï¼š**
```yak
// ç”Ÿæˆå½“å‰ UTC æ—¶é—´çš„ TOTP ç 
totpCode = twofa.GetUTCCode(totpSecret)

// æ·»åŠ åˆ°è¯·æ±‚å¤´
X-TOTP-Code: ${totpCode}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `library-usage/httpserver/httpserver-practice.yak`: HTTP æœåŠ¡å™¨ç”¨æ³•ç¤ºä¾‹
- `library-usage/twofa/twofa-practice.yak`: TOTP/2FA ç”¨æ³•ç¤ºä¾‹

## ğŸ”„ ä»æ—§ç‰ˆæœ¬è¿ç§»

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯æ—§ç‰ˆæœ¬ï¼ˆæ‰‹åŠ¨ç®¡ç† llama-serverï¼‰ï¼Œè¯·æ³¨æ„ä»¥ä¸‹å˜æ›´ï¼š

### ç§»é™¤çš„å‚æ•°

- `--llama-port`: ä¸å†éœ€è¦ï¼ŒRAG ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†

### æ–°å¢çš„å‚æ•°

- `--concurrent`: å¹¶å‘é™åˆ¶ï¼ˆé»˜è®¤ 5ï¼‰

### ä»£ç å˜æ›´

**æ—§ç‰ˆæœ¬ï¼ˆæ‰‹åŠ¨ç®¡ç†ï¼‰ï¼š**
```yak
// æ‰‹åŠ¨è½¬å‘åˆ° llama-server
rsp = poc.HTTP(..., poc.host("127.0.0.1"), poc.port(llamaPort))
```

**æ–°ç‰ˆæœ¬ï¼ˆRAG ç®¡ç†ï¼‰ï¼š**
```yak
// ä½¿ç”¨ RAG embedder
ragSystem, _ = rag.GetCollection("default")
vectors, _ = ragSystem.Embedder.Embedding(text)
```

## ğŸ‰ æ€»ç»“

è¿™ä¸ªé‡æ„ç‰ˆæœ¬æä¾›äº†ï¼š

1. âœ… æ›´ç®€å•çš„æ¶æ„ï¼ˆRAG è‡ªåŠ¨ç®¡ç† embedderï¼‰
2. âœ… æ›´å¥½çš„ç¨³å®šæ€§ï¼ˆå¹¶å‘æ§åˆ¶ï¼‰
3. âœ… æ›´å®¹æ˜“ç»´æŠ¤ï¼ˆæ— éœ€æ‰‹åŠ¨ç®¡ç†æœåŠ¡åœ°å€ï¼‰
4. âœ… å®Œæ•´çš„æµ‹è¯•è¦†ç›–
5. âœ… è¯¦ç»†çš„æ–‡æ¡£

æ‰€æœ‰è„šæœ¬éƒ½ç»è¿‡éªŒè¯ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼

