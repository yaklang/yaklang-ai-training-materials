name: Update Yaklang AIKB RAG and rags-latest.json

on:
  push:
    branches:
      - main
    paths:
      - 'ai-benchmark/**'
      - 'scripts/**'
      - 'awesome-scripts/**'
      - 'basic-syntax/**'
      - 'library-usage/**'
      - 'practice/**'
      - '.github/workflows/update-rags-latest.yml'
  workflow_dispatch:

concurrency:
  group: update-rags-latest
  cancel-in-progress: false

jobs:
  update-rag-and-register:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Print trigger information
        run: |
          echo "============================================"
          echo "Update Yaklang AIKB RAG and rags-latest.json"
          echo "============================================"
          echo "Workflow triggered by: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "============================================"
      
      - name: Download Yak Engine from OSS
        run: |
          YAK_VERSION="1.4.5-beta5"
          echo "Downloading Yak engine version: $YAK_VERSION"
          wget -q -O './yak' "https://aliyun-oss.yaklang.com/yak/${YAK_VERSION}/yak_linux_amd64"
          chmod +x ./yak
          ./yak version
      
      - name: Generate Version
        run: |
          DATE_STR=$(date +%Y%m%d)
          INDEX=1
          while true; do
            VERSION="${DATE_STR}-${INDEX}"
            CHECK_URL="https://yaklang.oss-accelerate.aliyuncs.com/rag/yaklang-aikb/${VERSION}/yaklang-aikb.rag.gz"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -I "$CHECK_URL" || echo "000")
            if [ "$HTTP_STATUS" = "404" ] || [ "$HTTP_STATUS" = "000" ]; then
              echo "Version $VERSION is available"
              break
            fi
            echo "Version $VERSION already exists, trying next index..."
            INDEX=$((INDEX + 1))
            if [ $INDEX -gt 100 ]; then
              echo "ERROR: Too many versions for today!"
              exit 1
            fi
          done
          echo "Using version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          RAG_OSS_DIR="/rag/yaklang-aikb/${VERSION}"
          echo "RAG_OSS_DIR=$RAG_OSS_DIR" >> $GITHUB_ENV

      - name: Download existing AIKB files
        run: |
          echo "=== Downloading existing AIKB files ==="
          OLD_ZIP_URL="https://yaklang.oss-accelerate.aliyuncs.com/ai-knowledge-base/yaklang-aikb.zip"
          if curl -f -s -o "yaklang-aikb-old.zip" "$OLD_ZIP_URL"; then
            echo "Downloaded existing ZIP file"
            ls -lh yaklang-aikb-old.zip
          else
            echo "No existing ZIP found"
          fi
          RAG_URL="https://yaklang.oss-accelerate.aliyuncs.com/ai-knowledge-base/rag/yaklang-aikb.rag"
          if curl -f -s -o "yaklang-aikb-old.rag" "$RAG_URL"; then
            echo "Downloaded existing RAG file"
            ls -lh yaklang-aikb-old.rag
          else
            echo "No existing RAG found"
          fi

      - name: Generate new AIKB ZIP file
        run: |
          echo "=== Generating new AIKB ZIP file ==="
          ./yak scripts/merge-in-one-text.yak --output yaklang-aikb.zip
          if [ ! -f yaklang-aikb.zip ]; then
            echo "ERROR: Failed to generate yaklang-aikb.zip"
            exit 1
          fi
          ls -lh yaklang-aikb.zip

      - name: Generate diff package
        run: |
          echo "=== Generating diff package ==="
          if [ -f yaklang-aikb-old.zip ] && [ -f yaklang-aikb.zip ]; then
            ./yak scripts/diff-zip-v2.yak --old yaklang-aikb-old.zip --new yaklang-aikb.zip --output diff-fs.zip || {
              echo "Diff script failed or no changes detected"
              echo "HAS_CHANGES=false" >> $GITHUB_ENV
            }
            if [ -f diff-fs.zip ]; then
              # 检查 diff-fs.zip 是否有内容
              DIFF_COUNT=$(unzip -l diff-fs.zip 2>/dev/null | tail -1 | awk '{print $2}' || echo "0")
              if [ "$DIFF_COUNT" = "0" ] || [ -z "$DIFF_COUNT" ]; then
                echo "No changes detected in diff package"
                echo "HAS_CHANGES=false" >> $GITHUB_ENV
                rm -f diff-fs.zip
              else
                echo "Diff package generated with $DIFF_COUNT files"
                ls -lh diff-fs.zip
                echo "HAS_CHANGES=true" >> $GITHUB_ENV
              fi
            else
              echo "No diff package generated (no changes)"
              echo "HAS_CHANGES=false" >> $GITHUB_ENV
            fi
            if [ -f diff-fs.md ]; then
              cat diff-fs.md
            fi
          else
            echo "No old ZIP, using full ZIP as diff"
            cp yaklang-aikb.zip diff-fs.zip
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi

      - name: Update RAG with diff package
        if: env.HAS_CHANGES == 'true'
        env:
          EMBEDDING_HOST: ${{ secrets.EMBEDDING_HOST }}
          EMBEDDING_PORT: ${{ secrets.EMBEDDING_PORT }}
          TOTP_SECRET: ${{ secrets.TOTP_SECRET }}
        run: |
          echo "=== Updating RAG knowledge base ==="
          if [ ! -f diff-fs.zip ]; then
            echo "No diff package found"
            exit 0
          fi
          if [ -z "$EMBEDDING_HOST" ]; then
            echo "ERROR: Missing EMBEDDING_HOST"
            exit 1
          fi
          
          # 使用 aibalance 类型和 memfit-standard-free 模型（与 CWE 一致）
          AI_OPTS="--ai-type aibalance --ai-model memfit-standard-free"
          
          NEW_RAG_FILE="yaklang-aikb-new.rag"
          if [ -f yaklang-aikb-old.rag ]; then
            ./yak scripts/update-rag.yak \
              --rag-file yaklang-aikb-old.rag \
              --diff-zip diff-fs.zip \
              --output "$NEW_RAG_FILE" \
              --embedding-host "$EMBEDDING_HOST" \
              --embedding-port "$EMBEDDING_PORT" \
              --totp-secret "$TOTP_SECRET" \
              $AI_OPTS \
              --timeout 60
          else
            ./yak scripts/update-rag.yak \
              --diff-zip diff-fs.zip \
              --output "$NEW_RAG_FILE" \
              --embedding-host "$EMBEDDING_HOST" \
              --embedding-port "$EMBEDDING_PORT" \
              --totp-secret "$TOTP_SECRET" \
              $AI_OPTS \
              --timeout 60
          fi
          if [ ! -f "$NEW_RAG_FILE" ]; then
            echo "ERROR: RAG file not generated"
            exit 1
          fi
          ls -lh "$NEW_RAG_FILE"

      - name: Compress RAG and generate SHA256
        if: env.HAS_CHANGES == 'true'
        run: |
          RAG_FILE="yaklang-aikb-new.rag"
          if [ ! -f "$RAG_FILE" ]; then
            echo "ERROR: RAG file not found"
            exit 1
          fi
          ./yak gzip -f $RAG_FILE
          mv ${RAG_FILE}.gzip yaklang-aikb.rag.gz
          SHA256_HASH=$(sha256sum yaklang-aikb.rag.gz | awk '{print $1}')
          echo "$SHA256_HASH" > yaklang-aikb.rag.gz.sha256.txt
          echo "SHA256: $SHA256_HASH"
          echo "SHA256_HASH=$SHA256_HASH" >> $GITHUB_ENV

      - name: Upload files to OSS
        if: env.HAS_CHANGES == 'true'
        env:
          OSS_KEY_ID: ${{ secrets.OSS_KEY_ID }}
          OSS_KEY_SECRET: ${{ secrets.OSS_KEY_SECRET }}
        run: |
          ./yak upload-oss -b yaklang --endpoint oss-accelerate.aliyuncs.com \
            -ak "$OSS_KEY_ID" -sk "$OSS_KEY_SECRET" -t 10 \
            -f "yaklang-aikb.zip:/ai-knowledge-base/yaklang-aikb.zip"
          ./yak upload-oss -b yaklang --endpoint oss-accelerate.aliyuncs.com \
            -ak "$OSS_KEY_ID" -sk "$OSS_KEY_SECRET" -t 10 \
            -f "yaklang-aikb-new.rag:/ai-knowledge-base/rag/yaklang-aikb.rag"
          ./yak upload-oss -b yaklang --endpoint oss-accelerate.aliyuncs.com \
            -ak "$OSS_KEY_ID" -sk "$OSS_KEY_SECRET" -t 5 \
            -f "yaklang-aikb.rag.gz:${RAG_OSS_DIR}/yaklang-aikb.rag.gz"
          ./yak upload-oss -b yaklang --endpoint oss-accelerate.aliyuncs.com \
            -ak "$OSS_KEY_ID" -sk "$OSS_KEY_SECRET" -t 5 \
            -f "yaklang-aikb.rag.gz.sha256.txt:${RAG_OSS_DIR}/yaklang-aikb.rag.gz.sha256.txt"

      - name: Download and update rags-latest.json
        if: env.HAS_CHANGES == 'true'
        run: |
          wget -q -O rags-latest.json https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json || echo "[]" > rags-latest.json
          jq empty rags-latest.json 2>/dev/null || echo "[]" > rags-latest.json
          ./yak rag-metainfo \
            -f rags-latest.json -o rags-latest.json \
            --register-name "Yaklang AI KnowledgeBase" \
            --register-name-zh "Yaklang AI 知识库" \
            --version "$VERSION" \
            --rag-file "/rag/yaklang-aikb/${VERSION}/yaklang-aikb.rag.gz" \
            --hash-file "/rag/yaklang-aikb/${VERSION}/yaklang-aikb.rag.gz.sha256.txt" \
            --hash "$SHA256_HASH"
          cat rags-latest.json

      - name: Upload rags-latest.json
        if: env.HAS_CHANGES == 'true'
        env:
          OSS_KEY_ID: ${{ secrets.OSS_KEY_ID }}
          OSS_KEY_SECRET: ${{ secrets.OSS_KEY_SECRET }}
        run: |
          ./yak upload-oss -b yaklang --endpoint oss-accelerate.aliyuncs.com \
            -ak "$OSS_KEY_ID" -sk "$OSS_KEY_SECRET" -t 5 \
            -f "rags-latest.json:/rag/rags-latest.json"

      - name: Verify uploads
        if: env.HAS_CHANGES == 'true'
        run: |
          curl -I "https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/yaklang-aikb.rag.gz" | head -5
          curl -s "https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json" | jq .
          echo "Version: $VERSION"
          echo "RAG: https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/yaklang-aikb.rag.gz"
      
      - name: Ensure RAG exists in rags-latest.json (no changes)
        if: env.HAS_CHANGES != 'true'
        env:
          OSS_KEY_ID: ${{ secrets.OSS_KEY_ID }}
          OSS_KEY_SECRET: ${{ secrets.OSS_KEY_SECRET }}
        run: |
          echo "No changes detected in training materials"
          echo "Checking if RAG is already registered in rags-latest.json..."
          
          # 下载 rags-latest.json
          wget -q -O rags-latest.json https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json || echo "[]" > rags-latest.json
          jq empty rags-latest.json 2>/dev/null || echo "[]" > rags-latest.json
          
          # 检查是否已存在 Yaklang AI KnowledgeBase
          EXISTING=$(cat rags-latest.json | jq -r '.[] | select(.name == "Yaklang AI KnowledgeBase") | .name' 2>/dev/null || echo "")
          
          if [ -n "$EXISTING" ]; then
            echo "Yaklang AI KnowledgeBase already exists in rags-latest.json"
            cat rags-latest.json | jq '.[] | select(.name == "Yaklang AI KnowledgeBase")'
          else
            echo "Yaklang AI KnowledgeBase not found, registering existing RAG..."
            
            # 检查现有的 RAG 文件是否存在
            RAG_URL="https://yaklang.oss-accelerate.aliyuncs.com/ai-knowledge-base/rag/yaklang-aikb.rag"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -I "$RAG_URL")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              # 下载并压缩现有 RAG
              curl -f -s -o "yaklang-aikb-existing.rag" "$RAG_URL"
              ./yak gzip -f yaklang-aikb-existing.rag
              mv yaklang-aikb-existing.rag.gzip yaklang-aikb.rag.gz
              
              # 生成 SHA256
              SHA256_HASH=$(sha256sum yaklang-aikb.rag.gz | awk '{print $1}')
              echo "$SHA256_HASH" > yaklang-aikb.rag.gz.sha256.txt
              
              # 上传到版本化路径
              ./yak upload-oss -b yaklang --endpoint oss-accelerate.aliyuncs.com \
                -ak "$OSS_KEY_ID" -sk "$OSS_KEY_SECRET" -t 5 \
                -f "yaklang-aikb.rag.gz:${RAG_OSS_DIR}/yaklang-aikb.rag.gz"
              ./yak upload-oss -b yaklang --endpoint oss-accelerate.aliyuncs.com \
                -ak "$OSS_KEY_ID" -sk "$OSS_KEY_SECRET" -t 5 \
                -f "yaklang-aikb.rag.gz.sha256.txt:${RAG_OSS_DIR}/yaklang-aikb.rag.gz.sha256.txt"
              
              # 更新 rags-latest.json
              ./yak rag-metainfo \
                -f rags-latest.json -o rags-latest.json \
                --register-name "Yaklang AI KnowledgeBase" \
                --register-name-zh "Yaklang AI 知识库" \
                --version "$VERSION" \
                --rag-file "/rag/yaklang-aikb/${VERSION}/yaklang-aikb.rag.gz" \
                --hash-file "/rag/yaklang-aikb/${VERSION}/yaklang-aikb.rag.gz.sha256.txt" \
                --hash "$SHA256_HASH"
              
              # 上传更新后的 rags-latest.json
              ./yak upload-oss -b yaklang --endpoint oss-accelerate.aliyuncs.com \
                -ak "$OSS_KEY_ID" -sk "$OSS_KEY_SECRET" -t 5 \
                -f "rags-latest.json:/rag/rags-latest.json"
              
              echo "Yaklang AI KnowledgeBase registered successfully"
              cat rags-latest.json
            else
              echo "No existing RAG file found at $RAG_URL"
              echo "Please run with changes to create initial RAG"
            fi
          fi

      - name: Upload artifacts
        if: always() && env.HAS_CHANGES == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: diff-fs
          path: diff-fs.zip
          retention-days: 7

      - name: Summary
        run: |
          if [ "$HAS_CHANGES" = "true" ]; then
            echo "## Yaklang AIKB RAG Updated" >> $GITHUB_STEP_SUMMARY
            echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Version | $VERSION |" >> $GITHUB_STEP_SUMMARY
            echo "| SHA256 | $SHA256_HASH |" >> $GITHUB_STEP_SUMMARY
            echo "### URLs" >> $GITHUB_STEP_SUMMARY
            echo "- RAG: https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/yaklang-aikb.rag.gz" >> $GITHUB_STEP_SUMMARY
            echo "- Index: https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json" >> $GITHUB_STEP_SUMMARY
          else
            echo "## No Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No changes were detected in the training materials." >> $GITHUB_STEP_SUMMARY
            echo "RAG update and rags-latest.json update were skipped." >> $GITHUB_STEP_SUMMARY
          fi
