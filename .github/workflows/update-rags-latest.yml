name: Update rags-latest.json for Yaklang AIKB

on:
  # å½“ upload-aikb.yml å®ŒæˆåŽè§¦å‘
  workflow_run:
    workflows: ["Upload AIKB to OSS"]
    types:
      - completed
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å½“æœ¬ CI æ–‡ä»¶æ›´æ–°æ—¶è§¦å‘
  push:
    paths:
      - '.github/workflows/update-rags-latest.yml'

# ç¡®ä¿åŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªä»»åŠ¡
concurrency:
  group: update-rags-latest
  cancel-in-progress: false

jobs:
  update-rags-latest:
    runs-on: ubuntu-22.04
    # åªåœ¨ workflow_run æˆåŠŸæ—¶è¿è¡Œï¼Œæˆ–æ‰‹åŠ¨/push è§¦å‘æ—¶è¿è¡Œ
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Print trigger information
        run: |
          echo "============================================"
          echo "ðŸ”„ Update rags-latest.json for Yaklang AIKB"
          echo "============================================"
          echo "Workflow triggered by: ${{ github.event_name }}"
          echo "Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "============================================"
      
      - name: Download Yak Engine from OSS
        run: |
          YAK_VERSION="1.4.5-beta5"
          echo "Downloading Yak engine version: $YAK_VERSION"
          wget -q -O './yak' "https://aliyun-oss.yaklang.com/yak/${YAK_VERSION}/yak_linux_amd64"
          chmod +x ./yak
          ./yak version
      
      - name: Generate Version
        run: |
          # ç”Ÿæˆç‰ˆæœ¬å·: æ—¥æœŸ-index
          DATE_STR=$(date +%Y%m%d)
          
          # æ£€æŸ¥å½“å¤©æ˜¯å¦å·²æœ‰ç‰ˆæœ¬ï¼Œç¡®å®š index
          INDEX=1
          while true; do
            VERSION="${DATE_STR}-${INDEX}"
            CHECK_URL="https://yaklang.oss-accelerate.aliyuncs.com/rag/yaklang-aikb/${VERSION}/yaklang-aikb.rag.gz"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -I "$CHECK_URL" || echo "000")
            if [ "$HTTP_STATUS" = "404" ] || [ "$HTTP_STATUS" = "000" ]; then
              echo "Version $VERSION is available"
              break
            fi
            echo "Version $VERSION already exists, trying next index..."
            INDEX=$((INDEX + 1))
            if [ $INDEX -gt 100 ]; then
              echo "ERROR: Too many versions for today!"
              exit 1
            fi
          done
          
          echo "Using version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # å‡†å¤‡ä¸Šä¼ ç›®å½•
          RAG_OSS_DIR="/rag/yaklang-aikb/${VERSION}"
          echo "RAG_OSS_DIR=$RAG_OSS_DIR" >> $GITHUB_ENV
      
      - name: Download existing RAG file
        run: |
          echo "=== Downloading existing RAG file ==="
          
          RAG_URL="https://yaklang.oss-accelerate.aliyuncs.com/ai-knowledge-base/rag/yaklang-aikb.rag"
          
          echo "Downloading from: $RAG_URL"
          if curl -f -s -o "yaklang-aikb.rag" "$RAG_URL"; then
            echo "âœ“ Downloaded existing RAG file"
            ls -lh yaklang-aikb.rag
          else
            echo "ERROR: Failed to download RAG file"
            exit 1
          fi
      
      - name: Compress RAG and generate SHA256
        run: |
          RAG_FILE="yaklang-aikb.rag"
          RAG_GZ_FILE="yaklang-aikb.rag.gz"
          SHA256_FILE="yaklang-aikb.rag.gz.sha256.txt"
          
          # åŽ‹ç¼© RAG æ–‡ä»¶
          echo "Compressing RAG file..."
          ./yak gzip -f $RAG_FILE
          mv ${RAG_FILE}.gzip $RAG_GZ_FILE
          
          # éªŒè¯åŽ‹ç¼©æ–‡ä»¶
          FILE_SIZE=$(stat -c%s "$RAG_GZ_FILE")
          echo "RAG file size: $FILE_SIZE bytes ($(echo "scale=2; $FILE_SIZE/1024/1024" | bc) MB)"
          
          # RAG æ–‡ä»¶åº”è¯¥è‡³å°‘æœ‰ 10KB
          SIZE_LIMIT=$((10 * 1024))
          if [ $FILE_SIZE -lt $SIZE_LIMIT ]; then
            echo "RAG file size is less than 10KB. Something might be wrong. Aborting."
            exit 1
          fi
          
          # ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ
          echo "Generating SHA256 checksum..."
          SHA256_HASH=$(sha256sum $RAG_GZ_FILE | awk '{print $1}')
          echo "$SHA256_HASH" > $SHA256_FILE
          echo "SHA256: $SHA256_HASH"
          
          # ä¿å­˜ SHA256 hash ä¾›åŽç»­ä½¿ç”¨
          echo "SHA256_HASH=$SHA256_HASH" >> $GITHUB_ENV
      
      - name: Upload RAG files to versioned path
        env:
          OSS_KEY_ID: ${{ secrets.OSS_KEY_ID }}
          OSS_KEY_SECRET: ${{ secrets.OSS_KEY_SECRET }}
        run: |
          echo "Uploading RAG files to OSS..."
          echo "Version: $VERSION"
          echo "OSS Directory: $RAG_OSS_DIR"
          
          # ä¸Šä¼  RAG åŽ‹ç¼©æ–‡ä»¶
          echo "Uploading yaklang-aikb.rag.gz..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak "$OSS_KEY_ID" \
            -sk "$OSS_KEY_SECRET" \
            -t 5 \
            -f "yaklang-aikb.rag.gz:${RAG_OSS_DIR}/yaklang-aikb.rag.gz"
          
          # ä¸Šä¼  SHA256 æ ¡éªŒæ–‡ä»¶
          echo "Uploading yaklang-aikb.rag.gz.sha256.txt..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak "$OSS_KEY_ID" \
            -sk "$OSS_KEY_SECRET" \
            -t 5 \
            -f "yaklang-aikb.rag.gz.sha256.txt:${RAG_OSS_DIR}/yaklang-aikb.rag.gz.sha256.txt"
          
          echo "âœ“ RAG files uploaded to versioned path"
      
      - name: Download rags-latest.json
        run: |
          echo "=== Downloading rags-latest.json ==="
          
          wget -q -O rags-latest.json https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json || {
            echo "No existing rags-latest.json found, creating empty array"
            echo "[]" > rags-latest.json
          }
          
          # éªŒè¯ JSON æ–‡ä»¶å†…å®¹æœ‰æ•ˆ
          if ! jq empty rags-latest.json 2>/dev/null; then
            echo "Invalid JSON in rags-latest.json, creating empty array"
            echo "[]" > rags-latest.json
          fi
          
          echo "Current rags-latest.json content:"
          cat rags-latest.json
      
      - name: Update rags-latest.json
        run: |
          echo "Updating rags-latest.json..."
          
          # ä½¿ç”¨ yak rag-metainfo å‘½ä»¤ç»´æŠ¤ rags-latest.json
          ./yak rag-metainfo \
            -f rags-latest.json \
            -o rags-latest.json \
            --register-name "Yaklang AI KnowledgeBase" \
            --register-name-zh "Yaklang AI çŸ¥è¯†åº“" \
            --version "$VERSION" \
            --rag-file "/rag/yaklang-aikb/${VERSION}/yaklang-aikb.rag.gz" \
            --hash-file "/rag/yaklang-aikb/${VERSION}/yaklang-aikb.rag.gz.sha256.txt" \
            --hash "$SHA256_HASH"
          
          echo "New rags-latest.json content:"
          cat rags-latest.json
      
      - name: Upload rags-latest.json to OSS
        env:
          OSS_KEY_ID: ${{ secrets.OSS_KEY_ID }}
          OSS_KEY_SECRET: ${{ secrets.OSS_KEY_SECRET }}
        run: |
          echo "Uploading rags-latest.json..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak "$OSS_KEY_ID" \
            -sk "$OSS_KEY_SECRET" \
            -t 5 \
            -f "rags-latest.json:/rag/rags-latest.json"
      
      - name: Verify uploads
        run: |
          echo "Verifying uploads..."
          echo ""
          echo "=== RAG File ==="
          curl -I "https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/yaklang-aikb.rag.gz" | head -10
          echo ""
          echo "=== SHA256 File ==="
          curl -I "https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/yaklang-aikb.rag.gz.sha256.txt" | head -10
          echo ""
          echo "=== rags-latest.json ==="
          curl -s "https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json" | jq .
          echo ""
          echo "=== Upload Summary ==="
          echo "Version: $VERSION"
          echo "RAG File: https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/yaklang-aikb.rag.gz"
          echo "SHA256 File: https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/yaklang-aikb.rag.gz.sha256.txt"
          echo "Index File: https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json"
      
      - name: Summary
        run: |
          echo "## âœ… rags-latest.json Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Update Information" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SHA256 | \`$SHA256_HASH\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Time | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Access URLs" >> $GITHUB_STEP_SUMMARY
          echo "- RAG File: https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/yaklang-aikb.rag.gz" >> $GITHUB_STEP_SUMMARY
          echo "- SHA256: https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/yaklang-aikb.rag.gz.sha256.txt" >> $GITHUB_STEP_SUMMARY
          echo "- Index: https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json" >> $GITHUB_STEP_SUMMARY
