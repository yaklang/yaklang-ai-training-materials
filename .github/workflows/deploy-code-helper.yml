name: Deploy Code Helper

on:
  # å½“æŒ‡å®šæ–‡ä»¶æœ‰æ”¹åŠ¨æ—¶è§¦å‘
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'apps/code-helper/**'
  #     - '.github/workflows/deploy-code-helper.yml'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# ç¡®ä¿åŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªéƒ¨ç½²ä»»åŠ¡
concurrency:
  group: deploy-code-helper
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-22.04
    
    env:
      APP_NAME: code-helper
      APP_PATH: apps/code-helper
      MAIN_SCRIPT: code-helper.yak
      SERVICE_NAME: yak-code-helper
      WORK_DIR: /root/yaklang-ai-training-materials
      YAK_VERSION: 1.4.4-alpha1112a
      YAK_PATH: /usr/local/bin/yak-1.4.4-alpha1112a
      APP_PORT: ${{ secrets.CODE_HELPER_PORT }}
      
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Print trigger information
        run: |
          echo "============================================"
          echo "éƒ¨ç½²åº”ç”¨: ${{ env.APP_NAME }}"
          echo "æœåŠ¡åç§°: ${{ env.SERVICE_NAME }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "åˆ†æ”¯: ${{ github.ref }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "æ“ä½œè€…: ${{ github.actor }}"
          echo "============================================"
      
      - name: Download Yaklang Engine
        run: |
          echo "=== ä¸‹è½½ Yaklang å¼•æ“Ž v${{ env.YAK_VERSION }} ==="
          YAK_URL="https://yaklang.oss-accelerate.aliyuncs.com/yak/${{ env.YAK_VERSION }}/yak_linux_amd64"
          
          echo "ä¸‹è½½åœ°å€: $YAK_URL"
          wget --progress=dot:binary -O ./yak "$YAK_URL" 2>&1 | \
            awk '/[0-9]+%/{i++; if(i%3==0) print; next} {print}' || true
          
          if [ ! -f ./yak ]; then
            echo "ERROR: YAK å¼•æ“Žä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          chmod +x ./yak
          
          echo ""
          echo "=== ä¸‹è½½çš„æ–‡ä»¶ä¿¡æ¯ ==="
          ls -lh ./yak
          file ./yak
          
          echo ""
          echo "=== æµ‹è¯• YAK å¼•æ“Ž ==="
          ./yak version || echo "æ³¨æ„: æ­¤ç‰ˆæœ¬å¯èƒ½ä¸æ”¯æŒ version å‘½ä»¤"
          
          echo ""
          echo "âœ“ Yaklang å¼•æ“Žä¸‹è½½å¹¶éªŒè¯æˆåŠŸ"
      
      - name: Prepare SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EMBEDDING_HOST_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.EMBEDDING_HOST }}
        run: |
          echo "=== å‡†å¤‡ SSH éƒ¨ç½² ==="
          
          if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$SSH_HOST" ]; then
            echo "ERROR: SSH å‡­è¯æœªæ‰¾åˆ°"
            echo "è¯·ç¡®ä¿å·²è®¾ç½® EMBEDDING_HOST_PRIVATE_KEY å’Œ EMBEDDING_HOST secrets"
            exit 1
          fi
          
          # åˆ›å»ºç§é’¥æ–‡ä»¶
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > /tmp/deploy_pri
          chmod 600 /tmp/deploy_pri
          
          # éªŒè¯ç§é’¥æ ¼å¼
          if ! ssh-keygen -l -f /tmp/deploy_pri >/dev/null 2>&1; then
            echo "ERROR: SSH ç§é’¥æ ¼å¼æ— æ•ˆ"
            exit 1
          fi
          
          echo "âœ“ SSH å¯†é’¥å‡†å¤‡æˆåŠŸ"
      
      - name: Prepare environment configuration
        run: |
          echo "=== å‡†å¤‡çŽ¯å¢ƒé…ç½® ==="
          
          # åˆ›å»ºçŽ¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶
          cat > /tmp/app-config.env << 'EOF'
          # Code Helper åº”ç”¨é…ç½®
          # ç«¯å£é…ç½®
          APP_PORT=${{ env.APP_PORT }}
          EOF
          
          echo "çŽ¯å¢ƒé…ç½®ä¿¡æ¯:"
          if [ -n "${{ env.APP_PORT }}" ]; then
            echo "  APP_PORT: [å·²è®¾ç½®]"
          fi
          echo "  Collection: yaklang-aikb"
          echo "  Top K: 10"
          echo "âœ“ é…ç½®å‡†å¤‡æˆåŠŸ"
      
      - name: Deploy to remote server
        env:
          SSH_HOST: ${{ secrets.EMBEDDING_HOST }}
        run: |
          echo "=== éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨ ==="
          echo "ç›®æ ‡æœåŠ¡å™¨: [å·²éšè—]"
          echo "åº”ç”¨: ${{ env.APP_NAME }}"
          echo "æœåŠ¡: ${{ env.SERVICE_NAME }}"
          
          # åˆ›å»ºè¿œç¨‹ç›®å½•
          echo ""
          echo "åˆ›å»ºè¿œç¨‹ç›®å½•..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mkdir -p ${{ env.WORK_DIR }}/{${{ env.APP_PATH }},apps,scripts}"
          
          # æ¸…ç† home ç›®å½•ä¸‹å³å°†ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆé¿å…å†²çªï¼‰
          echo "æ¸…ç†æ½œåœ¨æ–‡ä»¶å†²çª..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "rm -f ~/deploy-yak-app.sh ~/install-yak-scripts-to-systemd.yak ~/app-config.env"
          for file in ${{ env.APP_PATH }}/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "rm -f ~/$filename"
            fi
          done
          
          # 1. ä¸Šä¼ é€šç”¨éƒ¨ç½²è„šæœ¬
          echo ""
          echo "ä¸Šä¼ é€šç”¨éƒ¨ç½²è„šæœ¬..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --upload-file ./apps/deploy-yak-app.sh
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mv ~/deploy-yak-app.sh ${{ env.WORK_DIR }}/apps/deploy-yak-app.sh && chmod +x ${{ env.WORK_DIR }}/apps/deploy-yak-app.sh"
          
          # 2. ä¸Šä¼  systemd å®‰è£…è„šæœ¬
          echo "ä¸Šä¼  systemd å®‰è£…è„šæœ¬..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --upload-file ./scripts/install-yak-scripts-to-systemd.yak
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mv ~/install-yak-scripts-to-systemd.yak ${{ env.WORK_DIR }}/scripts/install-yak-scripts-to-systemd.yak"
          
          # 3. ä¸Šä¼ åº”ç”¨æ–‡ä»¶
          echo ""
          echo "ä¸Šä¼ åº”ç”¨æ–‡ä»¶ä»Ž ${{ env.APP_PATH }}..."
          for file in ${{ env.APP_PATH }}/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              # è·³è¿‡æ—§çš„ deploy.sh æ–‡ä»¶
              if [ "$filename" != "deploy.sh" ]; then
                echo "  â†’ $filename"
                ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --upload-file "$file"
                ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mv ~/$filename ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/$filename"
              fi
            fi
          done
          
          # 4. ä¸Šä¼ çŽ¯å¢ƒé…ç½®æ–‡ä»¶
          echo ""
          echo "ä¸Šä¼ çŽ¯å¢ƒé…ç½®..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --upload-file /tmp/app-config.env
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mv ~/app-config.env ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/.env"
          
          # éªŒè¯ä¸Šä¼ çš„æ–‡ä»¶
          echo ""
          echo "éªŒè¯ä¸Šä¼ çš„æ–‡ä»¶..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "ls -lh ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/ ${{ env.WORK_DIR }}/scripts/ ${{ env.WORK_DIR }}/apps/deploy-yak-app.sh"
          
          # 5. æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
          echo ""
          echo "=== æ‰§è¡Œé€šç”¨éƒ¨ç½²è„šæœ¬ ==="
          
          DEPLOY_CMD="${{ env.WORK_DIR }}/apps/deploy-yak-app.sh \
            --service-name \"${{ env.SERVICE_NAME }}\" \
            --main-script \"${{ env.APP_PATH }}/${{ env.MAIN_SCRIPT }}\" \
            --work-dir \"${{ env.WORK_DIR }}\" \
            --yak-version \"${{ env.YAK_VERSION }}\" \
            --yak-path \"${{ env.YAK_PATH }}\" \
            --config-file \"${{ env.APP_PATH }}/.env\" \
            --script-args \"--port \\\$APP_PORT --collection yaklang-aikb --topk 10 --frontend \\\"${{ env.WORK_DIR }}/${{ env.APP_PATH }}/index.html\\\"\" \
            --verify-port \"${{ env.APP_PORT }}\" \
            --install-yak"
          
          # è„±æ•åŽçš„å‘½ä»¤ç”¨äºŽæ—¥å¿—æ˜¾ç¤º
          SAFE_DEPLOY_CMD=$(echo "$DEPLOY_CMD" | sed 's/--verify-port "[^"]*"/--verify-port [REDACTED]/g')
          
          echo "éƒ¨ç½²å‘½ä»¤:"
          echo "  ${SAFE_DEPLOY_CMD}"
          echo ""
          
          # æ‰§è¡Œéƒ¨ç½²
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "bash -c '${DEPLOY_CMD}'"
          
          if [ $? -ne 0 ]; then
            echo ""
            echo "ERROR: éƒ¨ç½²å¤±è´¥"
            exit 1
          fi
          
          echo ""
          echo "âœ“ éƒ¨ç½²æˆåŠŸå®Œæˆ"
      
      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.EMBEDDING_HOST }}
        run: |
          echo "=== éªŒè¯éƒ¨ç½² ==="
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "ç­‰å¾…æœåŠ¡ç¨³å®š..."
          sleep 5
          
          # é€šè¿‡ SSH éªŒè¯æœåŠ¡çŠ¶æ€
          echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl is-active ${{ env.SERVICE_NAME }} && echo 'âœ“ æœåŠ¡å·²æ¿€æ´»' || echo 'âœ— æœåŠ¡æœªæ¿€æ´»'"
          
          echo ""
          echo "èŽ·å–æœåŠ¡çŠ¶æ€è¯¦æƒ…..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl status ${{ env.SERVICE_NAME }} --no-pager -l || true"
          
          # å¥åº·æ£€æŸ¥
          echo ""
          echo "åœ¨ç«¯å£ ${{ env.APP_PORT }} ä¸Šè¿è¡Œå¥åº·æ£€æŸ¥..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "curl -f http://127.0.0.1:${{ env.APP_PORT }}/ 2>/dev/null && echo 'âœ“ æœåŠ¡åœ¨ç«¯å£ ${{ env.APP_PORT }} ä¸Šå“åº”' || echo 'âš  ç«¯å£ ${{ env.APP_PORT }} å¥åº·æ£€æŸ¥å¤±è´¥'"
          
          echo ""
          echo "âœ“ æœåŠ¡éªŒè¯å®Œæˆ"
      
      - name: Cleanup
        if: always()
        run: |
          echo "=== æ¸…ç† ==="
          rm -f /tmp/deploy_pri /tmp/app-config.env
          echo "âœ“ æ¸…ç†å®Œæˆ"
      
      - name: Summary
        if: success()
        run: |
          echo "## âœ… ${{ env.APP_NAME }} éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.APP_NAME }} æœåŠ¡å·²æˆåŠŸéƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ éƒ¨ç½²è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- åº”ç”¨åç§°: \`${{ env.APP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- æœåŠ¡åç§°: \`${{ env.SERVICE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ä¸»è„šæœ¬: \`${{ env.APP_PATH }}/${{ env.MAIN_SCRIPT }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ç«¯å£: \`${{ env.APP_PORT }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- å·¥ä½œç›®å½•: \`${{ env.WORK_DIR }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- æäº¤: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- åˆ†æ”¯: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- è§¦å‘è€…: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- YAK ç‰ˆæœ¬: \`${{ env.YAK_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ æœåŠ¡ç®¡ç†å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# æŸ¥çœ‹æœåŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "systemctl status ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æŸ¥çœ‹æœåŠ¡æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "journalctl -u ${{ env.SERVICE_NAME }} -f" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# é‡å¯æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "systemctl restart ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# åœæ­¢æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "systemctl stop ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
