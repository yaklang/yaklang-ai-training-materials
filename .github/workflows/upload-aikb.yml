name: Upload AIKB to OSS

on:
  # å½“æŒ‡å®šæ–‡ä»¶å¤¹æœ‰æ”¹åŠ¨æ—¶è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'awesome-scripts/**'
      - 'basic-syntax/**'
      - 'library-usage/**'
      - 'practice/**'
      - 'scripts/merge-in-one-text.yak'
      - '.github/workflows/upload-aikb.yml'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# ç¡®ä¿åŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªä¸Šä¼ ä»»åŠ¡
concurrency:
  group: upload-aikb
  cancel-in-progress: false

jobs:
  build-and-upload:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Print trigger information
        run: |
          echo "============================================"
          echo "Workflow triggered by: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "============================================"
      
      - name: Download Yaklang Engine (v1.4.4-alpha1027)
        run: |
          echo "=== Downloading Yaklang Engine v1.4.4-alpha1027 ==="
          YAK_VERSION="1.4.4-alpha1027"
          YAK_URL="https://yaklang.oss-accelerate.aliyuncs.com/yak/${YAK_VERSION}/yak_linux_amd64"
          
          echo "Downloading from: $YAK_URL"
          wget -q --show-progress -O ./yak "$YAK_URL"
          
          if [ ! -f ./yak ]; then
            echo "ERROR: Failed to download yak engine"
            echo "Trying alternative URL..."
            YAK_URL="https://yaklang.oss-accelerate.aliyuncs.com/yak/${YAK_VERSION}/yak_linux_amd64"
            wget -q --show-progress -O ./yak "$YAK_URL" || exit 1
          fi
          
          chmod +x ./yak
          
          # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
          echo ""
          echo "=== Downloaded file info ==="
          ls -lh ./yak
          file ./yak
          
          # æµ‹è¯•æ‰§è¡Œ
          echo ""
          echo "=== Testing yak engine ==="
          ./yak version || echo "Note: yak version command may not be available in this version"
          
          echo ""
          echo "âœ“ Yaklang engine downloaded and verified successfully"
      
      - name: Generate AIKB ZIP file
        run: |
          echo "=== Generating AIKB ZIP file ==="

          # ä¸‹è½½çŽ°æœ‰çš„ yaklang-aikb.zip å¹¶ä¿å­˜ä¸º yaklang-aikb-old.zip
          echo "Downloading existing yaklang-aikb.zip..."
          OLD_ZIP_URL="https://oss-qn.yaklang.com/ai-knowledge-base/yaklang-aikb.zip"
          if curl -s -o yaklang-aikb-old.zip "$OLD_ZIP_URL"; then
            echo "âœ“ Existing ZIP downloaded successfully"
            ls -lh yaklang-aikb-old.zip
          else
            echo "âš ï¸  Failed to download existing ZIP (may not exist yet)"
          fi

          # è¿è¡Œ merge-in-one-text.yak ç”Ÿæˆ ZIP
          echo "Running merge-in-one-text.yak..."
          ./yak scripts/merge-in-one-text.yak --output yaklang-aikb.zip
          
          if [ ! -f yaklang-aikb.zip ]; then
            echo "ERROR: Failed to generate yaklang-aikb.zip"
            echo "DEBUG: Checking current directory contents:"
            ls -lh
            exit 1
          fi
          
          # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
          echo ""
          echo "=== Generated ZIP file info ==="
          ls -lh yaklang-aikb.zip
          
          # å°è¯•åˆ—å‡º ZIP å†…å®¹ä»¥éªŒè¯å…¶æœ‰æ•ˆæ€§
          echo ""
          echo "=== ZIP file contents (first 20 entries) ==="
          unzip -l yaklang-aikb.zip | head -25 || {
            echo "ERROR: Generated ZIP file appears to be invalid"
            exit 1
          }
          
          # ç»Ÿè®¡æ–‡ä»¶æ•°å’Œå¤§å°
          FILE_COUNT=$(unzip -l yaklang-aikb.zip | tail -1 | awk '{print $2}')
          FILE_SIZE=$(stat -c%s yaklang-aikb.zip 2>/dev/null || stat -f%z yaklang-aikb.zip)
          
          echo ""
          echo "=== ZIP Statistics ==="
          echo "Files in ZIP: $FILE_COUNT"
          echo "ZIP size: $FILE_SIZE bytes ($(echo "scale=2; $FILE_SIZE/1024/1024" | bc) MB)"
          
          echo ""
          echo "âœ“ AIKB ZIP file generated successfully"

      - name: Generate diff report and package
        if: always()
        run: |
          echo "=== Generating ZIP diff report and package ==="
          
          if [ -f yaklang-aikb-old.zip ] && [ -f yaklang-aikb.zip ]; then
            # ä½¿ç”¨ diff-zip-v2.yak è¿›è¡Œå¯¹æ¯”å’Œç”Ÿæˆå·®å¼‚åŒ…
            echo "Running diff-zip-v2.yak to compare ZIP files and create diff package..."
            ./yak scripts/diff-zip-v2.yak --old yaklang-aikb-old.zip --new yaklang-aikb.zip --output diff-fs.zip
            
            if [ -f diff-fs.zip ] && [ -f diff-fs.md ]; then
              echo "âœ“ Diff package and report generated successfully"
              echo ""
              echo "=== Diff package info ==="
              ls -lh diff-fs.zip
              echo ""
              echo "=== Diff package contents ==="
              unzip -l diff-fs.zip | head -20
              echo ""
              echo "=== Report content ==="
              cat diff-fs.md
            else
              echo "âš ï¸  Failed to generate diff package or report"
            fi
          else
            echo "âš ï¸  Cannot generate diff report - missing old or new ZIP file"
            echo "# AIKB ZIP å·®å¼‚æŠ¥å‘Š" > diff-fs.md
            echo "" >> diff-fs.md
            echo "**çŠ¶æ€**: æ— æ³•ç”Ÿæˆå·®å¼‚æŠ¥å‘Š - ç¼ºå°‘æ¯”è¾ƒæ–‡ä»¶" >> diff-fs.md
            echo "**æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> diff-fs.md
            
            # åˆ›å»ºç©ºçš„å·®å¼‚åŒ…
            echo "Creating empty diff package..."
            ./yak -c 'emptyZip = zip.CompressRaw({}); file.Save("diff-fs.zip", emptyZip)'
          fi

      - name: Create upload timestamp file
        run: |
          echo "=== Creating timestamp file ==="
          
          # ç”Ÿæˆæ—¶é—´æˆ³æ–‡ä»¶
          UPLOAD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          
          # ç›´æŽ¥å†™å…¥æ–‡ä»¶å†…å®¹
          echo "Upload Time: $UPLOAD_TIME" > yaklang-aikb.updated_at.txt
          echo "Commit: $COMMIT_SHORT ($COMMIT_SHA)" >> yaklang-aikb.updated_at.txt
          echo "Branch: ${{ github.ref_name }}" >> yaklang-aikb.updated_at.txt
          echo "Actor: ${{ github.actor }}" >> yaklang-aikb.updated_at.txt
          echo "Workflow Run: ${{ github.run_number }}" >> yaklang-aikb.updated_at.txt
          
          echo ""
          echo "=== Timestamp file content ==="
          cat yaklang-aikb.updated_at.txt
          
          echo ""
          echo "âœ“ Timestamp file created successfully"
      
      - name: Upload files to OSS
        env:
          OSS_KEY_ID: ${{ secrets.OSS_KEY_ID }}
          OSS_KEY_SECRET: ${{ secrets.OSS_KEY_SECRET }}
        run: |
          echo "=== Uploading files to OSS ==="
          
          if [ -z "$OSS_KEY_ID" ] || [ -z "$OSS_KEY_SECRET" ]; then
            echo "ERROR: OSS credentials not found"
            echo "Please ensure OSS_KEY_ID and OSS_KEY_SECRET secrets are set"
            exit 1
          fi
          
          BUCKET="yaklang"
          ENDPOINT="oss-accelerate.aliyuncs.com"
          
          # ä¸Šä¼  ZIP æ–‡ä»¶
          echo ""
          echo "Uploading yaklang-aikb.zip..."
          ./yak upload-oss \
            -b "$BUCKET" \
            --endpoint "$ENDPOINT" \
            -ak "$OSS_KEY_ID" \
            -sk "$OSS_KEY_SECRET" \
            -t 10 \
            -f "yaklang-aikb.zip:/ai-knowledge-base/yaklang-aikb.zip"
          
          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to upload yaklang-aikb.zip"
            exit 1
          fi
          
          echo "âœ“ yaklang-aikb.zip uploaded successfully"
          
          # ä¸Šä¼ æ—¶é—´æˆ³æ–‡ä»¶
          echo ""
          echo "Uploading yaklang-aikb.updated_at.txt..."
          ./yak upload-oss \
            -b "$BUCKET" \
            --endpoint "$ENDPOINT" \
            -ak "$OSS_KEY_ID" \
            -sk "$OSS_KEY_SECRET" \
            -t 5 \
            -f "yaklang-aikb.updated_at.txt:/ai-knowledge-base/yaklang-aikb.updated_at.txt"
          
          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to upload yaklang-aikb.updated_at.txt"
            exit 1
          fi
          
          echo "âœ“ yaklang-aikb.updated_at.txt uploaded successfully"
          
          echo ""
          echo "âœ“ All files uploaded to OSS successfully"
      
      - name: Verify OSS upload with HEAD requests
        run: |
          echo "=== Verifying OSS uploads ==="
          
          OSS_DOMAIN="oss-qn.yaklang.com"
          BASE_URL="https://${OSS_DOMAIN}/ai-knowledge-base"
          
          # éªŒè¯ ZIP æ–‡ä»¶
          echo ""
          echo "Verifying yaklang-aikb.zip..."
          ZIP_URL="${BASE_URL}/yaklang-aikb.zip"
          
          HTTP_CODE=$(curl -I -s -o /dev/null -w "%{http_code}" "$ZIP_URL")
          CONTENT_LENGTH=$(curl -I -s "$ZIP_URL" | grep -i content-length | awk '{print $2}' | tr -d '\r')
          LAST_MODIFIED=$(curl -I -s "$ZIP_URL" | grep -i last-modified | cut -d' ' -f2- | tr -d '\r')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Content-Length: $CONTENT_LENGTH bytes"
          echo "Last-Modified: $LAST_MODIFIED"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: yaklang-aikb.zip verification failed (HTTP $HTTP_CODE)"
            echo "URL: $ZIP_URL"
            exit 1
          fi
          
          if [ -z "$CONTENT_LENGTH" ] || [ "$CONTENT_LENGTH" -lt 1000 ]; then
            echo "ERROR: yaklang-aikb.zip size is suspiciously small ($CONTENT_LENGTH bytes)"
            exit 1
          fi
          
          echo "âœ“ yaklang-aikb.zip verified successfully"
          
          # éªŒè¯æ—¶é—´æˆ³æ–‡ä»¶
          echo ""
          echo "Verifying yaklang-aikb.updated_at.txt..."
          TIMESTAMP_URL="${BASE_URL}/yaklang-aikb.updated_at.txt"
          
          HTTP_CODE=$(curl -I -s -o /dev/null -w "%{http_code}" "$TIMESTAMP_URL")
          TIMESTAMP_CONTENT=$(curl -s "$TIMESTAMP_URL")
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Content:"
          echo "$TIMESTAMP_CONTENT"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: yaklang-aikb.updated_at.txt verification failed (HTTP $HTTP_CODE)"
            echo "URL: $TIMESTAMP_URL"
            exit 1
          fi
          
          if [ -z "$TIMESTAMP_CONTENT" ]; then
            echo "ERROR: yaklang-aikb.updated_at.txt is empty"
            exit 1
          fi
          
          echo "âœ“ yaklang-aikb.updated_at.txt verified successfully"
          
          echo ""
          echo "============================================"
          echo "âœ“ All verifications passed!"
          echo "============================================"
          echo ""
          echo "AIKB files are now available at:"
          echo "  ZIP: $ZIP_URL"
          echo "  Timestamp: $TIMESTAMP_URL"
          echo ""
      
      - name: Upload diff package artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: diff-fs
          path: diff-fs.zip
          retention-days: 7
      
      - name: Summary
        if: success()
        run: |
          echo "## âœ… AIKB Upload Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The AI Knowledge Base has been successfully built and uploaded to OSS." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Files" >> $GITHUB_STEP_SUMMARY
          echo "- \`yaklang-aikb.zip\` - Knowledge base archive" >> $GITHUB_STEP_SUMMARY
          echo "- \`yaklang-aikb.updated_at.txt\` - Upload timestamp" >> $GITHUB_STEP_SUMMARY
          echo "- \`diff-fs.zip\` - Diff package (available in artifacts)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Access URLs" >> $GITHUB_STEP_SUMMARY
          echo "- ZIP: https://oss-qn.yaklang.com/ai-knowledge-base/yaklang-aikb.zip" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: https://oss-qn.yaklang.com/ai-knowledge-base/yaklang-aikb.updated_at.txt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ·»åŠ å·®å¼‚æŠ¥å‘Šå†…å®¹
          if [ -f diff-fs.md ]; then
            echo "### ðŸ“‹ Diff Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat diff-fs.md >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### ðŸ“Š Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Actor: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

