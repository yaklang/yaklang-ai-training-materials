name: Reusable Deploy YAK App

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Application name (e.g., aireact-web, code-helper)'
        required: true
        type: string
      app_path:
        description: 'Path to application directory (e.g., apps/aireact-web)'
        required: true
        type: string
      service_name:
        description: 'Systemd service name (e.g., yak-aireact-web)'
        required: true
        type: string
      install_certs:
        description: 'Whether to install SSL certificates'
        required: false
        type: boolean
        default: false
    secrets:
      SSH_HOST:
        description: 'SSH host address'
        required: true
      SSH_PRIVATE_KEY:
        description: 'SSH private key'
        required: true
      APP_PORT:
        description: 'Application port'
        required: true
      APP_CONFIG:
        description: 'Additional application configuration (optional)'
        required: false

jobs:
  deploy:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Print trigger information
        run: |
          echo "============================================"
          echo "Deploying: ${{ inputs.app_name }}"
          echo "Service: ${{ inputs.service_name }}"
          echo "Workflow triggered by: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "============================================"
      
      - name: Download Yaklang Engine (v1.4.4-beta10)
        run: |
          echo "=== Downloading Yaklang Engine v1.4.4-beta10 ==="
          YAK_VERSION="1.4.4-beta10"
          YAK_URL="https://yaklang.oss-accelerate.aliyuncs.com/yak/${YAK_VERSION}/yak_linux_amd64"
          
          echo "Downloading from: $YAK_URL"
          wget --progress=dot:binary -O ./yak "$YAK_URL" 2>&1 | \
            awk '/[0-9]+%/{i++; if(i%3==0) print; next} {print}' || true
          
          if [ ! -f ./yak ]; then
            echo "ERROR: Failed to download yak engine"
            exit 1
          fi
          
          chmod +x ./yak
          
          echo ""
          echo "=== Downloaded file info ==="
          ls -lh ./yak
          file ./yak
          
          echo ""
          echo "=== Testing yak engine ==="
          ./yak version || echo "Note: yak version command may not be available in this version"
          
          echo ""
          echo "âœ“ Yaklang engine downloaded and verified successfully"
      
      - name: Prepare SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          echo "=== Preparing SSH deployment ==="
          
          if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$SSH_HOST" ]; then
            echo "ERROR: SSH credentials not found"
            echo "Please ensure SSH_PRIVATE_KEY and SSH_HOST secrets are set"
            exit 1
          fi
          
          # åˆ›å»ºç§é’¥æ–‡ä»¶
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > /tmp/deploy_pri
          chmod 600 /tmp/deploy_pri
          
          # éªŒè¯ç§é’¥æ ¼å¼
          if ! ssh-keygen -l -f /tmp/deploy_pri >/dev/null 2>&1; then
            echo "ERROR: Invalid SSH private key format"
            exit 1
          fi
          
          echo "âœ“ SSH key prepared successfully"
      
      - name: Prepare configuration file
        env:
          APP_PORT: ${{ secrets.APP_PORT }}
          APP_CONFIG: ${{ secrets.APP_CONFIG }}
        run: |
          echo "=== Preparing configuration file ==="
          
          if [ -z "$APP_PORT" ]; then
            echo "ERROR: APP_PORT not found"
            echo "Please ensure APP_PORT secret is set"
            exit 1
          fi
          
          # åˆ›å»ºé…ç½®æ–‡ä»¶
          cat > /tmp/app-config.env << EOF
          APP_PORT=${APP_PORT}
          APP_CONFIG=${APP_CONFIG:-}
          EOF
          
          echo "Configuration file created:"
          echo "  Port: ${APP_PORT}"
          if [ -n "$APP_CONFIG" ]; then
            echo "  Additional Config: [SET]"
          fi
          echo "âœ“ Configuration prepared successfully"
      
      - name: Create deployment script
        env:
          APP_NAME: ${{ inputs.app_name }}
          APP_PATH: ${{ inputs.app_path }}
          SERVICE_NAME: ${{ inputs.service_name }}
          INSTALL_CERTS: ${{ inputs.install_certs }}
        run: |
          echo "=== Creating deployment script ==="
          
          cat > /tmp/deploy-app.sh << 'DEPLOY_SCRIPT_EOF'
          #!/bin/bash
          set -e
          
          APP_NAME="${APP_NAME}"
          APP_PATH="${APP_PATH}"
          SERVICE_NAME="${SERVICE_NAME}"
          INSTALL_CERTS="${INSTALL_CERTS}"
          
          echo "============================================"
          echo "Deploying ${APP_NAME}"
          echo "============================================"
          
          # è¯»å–é…ç½®
          if [ -f "/root/yaklang-ai-training-materials/${APP_PATH}/.env" ]; then
            source "/root/yaklang-ai-training-materials/${APP_PATH}/.env"
            echo "âœ“ Configuration loaded"
            echo "  Port: ${APP_PORT}"
          else
            echo "ERROR: Configuration file not found"
            exit 1
          fi
          
          # å®‰è£…è¯ä¹¦ï¼ˆå¦‚æžœéœ€è¦ï¼‰
          if [ "${INSTALL_CERTS}" = "true" ]; then
            echo "Installing SSL certificates..."
            if [ -f "/root/yaklang-ai-training-materials/${APP_PATH}/install-certs.sh" ]; then
              bash "/root/yaklang-ai-training-materials/${APP_PATH}/install-certs.sh"
              echo "âœ“ SSL certificates installed"
            else
              echo "WARNING: install-certs.sh not found, skipping certificate installation"
            fi
          else
            echo "Skipping SSL certificate installation (not required for ${APP_NAME})"
          fi
          
          # å®‰è£… systemd æœåŠ¡
          echo "Installing systemd service..."
          cd /root/yaklang-ai-training-materials
          
          # æ£€æŸ¥ yak æ˜¯å¦å­˜åœ¨
          if ! command -v yak &> /dev/null; then
            echo "ERROR: yak command not found"
            echo "Please install Yaklang first"
            exit 1
          fi
          
          # åœæ­¢çŽ°æœ‰æœåŠ¡ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          if systemctl is-active --quiet "${SERVICE_NAME}"; then
            echo "Stopping existing service..."
            systemctl stop "${SERVICE_NAME}"
          fi
          
          # æŸ¥æ‰¾ä¸»è„šæœ¬æ–‡ä»¶
          MAIN_SCRIPT="${APP_PATH}/${APP_NAME}.yak"
          if [ ! -f "${MAIN_SCRIPT}" ]; then
            echo "ERROR: Main script not found: ${MAIN_SCRIPT}"
            exit 1
          fi
          
          echo "Installing service with script: ${MAIN_SCRIPT}"
          
          # ä½¿ç”¨ install-yak-scripts-to-systemd.yak å®‰è£…æœåŠ¡
          yak scripts/install-yak-scripts-to-systemd.yak \
            --script "${MAIN_SCRIPT}" \
            --service-name "${SERVICE_NAME}" \
            --port "${APP_PORT}"
          
          # å¯åŠ¨æœåŠ¡
          echo "Starting service..."
          systemctl daemon-reload
          systemctl enable "${SERVICE_NAME}"
          systemctl start "${SERVICE_NAME}"
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 3
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          if systemctl is-active --quiet "${SERVICE_NAME}"; then
            echo "âœ“ Service ${SERVICE_NAME} is running"
            systemctl status "${SERVICE_NAME}" --no-pager || true
          else
            echo "ERROR: Service ${SERVICE_NAME} failed to start"
            systemctl status "${SERVICE_NAME}" --no-pager || true
            journalctl -u "${SERVICE_NAME}" -n 50 --no-pager || true
            exit 1
          fi
          
          echo "============================================"
          echo "âœ“ ${APP_NAME} deployed successfully"
          echo "============================================"
          DEPLOY_SCRIPT_EOF
          
          # æ›¿æ¢çŽ¯å¢ƒå˜é‡
          sed -i "s|\${APP_NAME}|${APP_NAME}|g" /tmp/deploy-app.sh
          sed -i "s|\${APP_PATH}|${APP_PATH}|g" /tmp/deploy-app.sh
          sed -i "s|\${SERVICE_NAME}|${SERVICE_NAME}|g" /tmp/deploy-app.sh
          sed -i "s|\${INSTALL_CERTS}|${INSTALL_CERTS}|g" /tmp/deploy-app.sh
          
          chmod +x /tmp/deploy-app.sh
          
          echo "âœ“ Deployment script created"
      
      - name: Deploy to remote server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          APP_PATH: ${{ inputs.app_path }}
        run: |
          echo "=== Deploying to remote server ==="
          echo "Target server: $SSH_HOST"
          
          # åˆ›å»ºè¿œç¨‹ç›®å½•
          echo "Creating remote directory..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mkdir -p /root/yaklang-ai-training-materials/${APP_PATH} /root/yaklang-ai-training-materials/scripts"
          
          # ä¸Šä¼ åº”ç”¨æ–‡ä»¶
          echo "Uploading application files..."
          for file in ${APP_PATH}/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "  Uploading: $filename"
              # å…ˆåˆ é™¤è¿œç¨‹ä¸»ç›®å½•ä¸‹å¯èƒ½å­˜åœ¨çš„åŒåæ–‡ä»¶
              ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "rm -f ~/$filename"
              ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --upload-file "$file"
              ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mv ~/$filename /root/yaklang-ai-training-materials/${APP_PATH}/$filename"
            fi
          done
          
          # ä¸Šä¼  systemd å®‰è£…è„šæœ¬
          echo "Uploading install-yak-scripts-to-systemd.yak..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "rm -f ~/install-yak-scripts-to-systemd.yak"
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --upload-file ./scripts/install-yak-scripts-to-systemd.yak
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mv ~/install-yak-scripts-to-systemd.yak /root/yaklang-ai-training-materials/scripts/install-yak-scripts-to-systemd.yak"
          
          # ä¸Šä¼ é…ç½®æ–‡ä»¶
          echo "Uploading configuration file..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "rm -f ~/app-config.env"
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --upload-file /tmp/app-config.env
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mv ~/app-config.env /root/yaklang-ai-training-materials/${APP_PATH}/.env"
          
          # ä¸Šä¼ å¹¶æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          echo "Uploading deployment script..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "rm -f ~/deploy-app.sh"
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --upload-file /tmp/deploy-app.sh
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mv ~/deploy-app.sh /tmp/deploy-app.sh && chmod +x /tmp/deploy-app.sh"
          
          # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          echo "Executing deployment script on remote server..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --bash-script /tmp/deploy-app.sh
          
          if [ $? -ne 0 ]; then
            echo "ERROR: Deployment failed"
            exit 1
          fi
          
          echo "âœ“ Deployment completed successfully"
      
      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SERVICE_NAME: ${{ inputs.service_name }}
          APP_PORT: ${{ secrets.APP_PORT }}
        run: |
          echo "=== Verifying deployment ==="
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "Waiting for service to start..."
          sleep 10
          
          # é€šè¿‡ SSH éªŒè¯æœåŠ¡çŠ¶æ€
          echo "Checking service status..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl status ${SERVICE_NAME} --no-pager || echo 'Service status check failed'"
          
          # ç®€å•çš„å¥åº·æ£€æŸ¥
          echo "Running health check..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "curl -f http://127.0.0.1:${APP_PORT}/ 2>/dev/null && echo 'âœ“ Service is responding' || echo 'âœ— Service health check failed'"
          
          echo "âœ“ Service verification completed"
      
      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleaning up ==="
          rm -f /tmp/deploy_pri /tmp/app-config.env /tmp/deploy-app.sh
          echo "âœ“ Cleanup completed"
      
      - name: Summary
        if: success()
        env:
          APP_NAME: ${{ inputs.app_name }}
          SERVICE_NAME: ${{ inputs.service_name }}
          APP_PORT: ${{ secrets.APP_PORT }}
          APP_PATH: ${{ inputs.app_path }}
        run: |
          echo "## âœ… ${APP_NAME} Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The ${APP_NAME} service has been successfully deployed to the remote server." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- Application: \`${APP_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Service Name: \`${SERVICE_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Port: \`${APP_PORT}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Path: \`${APP_PATH}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Working Directory: \`/root/yaklang-ai-training-materials\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Actor: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Service Management" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Check service status" >> $GITHUB_STEP_SUMMARY
          echo "systemctl status ${SERVICE_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "journalctl -u ${SERVICE_NAME} -f" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Restart service" >> $GITHUB_STEP_SUMMARY
          echo "systemctl restart ${SERVICE_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

