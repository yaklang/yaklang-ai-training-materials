<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI 模型漏洞检测基准</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1224;
      --card: #11182c;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --primary: #5b8def;
      --primary-strong: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --border: #1f2937;
      --chip: #1c2438;
      --table-header: #0f172a;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Inter','Noto Sans SC',-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Helvetica','Arial',sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(91,141,239,0.12), transparent 35%), radial-gradient(circle at 80% 0%, rgba(34,197,94,0.12), transparent 30%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
      padding: 24px 0 60px;
    }

    .container { width:min(1400px,96%); margin:0 auto; }

    .topbar {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px 18px;
      display: flex;
      align-items: center;
      gap: 14px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.22);
      margin-bottom: 16px;
    }
    .brand { font-weight: 700; letter-spacing: -0.01em; }
    .brand small { color: var(--muted); font-weight: 500; }

    .nav-buttons { display:flex; gap:10px; }
    button {
      border:none; cursor:pointer; border-radius:10px;
      font-weight:600; transition:all 0.2s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn {
      padding:10px 14px;
      background: var(--chip);
      color: var(--text);
      border:1px solid var(--border);
    }
    .btn.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-strong) 100%);
      color:#0b1224;
      box-shadow:0 12px 30px rgba(91,141,239,0.25);
      border:none;
    }
    .status-indicator {
      margin-left:auto;
      display:flex; align-items:center; gap:8px;
      padding:8px 12px;
      background: var(--chip);
      border:1px solid var(--border);
      border-radius: 10px;
      font-size:12px;
      color: var(--muted);
    }
    .status-dot {
      width:10px;height:10px;border-radius:50%;
      background: #ef4444;
      animation: pulse 2s infinite;
    }
    .status-dot.connected { background: #22c55e; }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.5;} }

    .surface {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.22);
      padding: 18px 18px 20px;
      margin-bottom: 16px;
    }
    .section-head { display:flex; align-items:center; gap:10px; margin-bottom:6px; }
    .section-title { font-size:18px; font-weight:600; }
    .section-desc { color:var(--muted); font-size:13px; margin-bottom:12px; }

    .grid-2 { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; }
    .chip-box {
      background: var(--chip);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      color: var(--text);
    }
    .chip-label { color: var(--muted); font-size:12px; }
    .chip-value { font-weight:600; margin-top:4px; }

    .progress {
      height:8px; background: var(--chip); border-radius: 6px; overflow:hidden; margin:10px 0;
      border:1px solid var(--border);
    }
    .progress-fill { height:100%; width:0%; background: linear-gradient(90deg, #5b8def, #3b82f6); transition: width .3s; }

    .model-result {
      background: var(--chip);
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 14px 14px 12px;
      margin-bottom: 12px;
    }
    .model-result.success { border-left:4px solid var(--success); }
    .model-result.failed { border-left:4px solid var(--danger); }
    .model-title { font-weight:700; margin-bottom:10px; }
    .result-grid {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
      gap:10px; margin-bottom:12px;
    }
    .result-item {
      background: var(--card);
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
    }
    .result-label { color:var(--muted); font-size:12px; margin-bottom:4px; }
    .result-value { font-size:16px; font-weight:700; }
    .result-value.success { color: var(--success); }
    .result-value.failed { color: var(--danger); }

    .collapsible-header {
      cursor:pointer; user-select:none; display:flex; align-items:center; gap:8px;
      color: var(--text); margin-top:4px;
    }
    .collapsible-icon { transition: transform .3s; }
    .collapsible-icon.collapsed { transform: rotate(-90deg); }
    .collapsible-content { max-height: 1000px; overflow:hidden; transition:max-height .3s; }
    .collapsible-content.collapsed { max-height:0; }
    .stream-box {
      background:#0b1326; color:#cbd5e1; border:1px solid var(--border);
      padding:12px; border-radius:10px; font-family:'Fira Code','Inter',monospace;
      font-size:12px; max-height:260px; overflow:auto; margin-top:6px;
      white-space:pre-wrap; word-break:break-word;
    }
    .stream-box::-webkit-scrollbar { width:8px; }
    .stream-box::-webkit-scrollbar-thumb { background:#1f2937; border-radius:4px; }

    .summary {
      background: linear-gradient(135deg, rgba(91,141,239,0.18), rgba(34,197,94,0.18));
      border:1px solid rgba(91,141,239,0.35);
      border-radius:12px;
      padding:16px;
      margin-top:12px;
    }
    .summary-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:12px; margin-top:10px; }
    .summary-card {
      background: rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:10px;
      padding:12px;
      text-align:center;
      color:#fff;
    }
    .summary-value { font-size:28px; font-weight:700; margin-bottom:4px; }
    .summary-label { font-size:12px; opacity:0.9; }

    .table-wrap { overflow:auto; }
    table {
      width:100%; border-collapse:collapse;
      border:1px solid var(--border);
      background: var(--table-header);
      border-radius:10px;
      overflow:hidden;
    }
    thead { background:#0b1326; }
    th, td { padding:12px 10px; border-bottom:1px solid var(--border); color:var(--text); font-size:13px; }
    th { text-align:left; font-weight:600; }
    tbody tr:hover { background: rgba(91,141,239,0.06); }
    .badge {
      padding:4px 8px; border-radius:8px; font-size:12px; font-weight:600;
      background: rgba(226,232,240,0.08); border:1px solid var(--border); color: var(--text);
    }

    .modal {
      position: fixed; inset:0; background: rgba(0,0,0,0.55);
      display:none; align-items:center; justify-content:center; z-index:50; padding:20px;
    }
    .modal-content {
      width: min(1100px, 96vw);
      background: #0f172a;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px 22px 24px;
      box-shadow: 0 30px 90px rgba(0,0,0,0.5);
      position: relative;
      max-height: 90vh;
      overflow: auto;
    }
    .modal-close {
      position:absolute; right:14px; top:12px;
      background: rgba(239,68,68,0.16);
      color: #fecdd3;
      border: 1px solid rgba(239,68,68,0.35);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    .info-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:10px; margin:10px 0 14px; }
    .info-item { background: rgba(226,232,240,0.04); padding:10px 12px; border-radius:10px; border:1px solid var(--border); }
    .info-label { color:var(--muted); font-size:12px; }
    .info-value { font-weight:600; margin-top:2px; }
    pre {
      background:#0b1326; border:1px solid var(--border); border-radius:10px;
      padding:12px; color:#cbd5e1; white-space:pre-wrap; word-break:break-word;
      font-family:'Fira Code','Inter',monospace; font-size:12px; max-height:420px; overflow:auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">AI 模型漏洞检测基准 <small>实时测试 & 报告</small></div>
      <div class="nav-buttons">
        <button id="btnTest" class="btn active" onclick="showTestPage()">实时测试</button>
        <button id="btnReports" class="btn" onclick="showReportsPage()">报告列表</button>
      </div>
      <div class="status-indicator">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">连接中...</span>
      </div>
    </div>

    <section class="surface" id="configDisplay" style="display:none;">
      <div class="section-head">
        <span class="section-title">测试配置</span>
      </div>
      <div class="grid-2">
        <div class="chip-box">
          <div class="chip-label">目标</div>
          <div class="chip-value" id="displayTargetURL">-</div>
        </div>
        <div class="chip-box">
          <div class="chip-label">最大迭代</div>
          <div class="chip-value" id="displayMaxIteration">-</div>
        </div>
        <div class="chip-box">
          <div class="chip-label">超时时间</div>
          <div class="chip-value"><span id="displayTimeout">-</span> s</div>
        </div>
        <div class="chip-box">
          <div class="chip-label">AI 模型数量</div>
          <div class="chip-value" id="displayModelCount">-</div>
        </div>
      </div>
    </section>

    <section class="surface" id="resultsSection">
      <div class="section-head"><span class="section-title">实时测试</span></div>
      <div class="section-desc">自动从服务器配置启动；实时展示模型输出、思考流与进度。</div>

      <div class="chip-box" id="testStatus" style="margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span>测试进行中...</span>
          <span id="statusMessage">Initializing tests...</span>
        </div>
        <div class="progress"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div id="modelResults"></div>

      <div class="summary" id="summarySection" style="display:none;">
        <div style="font-weight:700;">汇总</div>
        <div class="summary-grid">
          <div class="summary-card"><div class="summary-value" id="totalTests">0</div><div class="summary-label">总测试</div></div>
          <div class="summary-card"><div class="summary-value" id="successTests">0</div><div class="summary-label">成功</div></div>
          <div class="summary-card"><div class="summary-value" id="detectedTests">0</div><div class="summary-label">已检测</div></div>
          <div class="summary-card"><div class="summary-value" id="totalRisks">0</div><div class="summary-label">风险发现</div></div>
        </div>
      </div>
    </section>

    <section class="surface" id="reportsPage" style="display:none;">
      <div class="section-head"><span class="section-title">报告列表</span></div>
      <div class="section-desc">历史基准报告，支持查看详情与原始 JSON。</div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
        <button class="btn active" style="padding:9px 14px;" onclick="loadReports()">刷新</button>
        <div style="flex:1;"></div>
        <div style="color:var(--muted);font-size:14px;">报告数量：<strong id="totalReports">0</strong></div>
      </div>
      <div id="reportsContainer"><div class="section-desc">正在加载报告...</div></div>
    </section>
  </div>

  <div id="reportModal" class="modal" onclick="handleModalBg(event)">
    <div class="modal-content">
      <button class="modal-close" onclick="closeReportModal()">关闭</button>
      <div id="reportDetailContent"></div>
    </div>
  </div>

  <script>
    let ws = null;
    let testRunning = false;
    let totalModels = 0;
    let completedModels = 0;
    let modelStreams = {};

    window.addEventListener('DOMContentLoaded', () => { init(); });

    function init() {
      connectWebSocket();
    }

    function updateStatus(status, text) {
      const dot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      if (status === 'connected') {
        dot.classList.add('connected');
        statusText.textContent = text || '已连接';
      } else {
        dot.classList.remove('connected');
        statusText.textContent = text || '未连接';
      }
    }

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/benchmark/test`;
      updateStatus('disconnected', '连接中...');
      try {
        ws = new WebSocket(wsUrl);
        ws.onopen = () => { updateStatus('connected', '已连接'); };
        ws.onmessage = e => handleWebSocketMessage(e.data);
        ws.onerror = () => updateStatus('disconnected', '错误');
        ws.onclose = () => {
          updateStatus('disconnected', '已断开');
          setTimeout(() => { if (!testRunning) connectWebSocket(); }, 3000);
        };
      } catch (err) {
        console.error(err);
        updateStatus('disconnected', '连接失败');
      }
    }

    function handleWebSocketMessage(data) {
      try {
        const msg = JSON.parse(data);
        if (msg.type === 'connected') {
          if (msg.config) {
            displayConfig(msg.config);
            autoStartTest(msg.config);
          } else {
            document.getElementById('resultsSection').innerHTML = '<div class="chip-box" style="color:#ef4444;">未加载配置，请检查服务端配置文件。</div>';
          }
        } else if (msg.type === 'test_started') {
          totalModels = msg.totalTests || msg.totalModels || 0;
          completedModels = 0;
          updateProgress();
          const aiCount = msg.aiModelCount || 0;
          const testCount = msg.testScenarioCount || 1;
          document.getElementById('statusMessage').textContent = `启动 ${aiCount} 模型 × ${testCount} 场景 = ${totalModels} 轮测试...`;
        } else if (msg.type === 'stream') {
          handleStreamData(msg);
        } else if (msg.type === 'model_completed') {
          handleModelCompleted(msg.result);
        } else if (msg.type === 'test_completed') {
          handleTestCompleted(msg);
        } else if (msg.type === 'error') {
          handleError(msg.message);
        }
      } catch (err) {
        console.error('parse error', err, data);
      }
    }

    function displayConfig(config) {
      const testConfigs = config.testConfigs || [];
      const aiConfigs = config.aiConfigs || [];
      const first = testConfigs[0] || {};
      document.getElementById('displayTargetURL').textContent = testConfigs.length > 1 ? `${testConfigs.length} 个场景` : (first.targetURL || '-');
      document.getElementById('displayMaxIteration').textContent = first.maxIteration || '-';
      document.getElementById('displayTimeout').textContent = first.timeout || '-';
      document.getElementById('displayModelCount').textContent = aiConfigs.length || 0;
      document.getElementById('configDisplay').style.display = 'block';
    }

    // auto start placeholder
    function autoStartTest() { /* server-side auto start */ }

    function handleStreamData(message) {
      const modelName = message.model;
      const streamType = message.streamType;
      const data = message.data;
      const resultId = message.resultId || modelName;
      if (!modelStreams[resultId]) modelStreams[resultId] = { thought:'', answer:'', modelName };
      if (streamType === 'thought') modelStreams[resultId].thought += data;
      if (streamType === 'answer') modelStreams[resultId].answer += data;
      updateStreamBox(resultId);
    }

    function updateStreamBox(resultId) {
      const stream = modelStreams[resultId];
      let node = document.getElementById(resultId);
      if (!node) {
        const wrap = document.getElementById('modelResults');
        node = document.createElement('div');
        node.id = resultId;
        node.className = 'model-result';
        node.innerHTML = `
          <div class="model-title" id="title-${resultId}">${stream.modelName}</div>
          <div class="result-item" style="margin-bottom:10px;">
            <div class="result-label">状态</div>
            <div class="result-value">测试中...</div>
          </div>
          <div class="collapsible-header" onclick="toggleCollapsible('thought-${resultId}')">
            <span class="collapsible-icon" id="icon-thought-${resultId}">▼</span>
            <strong>思考过程</strong>
          </div>
          <div class="collapsible-content" id="content-thought-${resultId}">
            <div class="stream-box" id="stream-thought-${resultId}"></div>
          </div>
          <div class="collapsible-header" onclick="toggleCollapsible('answer-${resultId}')" style="margin-top:10px;">
            <span class="collapsible-icon" id="icon-answer-${resultId}">▼</span>
            <strong>最终回答</strong>
          </div>
          <div class="collapsible-content" id="content-answer-${resultId}">
            <div class="stream-box" id="stream-answer-${resultId}"></div>
          </div>
        `;
        wrap.appendChild(node);
      }
      const thoughtBox = document.getElementById(`stream-thought-${resultId}`);
      const answerBox = document.getElementById(`stream-answer-${resultId}`);
      if (thoughtBox) { thoughtBox.textContent = stream.thought; thoughtBox.scrollTop = thoughtBox.scrollHeight; }
      if (answerBox) { answerBox.textContent = stream.answer; answerBox.scrollTop = answerBox.scrollHeight; }
    }

    function toggleCollapsible(id) {
      const content = document.getElementById(`content-${id}`);
      const icon = document.getElementById(`icon-${id}`);
      if (content && icon) { content.classList.toggle('collapsed'); icon.classList.toggle('collapsed'); }
    }

    function handleModelCompleted(result) {
      completedModels++; updateProgress();
      const resultId = result.resultId || `result-${result.model}`;
      const node = document.getElementById(resultId);
      if (node) {
        node.className = `model-result ${result.success ? 'success' : 'failed'}`;
        const title = document.getElementById(`title-${resultId}`);
        if (title) title.textContent = result.testName ? `${result.model} · ${result.testName}` : result.model;
        const matchedCount = result.matchedRiskCount || 0;
        const totalCount = result.riskCount || 0;
        const riskDisplay = `${matchedCount}/${totalCount}`;
        const gridHTML = `
          <div class="result-grid">
            <div class="result-item"><div class="result-label">成功</div><div class="result-value ${result.success?'success':'failed'}">${result.success?'YES':'NO'}</div></div>
            <div class="result-item"><div class="result-label">检测</div><div class="result-value ${result.detected?'success':'failed'}">${result.detected?'YES':'NO'}</div></div>
            <div class="result-item"><div class="result-label">风险匹配</div><div class="result-value">${riskDisplay}</div></div>
            <div class="result-item"><div class="result-label">耗时</div><div class="result-value">${result.duration}s</div></div>
          </div>
          ${result.error ? `<div class="chip-box" style="margin-top:6px; color:${'var(--danger)'};">${result.error}</div>` : ''}
        `;
        const firstCollapsible = node.querySelector('.collapsible-header');
        if (firstCollapsible) firstCollapsible.insertAdjacentHTML('beforebegin', gridHTML);
      }
      document.getElementById('statusMessage').textContent = `完成 ${completedModels}/${totalModels} 个测试...`;
    }

    function handleTestCompleted(data) {
      testRunning = false;
      document.getElementById('testStatus').innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><span style="color:${'var(--success)'};">已完成</span></div>`;
      const summary = data.summary || {};
      document.getElementById('summarySection').style.display = 'block';
      document.getElementById('totalTests').textContent = summary.totalTests || 0;
      document.getElementById('successTests').textContent = `${summary.successCount || 0} (${summary.successRate ? summary.successRate.toFixed(1) : 0}%)`;
      document.getElementById('detectedTests').textContent = `${summary.detectedCount || 0} (${summary.detectionRate ? summary.detectionRate.toFixed(1) : 0}%)`;
      document.getElementById('totalRisks').textContent = summary.totalRisks || 0;
    }

    function handleError(message) {
      document.getElementById('testStatus').innerHTML = `<div style="color:${'var(--danger)'};">错误：${message}</div>`;
      testRunning = false;
    }

    function updateProgress() {
      if (totalModels > 0) {
        const progress = (completedModels / totalModels) * 100;
        document.getElementById('progressFill').style.width = progress + '%';
      }
    }

    // Page navigation
    function showTestPage() {
      document.getElementById('resultsSection').style.display = 'block';
      document.getElementById('configDisplay').style.display = 'block';
      document.getElementById('reportsPage').style.display = 'none';
      document.getElementById('btnTest').classList.add('active');
      document.getElementById('btnReports').classList.remove('active');
    }
    function showReportsPage() {
      document.getElementById('resultsSection').style.display = 'none';
      document.getElementById('configDisplay').style.display = 'none';
      document.getElementById('reportsPage').style.display = 'block';
      document.getElementById('btnTest').classList.remove('active');
      document.getElementById('btnReports').classList.add('active');
      loadReports();
    }

    // Reports list
    function loadReports() {
      const container = document.getElementById('reportsContainer');
      container.innerHTML = '<div class="section-desc">正在加载报告...</div>';
      fetch('/api/reports')
        .then(r => r.json())
        .then(data => {
          if (!data.success) { container.innerHTML = `<div class="chip-box" style="color:${'var(--danger)'};">${data.message}</div>`; return; }
          document.getElementById('totalReports').textContent = data.count;
          if (!data.reports.length) { container.innerHTML = '<div class="section-desc">暂无报告</div>'; return; }
          let html = `<div class="table-wrap"><table><thead><tr>
            <th>时间</th><th>用例</th><th>模型</th><th style="text-align:center;">成功</th><th style="text-align:center;">检测</th><th style="text-align:center;">风险</th><th style="text-align:center;">时长</th><th style="text-align:center;">操作</th>
          </tr></thead><tbody>`;
          data.reports.forEach(rp => {
            const success = rp.success ? '<span class="badge" style="background:#22c55e;color:white;border:none;">YES</span>' : '<span class="badge" style="background:#ef4444;color:white;border:none;">NO</span>';
            const detected = rp.detected ? '<span class="badge" style="background:#22c55e;color:white;border:none;">YES</span>' : '<span class="badge" style="background:#ef4444;color:white;border:none;">NO</span>';
            html += `<tr>
              <td>${rp.timestamp || '-'}</td>
              <td>${rp.testName || '-'}</td>
              <td>${rp.model || '-'} <span style="color:var(--muted);font-size:12px;">(${rp.provider || '-'})</span></td>
              <td style="text-align:center;">${success}</td>
              <td style="text-align:center;">${detected}</td>
              <td style="text-align:center;">${rp.matchedRiskCount || 0}/${rp.riskCount || 0}</td>
              <td style="text-align:center;">${rp.duration || 0}s</td>
              <td style="text-align:center;"><button class="btn active" style="padding:6px 10px;" onclick="viewReport('${rp.filename}')">查看</button></td>
            </tr>`;
          });
          html += '</tbody></table></div>';
          container.innerHTML = html;
        })
        .catch(err => { container.innerHTML = `<div class="chip-box" style="color:${'var(--danger)'};">加载失败：${err.message}</div>`; });
    }

    function viewReport(filename) {
      const modal = document.getElementById('reportModal');
      const content = document.getElementById('reportDetailContent');
      content.innerHTML = '<div class="section-desc">加载中...</div>';
      modal.style.display = 'flex';
      fetch(`/api/report?filename=${encodeURIComponent(filename)}`)
        .then(r => r.json())
        .then(data => {
          if (!data.success) { content.innerHTML = `<div class="chip-box" style="color:${'var(--danger)'};">${data.message}</div>`; return; }
          const report = data.report;
          let html = `
            <h3 style="margin-bottom:10px;">报告详情</h3>
            <div class="info-grid">
              <div class="info-item"><div class="info-label">用例</div><div class="info-value">${report.testName || '-'}</div></div>
              <div class="info-item"><div class="info-label">时间</div><div class="info-value">${report.timestamp || '-'}</div></div>
              <div class="info-item"><div class="info-label">模型</div><div class="info-value">${report.model || '-'}</div></div>
              <div class="info-item"><div class="info-label">提供方</div><div class="info-value">${report.provider || '-'}</div></div>
              <div class="info-item"><div class="info-label">目标</div><div class="info-value">${report.targetURL || '-'}</div></div>
              <div class="info-item"><div class="info-label">时长</div><div class="info-value">${report.duration || 0}s</div></div>
              <div class="info-item"><div class="info-label">成功</div><div class="info-value">${report.success ? 'YES' : 'NO'}</div></div>
              <div class="info-item"><div class="info-label">检测</div><div class="info-value">${report.detected ? 'YES' : 'NO'}</div></div>
              <div class="info-item"><div class="info-label">风险</div><div class="info-value">${report.matchedRiskCount || 0}/${report.riskCount || 0}</div></div>
              <div class="info-item"><div class="info-label">最大迭代</div><div class="info-value">${report.maxIteration || '-'}</div></div>
            </div>
          `;
          if (report.error) html += `<div class="chip-box" style="color:${'var(--danger)'};">${report.error}</div>`;
          if (report.risks && report.risks.length) {
            html += `<div style="margin:10px 0 6px;font-weight:700;">风险列表 (${report.risks.length})</div>`;
            report.risks.forEach((rk, i) => {
              html += `<div class="info-item" style="border-color:${rk.matched?'rgba(34,197,94,0.4)':'var(--border)'};">
                <div class="info-label">#${i+1} ${rk.riskType || '未知'} · 严重度 ${rk.severity || '-'}</div>
                <div class="info-value" style="margin-top:4px;">${rk.title || '未命名'}</div>
                ${rk.description ? `<div style="color:var(--muted);margin-top:4px;font-size:12px;">${rk.description}</div>` : ''}
                ${rk.payload ? `<pre style="margin-top:6px;">${rk.payload}</pre>` : ''}
              </div>`;
            });
          }
          if (report.taskPrompt) html += `<div style="margin-top:10px;"><div class="info-label">任务提示</div><pre>${report.taskPrompt}</pre></div>`;
          if (report.thoughtLog && report.thoughtLog.length) html += `<div style="margin-top:10px;"><div class="info-label">思考过程</div><pre>${report.thoughtLog.join('')}</pre></div>`;
          if (report.answerLog && report.answerLog.length) html += `<div style="margin-top:10px;"><div class="info-label">回答</div><pre>${report.answerLog.join('')}</pre></div>`;
          content.innerHTML = html;
        })
        .catch(err => { content.innerHTML = `<div class="chip-box" style="color:${'var(--danger)'};">加载失败：${err.message}</div>`; });
    }

    function closeReportModal() { document.getElementById('reportModal').style.display = 'none'; }
    function handleModalBg(e) { if (e.target.id === 'reportModal') closeReportModal(); }
  </script>
</body>
</html>
