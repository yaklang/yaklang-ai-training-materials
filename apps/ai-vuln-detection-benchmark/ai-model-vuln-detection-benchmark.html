<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Model Vulnerability Detection Benchmark</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: #f5f5f5;
            color: #333333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 13px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #22c55e;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .config-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .form-textarea {
            min-height: 150px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        .form-hint {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e5e5e5;
        }

        .results-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .test-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .test-status h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .model-result {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ddd;
        }

        .model-result.success {
            border-left-color: #22c55e;
        }

        .model-result.failed {
            border-left-color: #ef4444;
        }

        .model-result h4 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .result-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .result-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .result-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .result-value.success {
            color: #22c55e;
        }

        .result-value.failed {
            color: #ef4444;
        }

        .stream-box {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .stream-box::-webkit-scrollbar {
            width: 8px;
        }

        .stream-box::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .stream-box::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collapsible-header:hover {
            color: #667eea;
        }

        .collapsible-icon {
            transition: transform 0.3s;
        }

        .collapsible-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        .summary-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-card {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .summary-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .summary-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .error-message {
            background: #fef2f2;
            color: #991b1b;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #ef4444;
            margin-top: 12px;
            font-size: 14px;
        }

        .config-example {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
        }

        .config-example h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #667eea;
        }

        .config-example pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ AI Model Vulnerability Detection Benchmark</h1>
            <p>Test and compare different AI models' capability in detecting SQL injection vulnerabilities</p>
            <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                <button class="btn btn-secondary" onclick="showTestPage()" id="btnTest">
                    <span>üß™</span>
                    <span>Live Test</span>
                </button>
                <button class="btn btn-secondary" onclick="showReportsPage()" id="btnReports">
                    <span>üìã</span>
                    <span>Reports</span>
                </button>
                <div class="status-indicator" style="margin-left: auto;">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Connecting...</span>
                </div>
            </div>
        </header>

        <!-- Configuration Display Section -->
        <div class="config-section" id="configDisplay" style="display: none;">
            <h2 class="section-title">‚öôÔ∏è Test Configuration</h2>
            <div id="configInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px; line-height: 1.8;">
                <div><strong>Target URL:</strong> <span id="displayTargetURL">-</span></div>
                <div><strong>Max Iteration:</strong> <span id="displayMaxIteration">-</span></div>
                <div><strong>Timeout:</strong> <span id="displayTimeout">-</span> seconds</div>
                <div><strong>AI Models:</strong> <span id="displayModelCount">-</span></div>
            </div>
        </div>

        <!-- Reports Page -->
        <div class="results-section" id="reportsPage" style="display: none;">
            <h2 class="section-title">üìã Test Reports</h2>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                <button class="btn btn-primary" onclick="loadReports()">
                    <span>üîÑ</span>
                    <span>Refresh</span>
                </button>
                <div style="flex: 1;"></div>
                <div style="color: #666; font-size: 14px;">
                    Total Reports: <strong id="totalReports">0</strong>
                </div>
            </div>
            
            <div id="reportsContainer">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <p>Loading reports...</p>
                </div>
            </div>
            
            <!-- Report Detail Modal -->
            <div id="reportModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
                <div style="max-width: 1200px; margin: 50px auto; background: white; border-radius: 10px; padding: 30px; position: relative;">
                    <button onclick="closeReportModal()" style="position: absolute; top: 20px; right: 20px; background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">‚úï Close</button>
                    <div id="reportDetailContent"></div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <h2 class="section-title">üìä Live Test Results</h2>
            
            <div class="test-status" id="testStatus">
                <h3>Testing in progress...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="statusMessage">Initializing tests...</div>
            </div>

            <div id="modelResults"></div>

            <div class="summary-section" id="summarySection" style="display: none;">
                <h2 style="margin-bottom: 10px;">üìà Summary</h2>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-value" id="totalTests">0</div>
                        <div class="summary-label">Total Tests</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="successTests">0</div>
                        <div class="summary-label">Successful</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="detectedTests">0</div>
                        <div class="summary-label">Detected Vulnerabilities</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="totalRisks">0</div>
                        <div class="summary-label">Total Risks Found</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let testRunning = false;
        let totalModels = 0;
        let completedModels = 0;
        let currentStreamingModel = null;
        let modelStreams = {};

        // Initialize
        function init() {
            connectWebSocket();
            // Configuration will be loaded from server automatically
        }

        // Update status indicator
        function updateStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (status === 'connected') {
                dot.classList.add('connected');
                statusText.textContent = text || 'Connected';
            } else if (status === 'disconnected') {
                dot.classList.remove('connected');
                statusText.textContent = text || 'Disconnected';
            }
        }

        // Connect WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/benchmark/test`;
            
            updateStatus('disconnected', 'Connecting...');
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('WebSocket connected');
                    updateStatus('connected', 'Connected');
                };
                
                ws.onmessage = (event) => {
                    console.log('WebSocket message:', event.data);
                    handleWebSocketMessage(event.data);
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateStatus('disconnected', 'Error');
                };
                
                ws.onclose = () => {
                    console.log('WebSocket closed');
                    updateStatus('disconnected', 'Disconnected');
                    
                    // Reconnect after 3 seconds
                    setTimeout(() => {
                        if (!testRunning) {
                            console.log('Attempting to reconnect...');
                            connectWebSocket();
                        }
                    }, 3000);
                };
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
                updateStatus('disconnected', 'Connection failed');
            }
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            try {
                const message = JSON.parse(data);
                
                if (message.type === 'connected') {
                    console.log('Connected to server');
                    
                    // Â¶ÇÊûúÊúçÂä°Âô®Êèê‰æõ‰∫ÜÈÖçÁΩÆÔºåÊòæÁ§∫ÈÖçÁΩÆ‰ø°ÊÅØÂπ∂Ëá™Âä®ÂêØÂä®ÊµãËØï
                    if (message.config) {
                        displayConfig(message.config);
                        // Ëá™Âä®ÂêØÂä®ÊµãËØï
                        autoStartTest(message.config);
                    } else {
                        document.getElementById('resultsSection').innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #ef4444;">
                                <h3>‚ö†Ô∏è No configuration loaded</h3>
                                <p style="margin-top: 10px;">Please ensure the server is started with a valid config file.</p>
                            </div>
                        `;
                    }
                } else if (message.type === 'test_started') {
                    totalModels = message.totalTests || message.totalModels || 0;
                    completedModels = 0;
                    updateProgress();
                    const aiCount = message.aiModelCount || 0;
                    const testCount = message.testScenarioCount || 1;
                    document.getElementById('statusMessage').textContent = 
                        `Starting ${aiCount} models √ó ${testCount} scenarios = ${totalModels} total tests...`;
                } else if (message.type === 'stream') {
                    handleStreamData(message);
                } else if (message.type === 'model_completed') {
                    handleModelCompleted(message.result);
                } else if (message.type === 'test_completed') {
                    handleTestCompleted(message);
                } else if (message.type === 'error') {
                    handleError(message.message);
                }
            } catch (error) {
                console.error('Failed to parse WebSocket message:', error, data);
            }
        }

        // Generate unique result ID
        let resultCounter = 0;
        function getResultId(modelName, testName) {
            return `result-${resultCounter++}`;
        }

        // Handle stream data
        function handleStreamData(message) {
            const modelName = message.model;
            const streamType = message.streamType;
            const data = message.data;
            const resultId = message.resultId || modelName; // ‰ΩøÁî® resultId Â¶ÇÊûúÊèê‰æõ
            
            if (!modelStreams[resultId]) {
                modelStreams[resultId] = {
                    thought: '',
                    answer: '',
                    modelName: modelName
                };
            }
            
            if (streamType === 'thought') {
                modelStreams[resultId].thought += data;
                updateStreamBox(resultId, 'thought', modelStreams[resultId].thought);
            } else if (streamType === 'answer') {
                modelStreams[resultId].answer += data;
                updateStreamBox(resultId, 'answer', modelStreams[resultId].answer);
            }
        }

        // Update stream box
        function updateStreamBox(resultId, type, content) {
            let resultDiv = document.getElementById(resultId);
            const modelName = modelStreams[resultId]?.modelName || resultId;
            
            if (!resultDiv) {
                const resultsContainer = document.getElementById('modelResults');
                resultDiv = document.createElement('div');
                resultDiv.id = resultId;
                resultDiv.className = 'model-result';
                resultDiv.innerHTML = `
                    <h4 id="title-${resultId}">${modelName}</h4>
                    <div class="result-item">
                        <div class="result-label">Status</div>
                        <div class="result-value">Testing...</div>
                    </div>
                    <div class="collapsible-header" onclick="toggleCollapsible('thought-${resultId}')">
                        <span class="collapsible-icon" id="icon-thought-${resultId}">‚ñº</span>
                        <strong>AI Thought Process:</strong>
                    </div>
                    <div class="collapsible-content" id="content-thought-${resultId}">
                        <div class="stream-box" id="stream-thought-${resultId}"></div>
                    </div>
                    <div class="collapsible-header" onclick="toggleCollapsible('answer-${resultId}')" style="margin-top: 12px;">
                        <span class="collapsible-icon" id="icon-answer-${resultId}">‚ñº</span>
                        <strong>AI Answer:</strong>
                    </div>
                    <div class="collapsible-content" id="content-answer-${resultId}">
                        <div class="stream-box" id="stream-answer-${resultId}"></div>
                    </div>
                `;
                resultsContainer.appendChild(resultDiv);
            }
            
            const streamBox = document.getElementById(`stream-${type}-${resultId}`);
            if (streamBox) {
                streamBox.textContent = content;
                streamBox.scrollTop = streamBox.scrollHeight;
            }
        }

        // Toggle collapsible
        function toggleCollapsible(id) {
            const content = document.getElementById(`content-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            
            if (content && icon) {
                content.classList.toggle('collapsed');
                icon.classList.toggle('collapsed');
            }
        }

        // Handle model completed
        function handleModelCompleted(result) {
            completedModels++;
            updateProgress();
            
            const resultId = result.resultId || `result-${result.model}`;
            const resultDiv = document.getElementById(resultId);
            if (resultDiv) {
                resultDiv.className = `model-result ${result.success ? 'success' : 'failed'}`;
                
                // Êõ¥Êñ∞Ê†áÈ¢òÔºåÂåÖÂê´ÊµãËØïÂú∫ÊôØ
                const titleElem = document.getElementById(`title-${resultId}`);
                if (titleElem) {
                    const title = result.testName ? 
                        `${result.model} - ${result.testName}` : 
                        result.model;
                    titleElem.textContent = title;
                }
                
                // ÊûÑÂª∫ Risk ÊòæÁ§∫ÊñáÊú¨
                const matchedCount = result.matchedRiskCount || 0;
                const totalCount = result.riskCount || 0;
                const riskDisplay = matchedCount !== undefined ? `${matchedCount}/${totalCount}` : totalCount;
                
                const gridHTML = `
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">Success</div>
                            <div class="result-value ${result.success ? 'success' : 'failed'}">
                                ${result.success ? 'YES' : 'NO'}
                            </div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Detected</div>
                            <div class="result-value ${result.detected ? 'success' : 'failed'}">
                                ${result.detected ? 'YES' : 'NO'}
                            </div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Risks (M/T)</div>
                            <div class="result-value" title="Matched: ${matchedCount}, Total: ${totalCount}">
                                ${riskDisplay}
                            </div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Duration</div>
                            <div class="result-value">${result.duration}s</div>
                        </div>
                    </div>
                    ${result.error ? `<div class="error-message">${result.error}</div>` : ''}
                `;
                
                // Insert grid before collapsible sections
                const firstCollapsible = resultDiv.querySelector('.collapsible-header');
                if (firstCollapsible) {
                    firstCollapsible.insertAdjacentHTML('beforebegin', gridHTML);
                }
            }
            
            document.getElementById('statusMessage').textContent = 
                `Completed ${completedModels}/${totalModels} tests...`;
        }

        // Handle test completed
        function handleTestCompleted(data) {
            testRunning = false;
            
            document.getElementById('testStatus').innerHTML = `
                <h3 style="color: #22c55e;">‚úì All tests completed!</h3>
            `;
            
            // Show summary
            const summary = data.summary;
            document.getElementById('summarySection').style.display = 'block';
            document.getElementById('totalTests').textContent = summary.totalTests;
            document.getElementById('successTests').textContent = 
                `${summary.successCount} (${summary.successRate ? summary.successRate.toFixed(1) : 0}%)`;
            document.getElementById('detectedTests').textContent = 
                `${summary.detectedCount} (${summary.detectionRate ? summary.detectionRate.toFixed(1) : 0}%)`;
            document.getElementById('totalRisks').textContent = summary.totalRisks;
            
            console.log('All tests completed. Summary:', summary);
        }

        // Handle error
        function handleError(message) {
            console.error('Test error:', message);
            document.getElementById('testStatus').innerHTML = `
                <h3 style="color: #ef4444;">‚ö†Ô∏è Test error</h3>
                <div style="color: #ef4444; margin-top: 10px;">${message}</div>
            `;
            testRunning = false;
        }

        // Update progress
        function updateProgress() {
            if (totalModels > 0) {
                const progress = (completedModels / totalModels) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
            }
        }

        // Display configuration
        function displayConfig(config) {
            const testConfigs = config.testConfigs || [];
            const aiConfigs = config.aiConfigs || [];
            
            // ÊòæÁ§∫Á¨¨‰∏Ä‰∏™ÊµãËØïÈÖçÁΩÆÁöÑ‰ø°ÊÅØÔºàÂ¶ÇÊûúÊúâÂ§ö‰∏™Ôºâ
            const firstTest = testConfigs[0] || {};
            const totalTests = aiConfigs.length * testConfigs.length;
            
            document.getElementById('displayTargetURL').textContent = 
                testConfigs.length > 1 ? `${testConfigs.length} scenarios` : (firstTest.targetURL || '-');
            document.getElementById('displayMaxIteration').textContent = firstTest.maxIteration || '-';
            document.getElementById('displayTimeout').textContent = firstTest.timeout || '-';
            document.getElementById('displayModelCount').textContent = 
                `${aiConfigs.length} models √ó ${testConfigs.length} scenarios = ${totalTests} tests`;
            
            document.getElementById('configDisplay').style.display = 'block';
            
            console.log('Configuration loaded:', config);
        }

        // Auto start test
        function autoStartTest(config) {
            if (testRunning) {
                console.log('Test is already running');
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.error('WebSocket is not connected');
                return;
            }
            
            const aiConfigs = config.aiConfigs || [];
            const testConfigs = config.testConfigs || [];
            
            if (aiConfigs.length === 0) {
                console.error('No AI configurations found');
                return;
            }
            
            if (testConfigs.length === 0) {
                console.error('No test configurations found');
                return;
            }
            
            // Reset results
            document.getElementById('modelResults').innerHTML = '';
            document.getElementById('summarySection').style.display = 'none';
            document.getElementById('resultsSection').classList.add('active');
            modelStreams = {};
            
            // Send test request
            const testData = {
                type: 'start_test',
                data: {
                    aiConfigs: aiConfigs,
                    testConfigs: testConfigs
                }
            };
            
            console.log('Auto-starting test with config:', testData);
            ws.send(JSON.stringify(testData));
            
            testRunning = true;
            
            document.getElementById('testStatus').innerHTML = `
                <h3>Testing in progress...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="statusMessage">Initializing tests...</div>
            `;
        }

        // Manual start test function (no longer used, test starts automatically)
        function startTest() {
            console.log('startTest called but tests are now started automatically');
        }

        // Old configuration functions removed
        // Configuration functions are no longer needed as configs are loaded from server

        // Page navigation
        function showTestPage() {
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('configDisplay').style.display = 'block';
            document.getElementById('reportsPage').style.display = 'none';
            document.getElementById('btnTest').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            document.getElementById('btnReports').style.background = '#6b7280';
        }

        function showReportsPage() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('configDisplay').style.display = 'none';
            document.getElementById('reportsPage').style.display = 'block';
            document.getElementById('btnTest').style.background = '#6b7280';
            document.getElementById('btnReports').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            loadReports();
        }

        // Load reports list
        function loadReports() {
            const container = document.getElementById('reportsContainer');
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><p>Loading reports...</p></div>';

            fetch('/api/reports')
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 40px; color: #ef4444;"><p>${data.message}</p></div>`;
                        return;
                    }

                    document.getElementById('totalReports').textContent = data.count;

                    if (data.reports.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><p>No reports found</p></div>';
                        return;
                    }

                    // Build reports table
                    let html = `
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Time</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Test Name</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Model</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;">Success</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;">Detected</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;">Risks</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;">Duration</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.reports.forEach(report => {
                        const successBadge = report.success ? 
                            '<span style="background: #22c55e; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">YES</span>' :
                            '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">NO</span>';
                        
                        const detectedBadge = report.detected ? 
                            '<span style="background: #22c55e; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">YES</span>' :
                            '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">NO</span>';

                        html += `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 12px;">${report.timestamp || '-'}</td>
                                <td style="padding: 12px;">${report.testName || '-'}</td>
                                <td style="padding: 12px;">${report.model || '-'} <span style="color: #999; font-size: 12px;">(${report.provider || '-'})</span></td>
                                <td style="padding: 12px; text-align: center;">${successBadge}</td>
                                <td style="padding: 12px; text-align: center;">${detectedBadge}</td>
                                <td style="padding: 12px; text-align: center;">${report.matchedRiskCount || 0}/${report.riskCount || 0}</td>
                                <td style="padding: 12px; text-align: center;">${report.duration || 0}s</td>
                                <td style="padding: 12px; text-align: center;">
                                    <button onclick="viewReport('${report.filename}')" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">View</button>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Failed to load reports:', error);
                    container.innerHTML = `<div style="text-align: center; padding: 40px; color: #ef4444;"><p>Failed to load reports: ${error.message}</p></div>`;
                });
        }

        // View report detail
        function viewReport(filename) {
            const modal = document.getElementById('reportModal');
            const content = document.getElementById('reportDetailContent');
            
            content.innerHTML = '<div style="text-align: center; padding: 40px;"><p>Loading report...</p></div>';
            modal.style.display = 'block';

            fetch(`/api/report?filename=${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        content.innerHTML = `<div style="color: #ef4444;"><p>Error: ${data.message}</p></div>`;
                        return;
                    }

                    const report = data.report;
                    
                    let html = `
                        <h2 style="margin-bottom: 20px; color: #667eea;">üìÑ Report Detail</h2>
                        
                        <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">Basic Information</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div><strong>Test Name:</strong> ${report.testName || '-'}</div>
                                <div><strong>Timestamp:</strong> ${report.timestamp || '-'}</div>
                                <div><strong>Model:</strong> ${report.model || '-'}</div>
                                <div><strong>Provider:</strong> ${report.provider || '-'}</div>
                                <div><strong>Target URL:</strong> ${report.targetURL || '-'}</div>
                                <div><strong>Duration:</strong> ${report.duration || 0} seconds</div>
                                <div><strong>Success:</strong> ${report.success ? '‚úÖ YES' : '‚ùå NO'}</div>
                                <div><strong>Detected:</strong> ${report.detected ? '‚úÖ YES' : '‚ùå NO'}</div>
                                <div><strong>Risk Count:</strong> ${report.matchedRiskCount || 0}/${report.riskCount || 0}</div>
                                <div><strong>Max Iteration:</strong> ${report.maxIteration || '-'}</div>
                            </div>
                        </div>
                    `;

                    if (report.error) {
                        html += `
                            <div style="background: #fee2e2; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ef4444;">
                                <h3 style="color: #ef4444; margin-bottom: 10px;">Error</h3>
                                <pre style="white-space: pre-wrap; word-wrap: break-word;">${report.error}</pre>
                            </div>
                        `;
                    }

                    if (report.risks && report.risks.length > 0) {
                        html += `
                            <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h3 style="margin-bottom: 15px;">Risks Found (${report.risks.length})</h3>
                        `;
                        
                        report.risks.forEach((risk, index) => {
                            const matchedBadge = risk.matched ? 
                                '<span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 10px;">MATCHED</span>' : 
                                '<span style="background: #999; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 10px;">NOT MATCHED</span>';
                            
                            html += `
                                <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid ${risk.matched ? '#22c55e' : '#999'};">
                                    <h4 style="margin-bottom: 10px;">${index + 1}. ${risk.title || 'Unknown'} ${matchedBadge}</h4>
                                    <div style="font-size: 13px; color: #666; line-height: 1.6;">
                                        <div><strong>Type:</strong> ${risk.riskType || '-'}</div>
                                        <div><strong>Severity:</strong> <span style="color: ${risk.severity === 'high' || risk.severity === 'critical' ? '#ef4444' : '#f59e0b'};">${risk.severity || '-'}</span></div>
                                        <div><strong>URL:</strong> ${risk.url || '-'}</div>
                                        ${risk.description ? `<div style="margin-top: 8px;"><strong>Description:</strong><br>${risk.description}</div>` : ''}
                                        ${risk.payload ? `<div style="margin-top: 8px;"><strong>Payload:</strong><br><code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; display: block; margin-top: 4px;">${risk.payload}</code></div>` : ''}
                                        ${risk.matchedKeywords ? `<div style="margin-top: 8px;"><strong>Matched Keywords:</strong> ${risk.matchedKeywords.join(', ')}</div>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                    }

                    if (report.taskPrompt) {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 10px;">Task Prompt</h3>
                                <pre style="background: #f3f4f6; padding: 15px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; max-height: 300px; overflow-y: auto;">${report.taskPrompt}</pre>
                            </div>
                        `;
                    }

                    if (report.thoughtLog && report.thoughtLog.length > 0) {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 10px;">AI Thought Process</h3>
                                <pre style="background: #f3f4f6; padding: 15px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; max-height: 300px; overflow-y: auto;">${report.thoughtLog.join('')}</pre>
                            </div>
                        `;
                    }

                    if (report.answerLog && report.answerLog.length > 0) {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 10px;">AI Answer</h3>
                                <pre style="background: #f3f4f6; padding: 15px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; max-height: 300px; overflow-y: auto;">${report.answerLog.join('')}</pre>
                            </div>
                        `;
                    }

                    content.innerHTML = html;
                })
                .catch(error => {
                    console.error('Failed to load report:', error);
                    content.innerHTML = `<div style="color: #ef4444;"><p>Failed to load report: ${error.message}</p></div>`;
                });
        }

        // Close report modal
        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            init();
            showTestPage(); // Default to test page
        });

        // Close WebSocket on page unload
        window.addEventListener('beforeunload', () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
        });
    </script>
</body>
</html>

