<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Benchmark 报告总览</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1224;
      --card: #11182c;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --primary: #5b8def;
      --primary-strong: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --border: #1f2937;
      --chip: #1c2438;
      --table-header: #0f172a;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter','Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(91,141,239,0.12), transparent 35%), radial-gradient(circle at 80% 0%, rgba(34,197,94,0.12), transparent 30%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
      padding: 28px 0 56px;
    }

    .container {
      width: min(1400px, 96%);
      margin: 0 auto;
    }

    .surface {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.22);
      padding: 20px 20px 18px;
      margin-bottom: 18px;
    }

    .section-head {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }
    .section-title { font-size: 18px; font-weight: 600; }
    .section-desc { color: var(--muted); font-size: 13px; margin-bottom: 14px; }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    .status-card {
      background: var(--chip);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 12px 10px;
    }
    .status-label { color: var(--muted); font-size: 12px; }
    .status-value { font-size: 16px; font-weight: 600; margin-top: 4px; }
    .status-ok { color: var(--success); }
    .status-bad { color: var(--danger); }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }
    .spacer { flex: 1; }

    button {
      border: none;
      cursor: pointer;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-strong) 100%);
      color: #0b1224;
      padding: 10px 16px;
      box-shadow: 0 14px 30px rgba(91,141,239,0.25);
    }
    .btn-primary:hover { transform: translateY(-1px); }

    .counter { color: var(--muted); font-size: 14px; }

    .report-list { display: flex; flex-direction: column; gap: 12px; }
    .report-card {
      background: var(--chip);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .report-header {
      padding: 14px 16px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      cursor: pointer;
      transition: background 0.18s ease;
    }
    .report-header:hover { background: rgba(91,141,239,0.07); }
    .report-meta { display: flex; gap: 14px; flex-wrap: wrap; color: var(--muted); font-size: 13px; }
    .badge {
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid rgba(226,232,240,0.2);
      background: rgba(226,232,240,0.06);
      color: var(--text);
    }
    .expand { color: var(--muted); font-size: 12px; }

    .report-body { border-top: 1px solid var(--border); display: none; padding: 14px 16px 18px; background: var(--card); }

    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--border);
      background: var(--table-header);
      border-radius: 10px;
      overflow: hidden;
    }
    thead { background: #0b1326; }
    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      font-size: 13px;
    }
    th { text-align: left; font-weight: 600; }
    tbody tr:hover { background: rgba(91,141,239,0.05); }
    .sticky {
      position: sticky;
      left: 0;
      background: #0b1326;
      z-index: 2;
      box-shadow: 1px 0 0 var(--border);
    }
    .cell {
      text-align: center;
      cursor: pointer;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px;
      border: 1px solid transparent;
    }
    .pill-pass { background: rgba(34,197,94,0.16); color: #4ade80; border-color: rgba(34,197,94,0.25); }
    .pill-fail { background: rgba(239,68,68,0.16); color: #fca5a5; border-color: rgba(239,68,68,0.25); }
    .pill-detect { background: rgba(91,141,239,0.18); color: #93c5fd; border-color: rgba(91,141,239,0.35); }

    .meta-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .chip {
      padding: 4px 8px;
      border-radius: 8px;
      background: rgba(226,232,240,0.06);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
    }

    .legend {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 12px;
    }

    .loading, .error { text-align: center; padding: 32px; color: var(--muted); }
    .error { color: #f87171; }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 20px;
    }
    .modal-content {
      width: min(1100px, 96vw);
      background: #0f172a;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px 22px 24px;
      box-shadow: 0 30px 90px rgba(0,0,0,0.5);
      position: relative;
      max-height: 90vh;
      overflow: auto;
    }
    .modal-close {
      position: absolute;
      right: 14px;
      top: 12px;
      background: rgba(239,68,68,0.16);
      color: #fecdd3;
      border: 1px solid rgba(239,68,68,0.35);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 10px 0 14px;
    }
    .info-item { background: rgba(226,232,240,0.04); padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); }
    .info-label { color: var(--muted); font-size: 12px; }
    .info-value { font-weight: 600; margin-top: 2px; }
    pre {
      background: #0b1326;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      color: #cbd5e1;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'Fira Code', 'Inter', monospace;
      font-size: 12px;
      max-height: 420px;
      overflow: auto;
    }

    @media (max-width: 760px) {
      header h1 { font-size: 22px; }
      .report-header { grid-template-columns: 1fr; row-gap: 10px; }
      th, td { font-size: 12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <section class="surface">
      <div class="section-head">
        <span class="section-title">系统状态</span>
      </div>
      <div id="systemStatus">
        <div class="loading">正在读取状态...</div>
      </div>
    </section>

    <section class="surface">
      <div class="section-head">
        <span class="section-title">测试报告</span>
      </div>
      <div class="toolbar">
        <button class="btn-primary" onclick="refreshAll()">刷新全部</button>
        <div class="spacer"></div>
        <div class="counter">报告数量：<strong id="totalReports">0</strong></div>
      </div>
      <div id="reportsContainer">
        <div class="loading">正在加载报告...</div>
      </div>
    </section>
  </div>

  <div id="reportModal" class="modal" onclick="handleModalBg(event)">
    <div class="modal-content">
      <button class="modal-close" onclick="closeReportModal()">关闭</button>
      <div id="reportDetailContent"></div>
    </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      loadSystemStatus();
      loadReports();
    });

    function loadSystemStatus() {
      const box = document.getElementById('systemStatus');
      fetch('/api/status')
        .then(r => r.json())
        .then(data => {
          if (!data.success) {
            box.innerHTML = '<div class="error">状态读取失败</div>';
            return;
          }
          const s = data.status;
          box.innerHTML = `
            <div class="status-grid">
              <div class="status-card">
                <div class="status-label">引擎版本</div>
                <div class="status-value">${s.current_version || '-'}</div>
              </div>
              <div class="status-card">
                <div class="status-label">最后检查时间</div>
                <div class="status-value">${s.last_check_time || '-'}</div>
              </div>
              <div class="status-card">
                <div class="status-label">最后运行时间</div>
                <div class="status-value">${s.last_run_time || '-'}</div>
              </div>
              <div class="status-card">
                <div class="status-label">最后运行结果</div>
                <div class="status-value ${s.last_run_success === 'true' ? 'status-ok' : 'status-bad'}">
                  ${s.last_run_success === 'true' ? '成功' : '失败'}
                </div>
              </div>
              <div class="status-card">
                <div class="status-label">累计运行次数</div>
                <div class="status-value">${s.total_runs || 0}</div>
              </div>
              ${s.last_run_error ? `
                <div class="status-card" style="grid-column: 1 / -1;">
                  <div class="status-label">最后错误</div>
                  <div class="status-value status-bad" style="font-size:14px;">${s.last_run_error}</div>
                </div>` : ''}
            </div>
          `;
        })
        .catch(err => {
          console.error(err);
          box.innerHTML = `<div class="error">错误：${err.message}</div>`;
        });
    }

    function loadReports() {
      const box = document.getElementById('reportsContainer');
      box.innerHTML = '<div class="loading">正在加载报告...</div>';
      fetch('/api/reports')
        .then(r => r.json())
        .then(data => {
          if (!data.success) {
            box.innerHTML = `<div class="error">${data.message}</div>`;
            return;
          }
          document.getElementById('totalReports').textContent = data.count;
          if (!data.reports.length) {
            box.innerHTML = '<div class="loading">暂无报告</div>';
            return;
          }
          let html = '<div class="report-list">';
          data.reports.forEach((report, idx) => {
            const summary = report.summary || {};
            const successRate = summary.successRate ? summary.successRate.toFixed(1) : '0';
            const detectionRate = summary.detectionRate ? summary.detectionRate.toFixed(1) : '0';
            const isBatch = report.reportType === 'batch';
            html += `
              <div class="report-card">
                <div class="report-header" onclick="toggleReport(${idx}, '${report.filename}')">
                  <div>
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
                      <span style="font-size:16px;font-weight:700;">${report.timestamp || '-'}</span>
                      <span class="badge" style="border-color:rgba(59,130,246,0.35);color:#bfdbfe;">${isBatch ? '批量报告' : '单报告'}</span>
                    </div>
                    <div class="report-meta">
                      ${isBatch ? `
                        <span>用例：${summary.totalTests || 0}</span>
                        <span>成功：${summary.successCount || 0} (${successRate}%)</span>
                        <span>检测：${summary.detectedCount || 0} (${detectionRate}%)</span>
                        <span>耗时：${summary.totalDuration || 0}s</span>
                      ` : `
                        <span>模型：${report.model || '-'}</span>
                        <span>用例：${report.testName || '-'}</span>
                        <span>结果：${report.success ? '成功' : '失败'}</span>
                      `}
                      <span>引擎：${report.yakEngineVersion || 'N/A'}</span>
                    </div>
                  </div>
                  <div style="display:flex;align-items:center;gap:10px;">
                    <button class="btn-primary" style="padding:8px 12px;font-size:12px;" onclick="event.stopPropagation();showRawJson('${report.filename}')">查看 JSON</button>
                    <span class="expand" id="expand-${idx}">展开</span>
                  </div>
                </div>
                <div class="report-body" id="report-body-${idx}">
                  <div class="loading">点击展开加载矩阵...</div>
                </div>
              </div>
            `;
          });
          html += '</div>';
          box.innerHTML = html;
        })
        .catch(err => {
          console.error(err);
          box.innerHTML = `<div class="error">加载失败：${err.message}</div>`;
        });
    }

    const cache = {};

    function toggleReport(idx, filename) {
      const body = document.getElementById(`report-body-${idx}`);
      const expand = document.getElementById(`expand-${idx}`);
      const visible = body.style.display === 'block';
      body.style.display = visible ? 'none' : 'block';
      expand.textContent = visible ? '展开' : '收起';
      if (!visible && !cache[filename]) {
        loadReportDetail(body, filename);
      }
    }

    function loadReportDetail(container, filename) {
      container.innerHTML = '<div class="loading">加载详情...</div>';
      fetch(`/api/report?filename=${encodeURIComponent(filename)}`)
        .then(r => r.json())
        .then(data => {
          if (!data.success) {
            container.innerHTML = `<div class="error">${data.message}</div>`;
            return;
          }
          const report = data.report;
          cache[filename] = report;
          if (report.reportType === 'batch') {
            renderMatrix(container, report);
          } else {
            renderSingle(container, report);
          }
        })
        .catch(err => {
          console.error(err);
          container.innerHTML = `<div class="error">加载失败：${err.message}</div>`;
        });
    }

    function renderMatrix(container, report) {
      const results = report.results || [];
      const testNames = report.testNames || [];
      const models = report.models || [];
      if (!results.length) {
        container.innerHTML = '<div class="loading">无测试结果</div>';
        return;
      }
      const map = {};
      results.forEach(r => { map[`${r.testName}|${r.model}`] = r; });

      let html = `
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th class="sticky" style="min-width:190px;">测试用例</th>
      `;
      models.forEach(m => {
        html += `<th style="text-align:center;min-width:180px;">${m.model}<br><span style="color:${'var(--muted)'};font-weight:500;">${m.provider}</span></th>`;
      });
      html += `</tr></thead><tbody>`;

      testNames.forEach(test => {
        html += `<tr><td class="sticky" style="font-weight:700;">${test}</td>`;
        models.forEach(m => {
          const key = `${test}|${m.model}`;
          const r = map[key];
          if (!r) { html += `<td class="cell" style="color:var(--muted);">-</td>`; return; }
          const id = `${test}-${m.model}`.replace(/[^a-zA-Z0-9]/g,'_');
          const statusClass = r.detected ? 'pill-detect' : (r.success ? 'pill-pass' : 'pill-fail');
          const statusLabel = r.detected ? '已检测' : (r.success ? '通过' : '失败');
          const duration = typeof r.duration === 'number' ? r.duration : (r.duration || 0);
          const iter = r.maxIteration || r.iteration || r.iterationCount || '-';
          html += `
            <td class="cell" onclick="showResultDetail('${id}')" title="查看详情">
              <div class="pill ${statusClass}">${statusLabel}</div>
              <div class="meta-row">
                <span class="chip">时长 ${duration}s</span>
                <span class="chip">迭代 ${iter}</span>
              </div>
            </td>
          `;
          window.resultCache = window.resultCache || {};
          window.resultCache[id] = r;
        });
        html += `</tr>`;
      });

      html += `</tbody></table></div>`;
      container.innerHTML = html;
    }

    function renderSingle(container, r) {
      container.innerHTML = `
        <div class="info-grid">
          <div class="info-item"><div class="info-label">测试用例</div><div class="info-value">${r.testName || '-'}</div></div>
          <div class="info-item"><div class="info-label">模型</div><div class="info-value">${r.model || '-'}</div></div>
          <div class="info-item"><div class="info-label">提供方</div><div class="info-value">${r.provider || '-'}</div></div>
          <div class="info-item"><div class="info-label">目标地址</div><div class="info-value">${r.targetURL || '-'}</div></div>
          <div class="info-item"><div class="info-label">时长</div><div class="info-value">${r.duration || 0}s</div></div>
          <div class="info-item"><div class="info-label">结果</div><div class="info-value">${r.success ? '成功' : '失败'}</div></div>
          <div class="info-item"><div class="info-label">是否检测</div><div class="info-value">${r.detected ? '是' : '否'}</div></div>
          <div class="info-item"><div class="info-label">风险匹配</div><div class="info-value">${r.matchedRiskCount || 0}/${r.riskCount || 0}</div></div>
        </div>
        ${r.error ? `<div class="error" style="text-align:left;">${r.error}</div>` : ''}
      `;
    }

    function showResultDetail(id) {
      const r = window.resultCache && window.resultCache[id];
      if (!r) { alert('未找到结果'); return; }
      const modal = document.getElementById('reportModal');
      const box = document.getElementById('reportDetailContent');
      box.innerHTML = `
        <h3 style="margin-bottom:10px;font-size:18px;">结果详情</h3>
        <div class="info-grid">
          <div class="info-item"><div class="info-label">测试用例</div><div class="info-value">${r.testName || '-'}</div></div>
          <div class="info-item"><div class="info-label">时间戳</div><div class="info-value">${r.timestamp || '-'}</div></div>
          <div class="info-item"><div class="info-label">模型</div><div class="info-value">${r.model || '-'}</div></div>
          <div class="info-item"><div class="info-label">提供方</div><div class="info-value">${r.provider || '-'}</div></div>
          <div class="info-item"><div class="info-label">目标</div><div class="info-value">${r.targetURL || '-'}</div></div>
          <div class="info-item"><div class="info-label">时长</div><div class="info-value">${r.duration || 0}s</div></div>
          <div class="info-item"><div class="info-label">结果</div><div class="info-value">${r.success ? '成功' : '失败'}</div></div>
          <div class="info-item"><div class="info-label">检测</div><div class="info-value">${r.detected ? '是' : '否'}</div></div>
          <div class="info-item"><div class="info-label">最大迭代</div><div class="info-value">${r.maxIteration || '-'}</div></div>
          <div class="info-item"><div class="info-label">风险匹配</div><div class="info-value">${r.matchedRiskCount || 0}/${r.riskCount || 0}</div></div>
        </div>
        ${r.error ? `<div class="error" style="text-align:left;">${r.error}</div>` : ''}
        ${r.risks && r.risks.length ? `
          <h4 style="margin:10px 0 6px;">发现的风险（${r.risks.length}）</h4>
          ${r.risks.map((rk, i) => `
            <div class="info-item" style="border-color:${rk.matched ? 'rgba(34,197,94,0.4)' : 'var(--border)'};">
              <div class="info-label">#${i+1} ${rk.riskType || '未知'} · 严重度 ${rk.severity || '-'}</div>
              <div class="info-value" style="margin-top:6px;">${rk.title || '未命名'}</div>
              ${rk.description ? `<div style="color:var(--muted);margin-top:4px;font-size:12px;">${rk.description}</div>` : ''}
              ${rk.payload ? `<pre style="margin-top:6px;">${rk.payload}</pre>` : ''}
            </div>
          `).join('')}
        ` : ''}
        ${r.taskPrompt ? `<h4 style="margin:12px 0 6px;">任务提示</h4><pre>${r.taskPrompt}</pre>` : ''}
        ${r.thoughtLog && r.thoughtLog.length ? `<h4 style="margin:12px 0 6px;">思考过程</h4><pre>${r.thoughtLog.join('')}</pre>` : ''}
        ${r.answerLog && r.answerLog.length ? `<h4 style="margin:12px 0 6px;">回答</h4><pre>${r.answerLog.join('')}</pre>` : ''}
      `;
      modal.style.display = 'flex';
    }

    function showRawJson(filename) {
      const modal = document.getElementById('reportModal');
      const box = document.getElementById('reportDetailContent');
      box.innerHTML = '<div class="loading">加载 JSON...</div>';
      modal.style.display = 'flex';
      fetch(`/api/report?filename=${encodeURIComponent(filename)}`)
        .then(r => r.json())
        .then(data => {
          if (!data.success) { box.innerHTML = `<div class="error">${data.message}</div>`; return; }
          const jsonStr = JSON.stringify(data.report, null, 2);
          box.innerHTML = `
            <h3 style="margin-bottom:10px;font-size:18px;">原始 JSON</h3>
            <button class="btn-primary" style="padding:8px 12px;font-size:12px;margin-bottom:10px;" onclick="copyToClipboard('${encodeURIComponent(jsonStr)}')">复制 JSON</button>
            <pre>${escapeHtml(jsonStr)}</pre>
          `;
        })
        .catch(err => { box.innerHTML = `<div class="error">加载失败：${err.message}</div>`; });
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function copyToClipboard(enc) {
      const text = decodeURIComponent(enc);
      navigator.clipboard.writeText(text).then(() => alert('已复制'));
    }

    function closeReportModal() { document.getElementById('reportModal').style.display = 'none'; }
    function handleModalBg(e) { if (e.target.id === 'reportModal') closeReportModal(); }
    function refreshAll() { loadSystemStatus(); loadReports(); }
  </script>
</body>
</html>
